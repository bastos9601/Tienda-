{% extends "base.html" %}

{% block title %}Administración - Mi Tienda Online{% endblock %}

{% block content %}
<!-- Header responsivo -->
<!-- Header moderno del admin -->
<div class="admin-header">
    <h1>
        <i class="fas fa-cogs"></i> 
        <span class="d-none d-sm-inline">Panel de Administración</span>
        <span class="d-inline d-sm-none">Admin</span>
    </h1>
    <p>Gestiona tu tienda online de forma eficiente y moderna</p>
</div>

<!-- Navegación moderna -->
<div class="admin-nav">
    <ul class="nav nav-pills justify-content-center" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button" role="tab">
                <i class="fas fa-box"></i> 
                <span class="d-none d-sm-inline ms-1">Productos</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos" type="button" role="tab">
                <i class="fas fa-shopping-cart"></i> 
                <span class="d-none d-sm-inline ms-1">Pedidos</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categorias-tab" data-bs-toggle="tab" data-bs-target="#categorias" type="button" role="tab">
                <i class="fas fa-tags"></i> 
                <span class="d-none d-sm-inline ms-1">Categorías</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="configuracion-tab" data-bs-toggle="tab" data-bs-target="#configuracion" type="button" role="tab">
                <i class="fas fa-cog"></i> 
                <span class="d-none d-sm-inline ms-1">Configuración</span>
            </button>
        </li>
    </ul>
</div>
    </div>
</div>

<!-- Barra de notificaciones y controles responsiva -->
<div class="row mb-3">
    <div class="col-12">
        <!-- Notificaciones de pedidos -->
        <div class="notifications-container mb-3">
            <div class="alert alert-warning d-none" id="pedidosAlert" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bell me-2"></i>
                    <div class="flex-grow-1">
                        <strong id="pedidosCount">0</strong> pedidos pendientes
                        <small class="d-block text-muted" id="ultimoPedidoInfo"></small>
                    </div>
                    <button type="button" class="btn-close" onclick="ocultarNotificacion()"></button>
                </div>
            </div>
        </div>
        
        <!-- Controles del panel responsivos -->
        <div class="row g-2">
            <!-- Controles principales -->
            <div class="col-12 col-sm-6 col-md-8">
                <div class="d-flex flex-wrap gap-2">
                    <!-- Botón de pedidos (solo en escritorio) -->
                    <div class="position-relative d-none d-md-block">
                        <button class="btn btn-outline-primary" id="pedidos-tab-btn" onclick="cambiarTab('pedidos')" title="Ver pedidos">
                            <i class="fas fa-shopping-cart"></i> <span class="d-none d-lg-inline">Pedidos</span>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="pedidosBadge">
                                0
                            </span>
                        </button>
                    </div>
                    
                    <!-- Botón de actualizar -->
                    <button class="btn btn-outline-primary" id="actualizarPanelBtn" title="Actualizar panel del administrador">
                        <i class="fas fa-sync-alt"></i> <span class="d-none d-sm-inline">Actualizar</span>
                    </button>
                </div>
            </div>
            
            <!-- Controles de notificaciones -->
            <div class="col-12 col-sm-6 col-md-4">
                <div class="d-flex flex-wrap gap-2 justify-content-sm-end">
                    <!-- Botón de notificaciones -->
                    <button class="btn btn-outline-info" id="toggleNotificationsBtn" title="Activar/Desactivar notificaciones">
                        <i class="fas fa-bell" id="notificationIcon"></i>
                        <span class="d-none d-sm-inline ms-1">Notif.</span>
                    </button>
                    
                    <!-- Botón para configurar notificaciones del navegador -->
                    <button class="btn btn-outline-success" id="configNotificationsBtn" title="Configurar notificaciones del navegador">
                        <i class="fas fa-cog" id="configIcon"></i>
                        <span class="d-none d-sm-inline ms-1">Config.</span>
                    </button>
                    
                    <!-- Botón para probar sonido -->
                    <button class="btn btn-outline-success" id="testSoundBtn" title="Probar sonido de notificación">
                        <i class="fas fa-volume-up"></i>
                        <span class="d-none d-sm-inline ms-1">Sonido</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="adminTabsContent">
    <!-- Tab de Productos -->
    <div class="tab-pane fade show active" id="productos" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <!-- Header responsivo -->
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3">
                    <h3 class="mb-2 mb-sm-0">
                        <i class="fas fa-box"></i> 
                        <span class="d-none d-sm-inline">Gestión de Productos</span>
                        <span class="d-inline d-sm-none">Productos</span>
                    </h3>
                    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-sm-auto">
                        <button class="btn btn-success" onclick="exportarProductos()">
                            <i class="fas fa-download"></i> 
                            <span class="d-none d-sm-inline">Exportar</span>
                        </button>
                        <button class="btn btn-info" onclick="document.getElementById('importarArchivo').click()">
                            <i class="fas fa-upload"></i> 
                            <span class="d-none d-sm-inline">Importar</span>
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productoModal">
                            <i class="fas fa-plus"></i> 
                            <span class="d-none d-sm-inline">Nuevo Producto</span>
                            <span class="d-inline d-sm-none">Nuevo</span>
                        </button>
                    </div>
                </div>
                
                <!-- Input oculto para importar archivos -->
                <input type="file" id="importarArchivo" accept=".txt" style="display: none;" onchange="importarProductos(this)">
                
                <!-- Grid responsivo de productos -->
                <div class="row g-3">
                    {% for producto in productos %}
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                        <div class="card product-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate" title="{{ producto.nombre }}">
                                    <i class="fas fa-box text-primary"></i> 
                                    <span class="d-none d-sm-inline">{{ producto.nombre }}</span>
                                    <span class="d-inline d-sm-none">{{ producto.nombre[:15] }}{% if producto.nombre|length > 15 %}...{% endif %}</span>
                                </h6>
                                <span class="badge bg-secondary">#{{ producto.id }}</span>
                            </div>
                            <div class="card-body">
                                <!-- Información del producto -->
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Precio</small>
                                        <div class="fw-bold text-success">S/{{ "%.2f"|format(producto.precio) }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Stock</small>
                                        <div class="fw-bold text-info">{{ producto.stock }}</div>
                                    </div>
                                </div>
                                
                                {% if producto.descripcion %}
                                <div class="mb-3">
                                    <small class="text-muted d-block">Descripción</small>
                                    <div class="small text-truncate" title="{{ producto.descripcion }}">
                                        {{ producto.descripcion[:40] }}{% if producto.descripcion|length > 40 %}...{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Estado y controles -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        {% if producto.activo %}
                                        <span class="badge bg-success" id="status-{{ producto.id }}">Activo</span>
                                        {% else %}
                                        <span class="badge bg-secondary" id="status-{{ producto.id }}">Inactivo</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if producto.activo %}
                                        <button class="btn btn-sm btn-outline-warning" onclick="toggleProductStatus({{ producto.id }}, false)" title="Desactivar producto">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-success" onclick="toggleProductStatus({{ producto.id }}, true)" title="Activar producto">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light p-2">
                                <!-- Botones de acción responsivos -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editarProducto({{ producto.id }}, '{{ producto.nombre|replace("'", "\\") }}', '{{ producto.descripcion|replace("'", "\\") if producto.descripcion else "" }}', {{ producto.precio }}, {{ producto.stock }}, '{{ producto.imagen if producto.imagen else "" }}', {{ producto.activo|lower }}, {{ producto.categoria_id if producto.categoria_id else 'null' }})" title="Editar producto">
                                        <i class="fas fa-edit"></i> 
                                        <span class="d-none d-sm-inline ms-1">Editar</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" onclick="eliminarProducto({{ producto.id }})" title="Eliminar producto">
                                        <i class="fas fa-trash"></i> 
                                        <span class="d-none d-sm-inline ms-1">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab de Pedidos -->
    <div class="tab-pane fade" id="pedidos" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <h3>
                    <i class="fas fa-shopping-cart"></i> 
                    <span class="d-none d-sm-inline">Gestión de Pedidos</span>
                    <span class="d-inline d-sm-none">Pedidos</span>
                </h3>
                
                <!-- Grid responsivo de pedidos -->
                <div class="row g-3">
                    {% for pedido in pedidos %}
                    <div class="col-12 col-lg-6 col-xl-4">
                        <div class="card h-100 shadow-sm" data-pedido-id="{{ pedido.id }}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-shopping-cart text-primary"></i> 
                                    <span class="d-none d-sm-inline">Pedido #{{ pedido.id }}</span>
                                    <span class="d-inline d-sm-none">#{{ pedido.id }}</span>
                                </h6>
                                <small class="text-muted">{{ pedido.fecha_pedido.strftime('%d/%m/%Y') }}</small>
                            </div>
                            <div class="card-body">
                                <!-- Información del cliente -->
                                <div class="mb-3">
                                    <small class="text-muted d-block">Cliente</small>
                                    <div class="fw-bold text-truncate" title="{{ pedido.cliente_nombre }}">{{ pedido.cliente_nombre }}</div>
                                </div>
                                
                                <!-- Teléfono y Total -->
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Teléfono</small>
                                        <div class="small">{{ pedido.cliente_telefono }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Total</small>
                                        <div class="fw-bold text-success">S/{{ "%.2f"|format(pedido.total) }}</div>
                                    </div>
                                </div>
                                
                                <!-- Dirección -->
                                {% if pedido.cliente_direccion %}
                                <div class="mb-3">
                                    <small class="text-muted d-block">Dirección</small>
                                    <div class="small text-truncate" title="{{ pedido.cliente_direccion }}">
                                        {{ pedido.cliente_direccion[:35] }}{% if pedido.cliente_direccion|length > 35 %}...{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Estado -->
                                <div class="mb-3">
                                    <small class="text-muted d-block">Estado</small>
                                    <select class="form-select form-select-sm" onchange="actualizarEstado({{ pedido.id }}, this.value)">
                                        <option value="pendiente" {% if pedido.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="confirmado" {% if pedido.estado == 'confirmado' %}selected{% endif %}>Confirmado</option>
                                        <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                                    </select>
                                </div>
                                
                                <!-- Hora y badge de estado -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> {{ pedido.fecha_pedido.strftime('%I:%M %p') }}
                                    </small>
                                    <div>
                                        {% if pedido.estado == 'pendiente' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                        {% elif pedido.estado == 'confirmado' %}
                                        <span class="badge bg-info">Confirmado</span>
                                        {% elif pedido.estado == 'entregado' %}
                                        <span class="badge bg-success">Entregado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light p-2">
                                <!-- Botones de acción responsivos -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-sm btn-outline-info flex-fill" onclick="verDetallePedido({{ pedido.id }}, '{{ pedido.cliente_nombre|replace("'", "\\") }}', '{{ pedido.cliente_telefono|replace("'", "\\") }}', '{{ pedido.cliente_direccion|replace("'", "\\") }}', {{ pedido.total }}, '{{ pedido.estado }}', '{{ pedido.fecha_pedido.strftime('%d/%m/%Y %I:%M %p') }}', '{{ pedido.cliente_comentarios|replace("'", "\\") if pedido.cliente_comentarios else "" }}')" title="Ver detalles del pedido">
                                        <i class="fas fa-eye"></i> 
                                        <span class="d-none d-sm-inline ms-1">Ver</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" onclick="eliminarPedido({{ pedido.id }}, '{{ pedido.cliente_nombre|replace("'", "\\") }}')" title="Eliminar pedido">
                                        <i class="fas fa-trash"></i> 
                                        <span class="d-none d-sm-inline ms-1">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab de Categorías -->
    <div class="tab-pane fade" id="categorias" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <!-- Header responsivo -->
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4">
                    <h3 class="mb-2 mb-sm-0">
                        <i class="fas fa-tags"></i> 
                        <span class="d-none d-sm-inline">Gestión de Categorías</span>
                        <span class="d-inline d-sm-none">Categorías</span>
                    </h3>
                    <button class="btn btn-primary w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#categoriaModal" onclick="nuevaCategoria()">
                        <i class="fas fa-plus"></i> 
                        <span class="d-none d-sm-inline">Nueva Categoría</span>
                        <span class="d-inline d-sm-none">Nueva</span>
                    </button>
                </div>
                
                <!-- Lista de Categorías -->
                <div class="row" id="categorias-container">
                    <!-- Debug: Mostrar información de categorías -->
                    <div class="col-12 mb-3">
                        <div class="alert alert-info">
                            <strong>Debug:</strong> Total de categorías: {{ categorias|length }}
                            {% if categorias %}
                                <br>Categorías encontradas: 
                                {% for cat in categorias %}
                                    {{ cat.nombre }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                <br>No hay categorías en la base de datos
                            {% endif %}
                        </div>
                    </div>
                    
                    {% for categoria in categorias %}
                    <div class="col-12 col-sm-6 col-lg-4 mb-4">
                        <div class="card product-card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: {{ categoria.color }}20; border-left: 4px solid {{ categoria.color }};">
                                <h6 class="mb-0 text-truncate" title="{{ categoria.nombre }}">
                                    <i class="{{ categoria.icono }}" style="color: {{ categoria.color }};"></i> 
                                    <span class="d-none d-sm-inline">{{ categoria.nombre }}</span>
                                    <span class="d-inline d-sm-none">{{ categoria.nombre[:15] }}{% if categoria.nombre|length > 15 %}...{% endif %}</span>
                                </h6>
                                <span class="badge bg-secondary">#{{ categoria.id }}</span>
                            </div>
                            <div class="card-body">
                                {% if categoria.descripcion %}
                                <p class="card-text text-muted small">{{ categoria.descripcion[:60] }}{% if categoria.descripcion|length > 60 %}...{% endif %}</p>
                                {% endif %}
                                
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Productos</small>
                                        <div class="fw-bold text-info">{{ categoria.productos|length }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Estado</small>
                                        <div>
                                            {% if categoria.activa %}
                                            <span class="badge bg-success">Activa</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inactiva</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted d-block">Color</small>
                                    <div class="d-flex align-items-center">
                                        <div class="color-preview me-2" style="width: 20px; height: 20px; background-color: {{ categoria.color }}; border-radius: 50%;"></div>
                                        <span class="small">{{ categoria.color }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light p-2">
                                <!-- Botones de acción responsivos -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editarCategoria({{ categoria.id }}, '{{ categoria.nombre|replace("'", "\\") }}', '{{ categoria.descripcion|replace("'", "\\") if categoria.descripcion else "" }}', '{{ categoria.icono }}', '{{ categoria.color }}', {{ categoria.activa|lower }})" title="Editar categoría">
                                        <i class="fas fa-edit"></i> 
                                        <span class="d-none d-sm-inline ms-1">Editar</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" onclick="eliminarCategoria({{ categoria.id }}, '{{ categoria.nombre|replace("'", "\\") }}')" title="Eliminar categoría">
                                        <i class="fas fa-trash"></i> 
                                        <span class="d-none d-sm-inline ms-1">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if not categorias %}
                <div class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-tags fa-4x text-muted mb-4"></i>
                        <h4>No hay categorías</h4>
                        <p class="text-muted">Crea tu primera categoría para organizar tus productos.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoriaModal" onclick="nuevaCategoria()">
                            <i class="fas fa-plus"></i> Crear Primera Categoría
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tab de Configuración -->
    <div class="tab-pane fade" id="configuracion" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <h3><i class="fas fa-cog"></i> Configuración de la Tienda</h3>
                <p class="text-muted">Personaliza la información de tu tienda online</p>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-store"></i> Información General</h5>
                    </div>
                    <div class="card-body">
                        <form id="configuracionForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="nombre_tienda" class="form-label">
                                            <i class="fas fa-signature"></i> Nombre de la Tienda
                                        </label>
                                        <input type="text" class="form-control" id="nombre_tienda" 
                                               placeholder="Ej: Mi Tienda Online" maxlength="50">
                                        <div class="form-text">Este nombre aparecerá en el encabezado de tu tienda</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Vista Previa</label>
                                        <div class="border rounded p-2 bg-light">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-store text-primary me-2"></i>
                                                <span id="preview_nombre" class="fw-bold">Mi Tienda Online</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="descripcion_tienda" class="form-label">
                                                <i class="fas fa-info-circle"></i> Descripción de la Tienda
                                            </label>
                                            <textarea class="form-control" id="descripcion_tienda" rows="3" 
                                                      placeholder="Describe brevemente tu tienda..." maxlength="200"></textarea>
                                            <div class="form-text">Descripción que aparecerá en la página principal</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Vista Previa</label>
                                            <div class="border rounded p-2 bg-light">
                                                <small id="preview_descripcion" class="text-muted">Descripción de la tienda</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="logo_tienda" class="form-label">
                                                <i class="fas fa-image text-primary"></i> Logo de la Tienda
                                            </label>
                                            <input type="file" class="form-control" id="logo_tienda" accept="image/*">
                                            <div class="form-text">Sube el logo de tu tienda (PNG, JPG, JPEG, GIF, WEBP - Máx. 5MB)</div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-outline-primary btn-sm" id="subirLogoBtn">
                                                    <i class="fas fa-upload"></i> Subir Logo
                                                </button>
                                                <button type="button" class="btn btn-outline-danger btn-sm ms-2" id="eliminarLogoBtn" style="display: none;">
                                                    <i class="fas fa-trash"></i> Eliminar Logo
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Vista Previa del Logo</label>
                                            <div class="border rounded p-2 bg-light text-center">
                                                <div id="preview_logo" class="d-flex align-items-center justify-content-center" style="min-height: 60px;">
                                                    <i class="fas fa-image text-muted fa-2x"></i>
                                                    <span class="text-muted ms-2">Sin logo</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="whatsapp_admin" class="form-label">
                                                <i class="fab fa-whatsapp text-success"></i> WhatsApp del Administrador
                                            </label>
                                            <input type="tel" class="form-control" id="whatsapp_admin" 
                                                   placeholder="Ej: +51987654321" maxlength="20">
                                            <div class="form-text">Número de WhatsApp para que los clientes te contacten</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Vista Previa</label>
                                            <div class="border rounded p-2 bg-light">
                                                <div class="d-flex align-items-center">
                                                    <i class="fab fa-whatsapp text-success me-2"></i>
                                                    <span id="preview_whatsapp" class="text-muted">Sin WhatsApp configurado</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-primary" id="guardarConfiguracionBtn">
                                        <i class="fas fa-save"></i> Guardar Configuración
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="restaurarConfiguracionBtn">
                                        <i class="fas fa-undo"></i> Restaurar Valores
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> Última actualización: <span id="ultima_actualizacion">-</span>
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Sección de Colores -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-palette"></i> Colores de la Tienda</h5>
                    </div>
                    <div class="card-body">
                        <form id="coloresForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3"><i class="fas fa-paint-brush"></i> Colores Principales</h6>
                                    
                                    <div class="mb-3">
                                        <label for="color_primario" class="form-label">
                                            <i class="fas fa-circle text-primary"></i> Color Primario
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_primario" value="#007bff">
                                            <input type="text" class="form-control" id="color_primario_text" value="#007bff" readonly>
                                        </div>
                                        <div class="form-text">Color principal de la tienda (botones, enlaces, etc.)</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_secundario" class="form-label">
                                            <i class="fas fa-circle text-secondary"></i> Color Secundario
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_secundario" value="#6c757d">
                                            <input type="text" class="form-control" id="color_secundario_text" value="#6c757d" readonly>
                                        </div>
                                        <div class="form-text">Color secundario para elementos complementarios</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_exito" class="form-label">
                                            <i class="fas fa-circle text-success"></i> Color de Éxito
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_exito" value="#28a745">
                                            <input type="text" class="form-control" id="color_exito_text" value="#28a745" readonly>
                                        </div>
                                        <div class="form-text">Color para mensajes de éxito y confirmaciones</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_peligro" class="form-label">
                                            <i class="fas fa-circle text-danger"></i> Color de Peligro
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_peligro" value="#dc3545">
                                            <input type="text" class="form-control" id="color_peligro_text" value="#dc3545" readonly>
                                        </div>
                                        <div class="form-text">Color para mensajes de error y advertencias</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_advertencia" class="form-label">
                                            <i class="fas fa-circle text-warning"></i> Color de Advertencia
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_advertencia" value="#ffc107">
                                            <input type="text" class="form-control" id="color_advertencia_text" value="#ffc107" readonly>
                                        </div>
                                        <div class="form-text">Color para mensajes de advertencia</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="mb-3"><i class="fas fa-palette"></i> Colores de Fondo y Texto</h6>
                                    
                                    <div class="mb-3">
                                        <label for="color_fondo" class="form-label">
                                            <i class="fas fa-square text-light"></i> Color de Fondo
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_fondo" value="#ffffff">
                                            <input type="text" class="form-control" id="color_fondo_text" value="#ffffff" readonly>
                                        </div>
                                        <div class="form-text">Color de fondo principal de la página</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_texto" class="form-label">
                                            <i class="fas fa-font text-dark"></i> Color de Texto
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_texto" value="#333333">
                                            <input type="text" class="form-control" id="color_texto_text" value="#333333" readonly>
                                        </div>
                                        <div class="form-text">Color principal del texto</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_fondo_secundario" class="form-label">
                                            <i class="fas fa-square text-light"></i> Fondo Secundario
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_fondo_secundario" value="#f8f9fa">
                                            <input type="text" class="form-control" id="color_fondo_secundario_text" value="#f8f9fa" readonly>
                                        </div>
                                        <div class="form-text">Color de fondo para secciones secundarias</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_borde" class="form-label">
                                            <i class="fas fa-square text-secondary"></i> Color de Borde
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_borde" value="#dee2e6">
                                            <input type="text" class="form-control" id="color_borde_text" value="#dee2e6" readonly>
                                        </div>
                                        <div class="form-text">Color para bordes y separadores</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="color_info" class="form-label">
                                            <i class="fas fa-circle text-info"></i> Color de Información
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="color_info" value="#17a2b8">
                                            <input type="text" class="form-control" id="color_info_text" value="#17a2b8" readonly>
                                        </div>
                                        <div class="form-text">Color para mensajes informativos</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <div>
                                    <button type="button" class="btn btn-primary" id="guardarColoresBtn">
                                        <i class="fas fa-save"></i> Guardar Colores
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="restaurarColoresBtn">
                                        <i class="fas fa-undo"></i> Restaurar por Defecto
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> Los cambios se aplicarán inmediatamente
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Sección de Banners Múltiples -->
                <div class="card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-images"></i> Carrusel de Banners</h5>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#nuevoBannerModal">
                            <i class="fas fa-plus"></i> Nuevo Banner
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="bannersList">
                            <!-- Los banners se cargarán aquí dinámicamente -->
                        </div>
                        <div id="noBannersMessage" class="text-center py-4" style="display: none;">
                            <i class="fas fa-images text-muted fa-3x"></i>
                            <p class="text-muted mt-2">No hay banners creados</p>
                            <p class="text-muted">Haz clic en "Nuevo Banner" para crear el primero</p>
                        </div>
                    </div>
                </div>

                <!-- Modal para Nuevo Banner -->
                <div class="modal fade" id="nuevoBannerModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-plus"></i> Nuevo Banner
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="nuevoBannerForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="banner_nombre" class="form-label">
                                                    <i class="fas fa-tag"></i> Nombre del Banner
                                                </label>
                                                <input type="text" class="form-control" id="banner_nombre" 
                                                       placeholder="Ej: Oferta Navidad" maxlength="100" required>
                                                <div class="form-text">Nombre para identificar el banner</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="banner_texto" class="form-label">
                                                    <i class="fas fa-font"></i> Texto del Banner
                                                </label>
                                                <input type="text" class="form-control" id="banner_texto" 
                                                       placeholder="Ej: ¡Oferta especial! 20% de descuento" maxlength="200">
                                                <div class="form-text">Texto que aparecerá sobre el banner (opcional)</div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="banner_imagen_nueva" class="form-label">
                                                    <i class="fas fa-image text-primary"></i> Imagen del Banner
                                                </label>
                                                <input type="file" class="form-control" id="banner_imagen_nueva" accept="image/*" required>
                                                <div class="form-text">PNG, JPG, JPEG, GIF, WEBP - Máx. 5MB</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Vista Previa</label>
                                                <div class="border rounded p-2 bg-light text-center">
                                                    <div id="preview_nuevo_banner" class="d-flex align-items-center justify-content-center" style="min-height: 150px;">
                                                        <div class="text-center">
                                                            <i class="fas fa-image text-muted fa-3x"></i>
                                                            <p class="text-muted mt-2">Selecciona una imagen</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" id="crearBannerBtn">
                                    <i class="fas fa-save"></i> Crear Banner
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-key"></i> Cambiar Contraseña</h5>
                    </div>
                    <div class="card-body">
                        <form id="cambiarPasswordForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_actual" class="form-label">
                                            <i class="fas fa-lock"></i> Contraseña Actual
                                        </label>
                                        <input type="password" class="form-control" id="password_actual" required>
                                        <div class="form-text">Ingresa tu contraseña actual para confirmar</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_nueva" class="form-label">
                                            <i class="fas fa-key"></i> Nueva Contraseña
                                        </label>
                                        <input type="password" class="form-control" id="password_nueva" required minlength="6">
                                        <div class="form-text">Mínimo 6 caracteres</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_confirmar" class="form-label">
                                            <i class="fas fa-check-circle"></i> Confirmar Nueva Contraseña
                                        </label>
                                        <input type="password" class="form-control" id="password_confirmar" required>
                                        <div class="form-text">Repite la nueva contraseña</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Seguridad de la Contraseña</label>
                                        <div class="border rounded p-2 bg-light">
                                            <div id="password-strength" class="text-muted">
                                                <i class="fas fa-info-circle"></i> Ingresa una nueva contraseña
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-warning" id="cambiarPasswordBtn">
                                        <i class="fas fa-key"></i> Cambiar Contraseña
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="limpiarPasswordBtn">
                                        <i class="fas fa-eraser"></i> Limpiar
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt"></i> Usuario actual: <strong>{{ current_user.username }}</strong>
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Información del Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Configuraciones Disponibles:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> Nombre de la tienda</li>
                                    <li><i class="fas fa-check text-success"></i> Descripción de la tienda</li>
                                    <li><i class="fas fa-clock text-warning"></i> Logo de la tienda (próximamente)</li>
                                    <li><i class="fas fa-clock text-warning"></i> Colores personalizados (próximamente)</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Estadísticas:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-box"></i> Productos activos: <span class="badge bg-primary">{{ productos_activos }}</span></li>
                                    <li><i class="fas fa-shopping-cart"></i> Total pedidos: <span class="badge bg-success">{{ total_pedidos }}</span></li>
                                    <li><i class="fas fa-user"></i> Usuarios registrados: <span class="badge bg-info">{{ total_usuarios }}</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Producto -->
<div class="modal fade" id="productoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productoModalTitle">
                    <i class="fas fa-box"></i> 
                    <span class="d-none d-sm-inline">Nuevo Producto</span>
                    <span class="d-inline d-sm-none">Producto</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productoForm">
                    <input type="hidden" id="producto_id">
                    <div class="mb-3">
                        <label for="producto_nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="producto_nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="producto_descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="producto_descripcion" rows="3"></textarea>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="producto_precio" class="form-label">Precio *</label>
                                <input type="number" class="form-control" id="producto_precio" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="producto_stock" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="producto_stock" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="producto_imagen" class="form-label">
                            <i class="fas fa-image"></i> Imagen del Producto
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="file" class="form-control" id="producto_imagen_file" accept="image/*" onchange="previewImage(this)">
                                <div class="form-text">Selecciona una imagen desde tu ordenador</div>
                            </div>
                            <div class="col-md-6">
                                <input type="url" class="form-control" id="producto_imagen" placeholder="O pega una URL de imagen">
                                <div class="form-text">O pega una URL de imagen</div>
                            </div>
                        </div>
                        <div id="imagen_preview" class="mt-2" style="display: none;">
                            <img id="preview_img" src="" alt="Vista previa" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="producto_categoria" class="form-label">
                            <i class="fas fa-tags"></i> Categoría
                        </label>
                        <select class="form-select" id="producto_categoria">
                            <option value="">Sin categoría</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Selecciona la categoría del producto</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="producto_activo" checked>
                            <label class="form-check-label" for="producto_activo">
                                Producto activo
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times d-sm-none"></i>
                    <span class="d-none d-sm-inline">Cancelar</span>
                </button>
                <button type="button" class="btn btn-primary" id="guardarProductoBtn">
                    <i class="fas fa-save"></i> 
                    <span class="d-none d-sm-inline ms-1">Guardar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Categoría -->
<div class="modal fade" id="categoriaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoriaModalTitle">
                    <i class="fas fa-tag"></i> 
                    <span class="d-none d-sm-inline">Nueva Categoría</span>
                    <span class="d-inline d-sm-none">Categoría</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoriaForm">
                    <input type="hidden" id="categoria_id" name="categoria_id">
                    
                    <div class="mb-3">
                        <label for="categoria_nombre" class="form-label">
                            <i class="fas fa-tag"></i> Nombre de la Categoría *
                        </label>
                        <input type="text" class="form-control" id="categoria_nombre" name="categoria_nombre" required maxlength="50">
                        <div class="form-text">Nombre único para la categoría</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoria_descripcion" class="form-label">
                            <i class="fas fa-align-left"></i> Descripción
                        </label>
                        <textarea class="form-control" id="categoria_descripcion" name="categoria_descripcion" rows="3" maxlength="200"></textarea>
                        <div class="form-text">Descripción opcional de la categoría</div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="categoria_icono" class="form-label">
                                    <i class="fas fa-icons"></i> Icono
                                </label>
                                <select class="form-select" id="categoria_icono" name="categoria_icono">
                                    <option value="fas fa-tag">🏷️ Etiqueta</option>
                                    <option value="fas fa-utensils">🍽️ Comida</option>
                                    <option value="fas fa-coffee">☕ Bebidas</option>
                                    <option value="fas fa-ice-cream">🍦 Postres</option>
                                    <option value="fas fa-laptop">💻 Servicios</option>
                                    <option value="fas fa-heart">❤️ Salud</option>
                                    <option value="fas fa-car">🚗 Transporte</option>
                                    <option value="fas fa-home">🏠 Hogar</option>
                                    <option value="fas fa-gamepad">🎮 Entretenimiento</option>
                                    <option value="fas fa-gift">🎁 Regalos</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="categoria_color" class="form-label">
                                    <i class="fas fa-palette"></i> Color
                                </label>
                                <input type="color" class="form-control form-control-color" id="categoria_color" name="categoria_color" value="#007bff">
                                <div class="form-text">Color de la categoría</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="categoria_activa" name="categoria_activa" checked>
                            <label class="form-check-label" for="categoria_activa">
                                <i class="fas fa-eye"></i> Categoría activa
                            </label>
                        </div>
                        <div class="form-text">Las categorías inactivas no se mostrarán en la tienda</div>
                    </div>
                    
                    <!-- Vista previa -->
                    <div class="mb-3">
                        <label class="form-label">Vista Previa</label>
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center">
                                <i id="preview_icono" class="fas fa-tag me-2" style="color: #007bff;"></i>
                                <span id="preview_nombre" class="fw-bold">Nombre de la categoría</span>
                            </div>
                            <div class="mt-2">
                                <span class="badge" id="preview_badge" style="background-color: #007bff;">Categoría</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times d-sm-none"></i>
                    <span class="d-none d-sm-inline">Cancelar</span>
                </button>
                <button type="button" class="btn btn-primary" id="guardarCategoriaBtn">
                    <i class="fas fa-save"></i> 
                    <span class="d-none d-sm-inline ms-1">Guardar Categoría</span>
                    <span class="d-inline d-sm-none">Guardar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalle de Pedido -->
<div class="modal fade" id="detallePedidoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt"></i> 
                    <span class="d-none d-sm-inline">Detalle del Pedido</span>
                    <span class="d-inline d-sm-none">Pedido</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallePedidoContent">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success flex-fill flex-md-fill-0" id="confirmarPedidoBtn" onclick="abrirWhatsAppCliente()">
                    <i class="fab fa-whatsapp"></i> 
                    <span class="d-none d-sm-inline ms-1">Enviar WhatsApp al Cliente</span>
                    <span class="d-inline d-sm-none">WhatsApp</span>
                </button>
                <button type="button" class="btn btn-secondary flex-fill flex-md-fill-0" data-bs-dismiss="modal">
                    <i class="fas fa-times d-sm-none"></i>
                    <span class="d-none d-sm-inline">Cerrar</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Variables CSS para el tema moderno del admin */
    :root {
        --admin-primary: #667eea;
        --admin-secondary: #764ba2;
        --admin-bg: #f8fafc;
        --admin-card-bg: #ffffff;
        --admin-text: #2d3748;
        --admin-text-light: #718096;
        --admin-border: #e2e8f0;
        --admin-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --admin-shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --admin-radius: 12px;
        --admin-radius-lg: 20px;
    }
    
    /* Estilos base modernos */
    body {
        background-color: var(--admin-bg);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: var(--admin-text);
    }
    
    /* Header moderno */
    .admin-header {
        background: linear-gradient(135deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
        color: white;
        padding: 40px 30px;
        border-radius: var(--admin-radius-lg);
        margin-bottom: 30px;
        box-shadow: var(--admin-shadow-lg);
        position: relative;
        overflow: hidden;
    }
    
    .admin-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        pointer-events: none;
    }
    
    .admin-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        position: relative;
        z-index: 1;
    }
    
    .admin-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin: 10px 0 0 0;
        position: relative;
        z-index: 1;
    }
    
    /* Navegación moderna */
    .admin-nav {
        background: var(--admin-card-bg);
        border-radius: var(--admin-radius);
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: var(--admin-shadow);
        border: 1px solid var(--admin-border);
    }
    
    .admin-nav .nav-pills .nav-link {
        border-radius: 10px;
        padding: 12px 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        margin: 0 5px;
    }
    
    .admin-nav .nav-pills .nav-link:hover {
        background-color: var(--admin-bg);
        border-color: var(--admin-border);
        transform: translateY(-2px);
    }
    
    .admin-nav .nav-pills .nav-link.active {
        background: linear-gradient(135deg, var(--admin-primary), var(--admin-secondary));
        border-color: var(--admin-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    /* Cards modernas */
    .card {
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius);
        box-shadow: var(--admin-shadow);
        background: var(--admin-card-bg);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        box-shadow: var(--admin-shadow-lg);
        transform: translateY(-2px);
    }
    
    .card-header {
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border-bottom: 1px solid var(--admin-border);
        border-radius: var(--admin-radius) var(--admin-radius) 0 0 !important;
        padding: 20px;
    }
    
    .card-header h5 {
        margin: 0;
        font-weight: 600;
        color: var(--admin-text);
    }
    
    /* Botones modernos */
    .btn {
        border-radius: 10px;
        font-weight: 500;
        padding: 10px 20px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--admin-primary), var(--admin-secondary));
        border-color: var(--admin-primary);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        border-color: #10b981;
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        border-color: #ef4444;
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        border-color: #f59e0b;
    }
    
    .btn-info {
        background: linear-gradient(135deg, #06b6d4, #0891b2);
        border-color: #06b6d4;
    }
    
    /* Product cards modernas */
    .product-card {
        border: 1px solid var(--admin-border);
        border-radius: var(--admin-radius);
        background: var(--admin-card-bg);
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .product-card:hover {
        box-shadow: var(--admin-shadow-lg);
        transform: translateY(-4px);
    }
    
    .product-card .card-body {
        padding: 20px;
    }
    
    .product-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--admin-text);
        margin-bottom: 10px;
    }
    
    .product-price {
        font-size: 1.2rem;
        font-weight: 700;
        color: #10b981;
        margin-bottom: 5px;
    }
    
    .product-stock {
        font-size: 0.9rem;
        color: var(--admin-text-light);
        margin-bottom: 10px;
    }
    
    .product-description {
        font-size: 0.9rem;
        color: var(--admin-text-light);
        margin-bottom: 15px;
        line-height: 1.4;
    }
    
    /* Badges modernos */
    .badge {
        border-radius: 8px;
        font-weight: 500;
        padding: 6px 12px;
    }
    
    /* Formularios modernos */
    .form-control, .form-select {
        border: 2px solid var(--admin-border);
        border-radius: 10px;
        padding: 12px 16px;
        transition: all 0.3s ease;
        background: var(--admin-card-bg);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--admin-primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-label {
        font-weight: 500;
        color: var(--admin-text);
        margin-bottom: 8px;
    }
    
    /* Estilos responsivos para móviles */
    @media (max-width: 767.98px) {
        /* Contenedor principal */
        .container-fluid {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        /* Header responsive */
        .admin-header {
            padding: 25px 20px;
            margin-bottom: 20px;
            border-radius: 15px;
        }
        
        .admin-header h1 {
            font-size: 1.8rem;
        }
        
        .admin-header p {
            font-size: 1rem;
        }
        
        /* Navegación móvil */
        .admin-nav {
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .admin-nav .nav-pills {
            flex-direction: column;
            gap: 10px;
        }
        
        .admin-nav .nav-pills .nav-link {
            text-align: center;
            margin: 0;
            padding: 15px 20px;
            font-size: 0.95rem;
        }
        
        /* Cards responsive */
        .card {
            margin-bottom: 15px;
            border-radius: 12px;
        }
        
        .card-header {
            padding: 15px;
        }
        
        .card-body {
            padding: 15px;
        }
        
        /* Botones móviles */
        .btn {
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            padding: 12px 16px;
        }
        
        /* Grid de productos responsive */
        .row .col-md-6 {
            margin-bottom: 15px;
        }
        
        /* Product cards móviles */
        .product-card {
            border-radius: 12px;
        }
        
        .product-card .card-body {
            padding: 15px;
        }
        
        .product-name {
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        .product-price {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .product-stock {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .product-description {
            font-size: 0.85rem;
            margin-bottom: 12px;
        }
        
        /* Botones de acción en móviles */
        .d-grid.gap-2.d-md-flex {
            gap: 8px !important;
        }
        
        .d-grid.gap-2.d-md-flex .btn {
            flex: 1;
            min-width: 0;
        }
        
        /* Formularios móviles */
        .form-control, .form-select {
            padding: 14px 16px;
            font-size: 16px; /* Previene zoom en iOS */
        }
        
        .form-label {
            font-size: 0.95rem;
            margin-bottom: 6px;
        }
        
        /* Modal responsive */
        .modal-dialog {
            margin: 10px;
            max-width: calc(100% - 20px);
        }
        
        .modal-content {
            border-radius: 15px;
        }
        
        .modal-header {
            padding: 20px 20px 15px 20px;
        }
        
        .modal-body {
            padding: 15px 20px;
        }
        
        .modal-footer {
            padding: 15px 20px 20px 20px;
        }
        
        /* Tablas responsive */
        .table-responsive {
            border-radius: 12px;
            border: 1px solid var(--admin-border);
        }
        
        .table {
            font-size: 0.9rem;
        }
        
        /* Stats cards móviles */
        .stats-card {
            margin-bottom: 15px;
        }
        
        /* Botones de configuración móviles */
        .config-buttons {
            flex-direction: column;
            gap: 10px;
        }
        
        .config-buttons .btn {
            width: 100%;
        }
        
        /* Mejorar espaciado general */
        .mb-4 {
            margin-bottom: 1.5rem !important;
        }
        
        .mt-4 {
            margin-top: 1.5rem !important;
        }
        
        /* Ajustar padding de secciones */
        .section-padding {
            padding: 15px 0;
        }
    }
    
    /* Estilos para tablets */
    @media (min-width: 768px) and (max-width: 1023px) {
        .admin-header {
            padding: 35px 25px;
        }
        
        .admin-header h1 {
            font-size: 2.2rem;
        }
        
        .admin-nav .nav-pills .nav-link {
            padding: 10px 16px;
            font-size: 0.9rem;
        }
        
        .product-card .card-body {
            padding: 18px;
        }
        
        .btn {
            padding: 10px 18px;
        }
    }
    
    /* Mejoras adicionales para pantallas muy pequeñas */
    @media (max-width: 480px) {
        .admin-header {
            padding: 20px 15px;
            margin-bottom: 15px;
        }
        
        .admin-header h1 {
            font-size: 1.6rem;
        }
        
        .admin-nav {
            padding: 12px;
        }
        
        .card-body {
            padding: 12px;
        }
        
        .btn {
            min-height: 44px;
            font-size: 0.9rem;
            padding: 10px 14px;
        }
        
        .product-name {
            font-size: 0.95rem;
        }
        
        .product-price {
            font-size: 1rem;
        }
    }
        
        /* Mejorar formularios en móviles */
        .form-control, .form-select {
            min-height: 44px;
            font-size: 16px; /* Evita zoom en iOS */
        }
        
        /* Ajustar modales en móviles */
        .modal-dialog {
            margin: 0.5rem;
        }
        
        /* Mejorar navegación móvil */
        .nav-tabs {
            border-bottom: none;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        
        /* Ajustar badges en móviles */
        .badge {
            font-size: 0.75em;
        }
        
        /* Mejorar alertas en móviles */
        .alert {
            font-size: 0.9rem;
        }
        
        /* Ajustar tablas en móviles */
        .table-responsive {
            border-radius: 0.375rem;
        }
        
        /* Mejorar espaciado de grid */
        .row.g-3 {
            --bs-gutter-x: 1rem;
            --bs-gutter-y: 1rem;
        }
    }
    
    @media (max-width: 575.98px) {
        /* Ajustes para pantallas muy pequeñas */
        .card-header h6 {
            font-size: 0.9rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .card-footer {
            padding: 0.5rem;
        }
        
        /* Botones de acción en una columna */
        .d-grid.gap-2.d-md-flex {
            display: grid !important;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        /* Ajustar texto en móviles */
        .text-truncate {
            max-width: 120px;
        }
    }
    
    /* Mejorar experiencia táctil */
    .btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* Animaciones suaves */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Mejorar contraste en móviles */
    @media (max-width: 767.98px) {
        .text-muted {
            color: #6c757d !important;
        }
        
        .btn-outline-primary {
            border-width: 2px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Gestión de productos
    document.getElementById('guardarProductoBtn').addEventListener('click', function() {
        const productoId = document.getElementById('producto_id').value;
        
        // Validaciones
        const nombre = document.getElementById('producto_nombre').value.trim();
        const precio = parseFloat(document.getElementById('producto_precio').value);
        const stock = parseInt(document.getElementById('producto_stock').value);
        
        if (!nombre) {
            alert('El nombre del producto es obligatorio');
            return;
        }
        
        if (isNaN(precio) || precio <= 0) {
            alert('El precio debe ser un número mayor a 0');
            return;
        }
        
        if (isNaN(stock) || stock < 0) {
            alert('El stock debe ser un número mayor o igual a 0');
            return;
        }
        
        // Verificar si hay un archivo de imagen seleccionado
        const archivoImagen = document.getElementById('producto_imagen_file').files[0];
        const urlImagen = document.getElementById('producto_imagen').value.trim();
        
        // Mostrar indicador de carga
        const btn = document.getElementById('guardarProductoBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        // Si hay archivo de imagen, subirlo primero
        if (archivoImagen) {
            subirImagenYGuardarProducto(archivoImagen, nombre, productoId);
        } else {
            // Si no hay archivo, guardar directamente con URL
            guardarProductoConURL(urlImagen, productoId);
        }
    });
    
    function subirImagenYGuardarProducto(archivo, nombreProducto, productoId) {
        const formData = new FormData();
        formData.append('imagen', archivo);
        formData.append('nombre_producto', nombreProducto);
        
        fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Imagen subida exitosamente, ahora guardar el producto
                guardarProductoConURL(data.url_imagen, productoId);
            } else {
                throw new Error(data.error || 'Error al subir la imagen');
            }
        })
        .catch(error => {
            console.error('Error al subir imagen:', error);
            alert('Error al subir la imagen: ' + error.message);
            resetearBotonGuardar();
        });
    }
    
    function guardarProductoConURL(urlImagen, productoId) {
        const productoData = {
            nombre: document.getElementById('producto_nombre').value.trim(),
            descripcion: document.getElementById('producto_descripcion').value.trim(),
            precio: parseFloat(document.getElementById('producto_precio').value),
            stock: parseInt(document.getElementById('producto_stock').value),
            imagen: urlImagen,
            activo: document.getElementById('producto_activo').checked,
            categoria_id: document.getElementById('producto_categoria').value || null
        };
        
        const url = productoId ? `/api/producto/${productoId}` : '/api/producto';
        const method = productoId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productoData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let mensaje = '';
                if (productoId) {
                    mensaje = '✅ Producto actualizado exitosamente';
                } else {
                    mensaje = '✅ Producto creado exitosamente';
                }
                alert(mensaje);
                location.reload();
            } else {
                alert('❌ Error al guardar el producto: ' + data.error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar el producto');
            resetearBotonGuardar();
        });
    }
    
    function resetearBotonGuardar() {
        const btn = document.getElementById('guardarProductoBtn');
        btn.innerHTML = '<i class="fas fa-save"></i> <span class="d-none d-sm-inline ms-1">Guardar</span>';
        btn.disabled = false;
    }
    
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagen_preview');
                const img = document.getElementById('preview_img');
                img.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function editarProducto(id, nombre, descripcion, precio, stock, imagen, activo, categoria_id) {
        console.log('Editando producto ID:', id);
        
        // Verificar que el modal existe
        const modal = document.getElementById('productoModal');
        if (!modal) {
            alert('Error: Modal no encontrado. Verifica que el HTML esté correcto.');
            return;
        }
        
        // Llenar formulario con datos del producto
        document.getElementById('producto_id').value = id || '';
        document.getElementById('producto_nombre').value = nombre || '';
        document.getElementById('producto_descripcion').value = descripcion || '';
        document.getElementById('producto_precio').value = precio || '';
        document.getElementById('producto_stock').value = stock || '';
        document.getElementById('producto_imagen').value = imagen || '';
        document.getElementById('producto_activo').checked = activo === 'true' || activo === true;
        
        // Limpiar archivo de imagen y mostrar vista previa si hay URL
        document.getElementById('producto_imagen_file').value = '';
        if (imagen) {
            const preview = document.getElementById('imagen_preview');
            const img = document.getElementById('preview_img');
            img.src = imagen;
            preview.style.display = 'block';
        } else {
            document.getElementById('imagen_preview').style.display = 'none';
        }
        
        // Establecer la categoría seleccionada
        const categoriaSelect = document.getElementById('producto_categoria');
        if (categoria_id && categoria_id !== 'None' && categoria_id !== '') {
            categoriaSelect.value = categoria_id;
        } else {
            categoriaSelect.value = '';
        }
        
        // Cambiar título y botón
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Producto';
        
        // Mostrar modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        console.log('Modal abierto exitosamente para producto:', nombre, 'con categoría:', categoria_id);
    }
    
    function duplicarProducto(producto) {
        // Cambiar título del modal
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-copy"></i> Duplicar Producto';
        
        // Llenar formulario con datos del producto (sin ID para crear nuevo)
        document.getElementById('producto_id').value = '';
        document.getElementById('producto_nombre').value = producto.nombre + ' (Copia)';
        document.getElementById('producto_descripcion').value = producto.descripcion || '';
        document.getElementById('producto_precio').value = producto.precio;
        document.getElementById('producto_stock').value = 0; // Stock en 0 para la copia
        document.getElementById('producto_imagen').value = producto.imagen || '';
        document.getElementById('producto_activo').checked = false; // Inactivo por defecto
        
        // Cambiar texto del botón
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Crear Copia';
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('productoModal'));
        modal.show();
        
        // Enfocar en el campo nombre y seleccionar todo el texto
        setTimeout(() => {
            const nombreField = document.getElementById('producto_nombre');
            nombreField.focus();
            nombreField.select();
        }, 500);
    }
    
    function toggleProductStatus(productoId, nuevoEstado) {
        const accion = nuevoEstado ? 'activar' : 'desactivar';
        const confirmacion = confirm(`¿Estás seguro de que quieres ${accion} este producto?`);
        
        if (!confirmacion) return;
        
        // Mostrar indicador de carga
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        const productoData = {
            activo: nuevoEstado
        };
        
        fetch(`/api/producto/${productoId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productoData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar la interfaz sin recargar la página
                const statusElement = document.getElementById(`status-${productoId}`);
                if (nuevoEstado) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Activo';
                    btn.className = 'btn btn-sm btn-outline-warning ms-1';
                    btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    btn.onclick = () => toggleProductStatus(productoId, false);
                } else {
                    statusElement.className = 'badge bg-secondary';
                    statusElement.textContent = 'Inactivo';
                    btn.className = 'btn btn-sm btn-outline-success ms-1';
                    btn.innerHTML = '<i class="fas fa-eye"></i>';
                    btn.onclick = () => toggleProductStatus(productoId, true);
                }
                btn.disabled = false;
                alert(`✅ Producto ${accion}do exitosamente`);
            } else {
                alert('❌ Error al actualizar el producto: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al actualizar el producto');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function eliminarProducto(id) {
        const confirmMessage = `¿Estás seguro de que quieres eliminar este producto?

⚠️ IMPORTANTE:
- Si el producto tiene pedidos asociados, solo se desactivará
- Si no tiene pedidos, se eliminará permanentemente
- Esta acción no se puede deshacer

¿Continuar?`;
        
        if (confirm(confirmMessage)) {
            // Mostrar indicador de carga
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
            btn.disabled = true;
            
            fetch(`/api/producto/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.mensaje);
                    location.reload();
                } else {
                    alert('Error al eliminar el producto: ' + data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    }
    
    // Gestión de pedidos
    function actualizarEstado(pedidoId, nuevoEstado) {
        fetch(`/api/pedido/${pedidoId}/estado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Estado actualizado exitosamente');
            } else {
                alert('Error al actualizar el estado: ' + data.error);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar el estado');
            location.reload();
        });
    }
    
    // Variables globales para almacenar datos del pedido
    let pedidoActual = {};
    
    function verDetallePedido(id, cliente_nombre, cliente_telefono, cliente_direccion, total, estado, fecha_pedido, cliente_comentarios) {
        console.log('Viendo detalle del pedido ID:', id);
        
        // Guardar datos del pedido en variables globales
        pedidoActual = {
            id: id,
            cliente_nombre: cliente_nombre,
            cliente_telefono: cliente_telefono,
            cliente_direccion: cliente_direccion,
            total: total,
            estado: estado,
            fecha_pedido: fecha_pedido,
            cliente_comentarios: cliente_comentarios
        };
        
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Información del Cliente</h6>
                    <p><strong>Nombre:</strong> ${cliente_nombre || 'No especificado'}</p>
                    <p><strong>Teléfono:</strong> ${cliente_telefono || 'No especificado'}</p>
                    <p><strong>Dirección:</strong> ${cliente_direccion || 'No especificada'}</p>
                    ${cliente_comentarios ? `<p><strong>Comentarios:</strong> ${cliente_comentarios}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Información del Pedido</h6>
                    <p><strong>ID:</strong> #${id}</p>
                    <p><strong>Fecha:</strong> ${fecha_pedido}</p>
                    <p><strong>Estado:</strong> <span class="badge bg-${estado === 'pendiente' ? 'warning' : estado === 'confirmado' ? 'info' : 'success'}">${estado}</span></p>
                    <p><strong>Total:</strong> S/${total.toFixed(2)}</p>
                </div>
            </div>
            <hr>
            <h6>Productos</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Cargar los items del pedido via AJAX
        fetch(`/api/pedido/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pedido = data.pedido;
                    
                    // Agregar items del pedido
                    pedido.items.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.producto ? item.producto.nombre : 'Producto eliminado'}</td>
                                <td>${item.cantidad}</td>
                                <td>S/${item.precio_unitario.toFixed(2)}</td>
                                <td>S/${(item.precio_unitario * item.cantidad).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary">
                                        <th colspan="3">Total</th>
                                        <th>S/${pedido.total.toFixed(2)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('detallePedidoContent').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('detallePedidoModal'));
                    modal.show();
                } else {
                    alert('Error al cargar los detalles del pedido: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los detalles del pedido');
            });
    }
    
    function abrirWhatsAppCliente() {
        if (!pedidoActual.id) {
            alert('Error: No hay datos del pedido disponibles');
            return;
        }
        
        // Obtener los items del pedido para incluir en el mensaje
        fetch(`/api/pedido/${pedidoActual.id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pedido = data.pedido;
                    let mensaje = '';
                    
                    // Debug: Mostrar el estado en consola
                    console.log('Estado del pedido:', pedido.estado);
                    
                    // Generar mensaje según el estado del pedido
                    if (pedido.estado === 'entregado') {
                        mensaje = generarMensajeEntregado(pedido);
                    } else if (pedido.estado === 'confirmado') {
                        mensaje = generarMensajeConfirmado(pedido);
                    } else {
                        mensaje = generarMensajePendiente(pedido);
                    }
                    
                    // Limpiar número de teléfono
                    let numeroLimpio = pedidoActual.cliente_telefono.replace(/\D/g, '');
                    if (!numeroLimpio.startsWith('51')) {
                        numeroLimpio = '51' + numeroLimpio;
                    }
                    
                    // Crear URL de WhatsApp
                    const mensajeCodificado = encodeURIComponent(mensaje);
                    const urlWhatsApp = `https://wa.me/${numeroLimpio}?text=${mensajeCodificado}`;
                    
                    // Abrir WhatsApp en nueva pestaña
                    window.open(urlWhatsApp, '_blank');
                    
                    // Mostrar mensaje de confirmación
                    alert(`✅ WhatsApp abierto para ${pedidoActual.cliente_nombre}\n📱 Número: ${pedidoActual.cliente_telefono}\n📋 Estado: ${pedido.estado}\n\nEl mensaje está pre-llenado con los datos del pedido.`);
                    
                } else {
                    alert('❌ Error al cargar los detalles del pedido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error al cargar los detalles del pedido');
            });
    }
    
    function generarMensajeEntregado(pedido) {
        let mensaje = `🎉 *PEDIDO ENTREGADO #${pedido.id}*\n\n`;
        mensaje += `¡Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `¡Excelente noticia! Tu pedido ha sido *entregado exitosamente*.\n\n`;
        mensaje += `📋 *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `• ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - S/${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\n💰 *Total pagado: S/${pedido.total.toFixed(2)}*\n`;
        mensaje += `📍 *Dirección de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `📅 *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n`;
        mensaje += `✅ *Fecha de entrega:* ${new Date().toLocaleDateString('es-PE')}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `💬 *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `🎊 *¡Pedido completado exitosamente!*\n\n`;
        mensaje += `🌟 *¡Gracias por elegirnos!*\n`;
        mensaje += `Esperamos que hayas disfrutado tu pedido.\n\n`;
        mensaje += `⭐ *¿Te gustaría calificar nuestro servicio?*\n`;
        mensaje += `Tu opinión es muy importante para nosotros.\n\n`;
        mensaje += `🔄 *¿Quieres hacer otro pedido?*\n`;
        mensaje += `Estamos aquí para servirte nuevamente.\n\n`;
        mensaje += `¡Que tengas un excelente día! 😊`;
        
        return mensaje;
    }
    
    function generarMensajeConfirmado(pedido) {
        let mensaje = `✅ *PEDIDO CONFIRMADO #${pedido.id}*\n\n`;
        mensaje += `¡Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `Tu pedido ha sido *confirmado* y está siendo preparado.\n\n`;
        mensaje += `📋 *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `• ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - S/${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\n💰 *Total: S/${pedido.total.toFixed(2)}*\n`;
        mensaje += `📍 *Dirección de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `📅 *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `💬 *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `🚚 *Estado:* Confirmado - En preparación\n`;
        mensaje += `⏰ *Tiempo estimado:* 30-45 minutos\n\n`;
        mensaje += `¡Gracias por elegirnos! Te contactaremos cuando esté listo para entrega. 😊`;
        
        return mensaje;
    }
    
    function generarMensajePendiente(pedido) {
        let mensaje = `📝 *PEDIDO RECIBIDO #${pedido.id}*\n\n`;
        mensaje += `¡Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `Hemos recibido tu pedido y lo estamos procesando.\n\n`;
        mensaje += `📋 *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `• ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - S/${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\n💰 *Total: S/${pedido.total.toFixed(2)}*\n`;
        mensaje += `📍 *Dirección de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `📅 *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `💬 *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `⏳ *Estado:* Pendiente de confirmación\n`;
        mensaje += `📞 Te contactaremos pronto para confirmar tu pedido.\n\n`;
        mensaje += `¡Gracias por elegirnos! 😊`;
        
        return mensaje;
    }
    
    function eliminarPedido(pedidoId, clienteNombre) {
        // Confirmar eliminación
        const confirmacion = confirm(`¿Estás seguro de que quieres eliminar el pedido #${pedidoId} del cliente "${clienteNombre}"?\n\n⚠️ Esta acción no se puede deshacer.`);
        if (!confirmacion) return;
        
        // Mostrar loading
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        // Llamar a la API para eliminar el pedido
        fetch(`/api/pedido/${pedidoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Pedido eliminado exitosamente');
                // Recargar la página para actualizar la lista
                location.reload();
            } else {
                alert('❌ Error al eliminar el pedido: ' + data.error);
                // Restaurar botón
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al eliminar el pedido');
            // Restaurar botón
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // Limpiar formulario al cerrar modal
    document.getElementById('productoModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('productoForm').reset();
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-box"></i> Nuevo Producto';
        document.getElementById('producto_id').value = '';
        document.getElementById('producto_activo').checked = true; // Por defecto activo
        
        // Limpiar vista previa de imagen
        document.getElementById('imagen_preview').style.display = 'none';
        document.getElementById('preview_img').src = '';
        
        // Restaurar texto del botón
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Guardar';
    });
    
    // ===== CONFIGURACIÓN DE LA TIENDA =====
    
    // Cargar configuración al abrir la pestaña
    document.getElementById('configuracion-tab').addEventListener('click', function() {
        cargarConfiguracion();
    });
    
    // Actualizar vista previa en tiempo real
    document.getElementById('nombre_tienda').addEventListener('input', function() {
        const nombre = this.value || 'Mi Tienda Online';
        document.getElementById('preview_nombre').textContent = nombre;
    });
    
    document.getElementById('descripcion_tienda').addEventListener('input', function() {
        const descripcion = this.value || 'Descripción de la tienda';
        document.getElementById('preview_descripcion').textContent = descripcion;
    });
    
    document.getElementById('whatsapp_admin').addEventListener('input', function() {
        const whatsapp = this.value || 'Sin WhatsApp configurado';
        document.getElementById('preview_whatsapp').textContent = whatsapp;
    });
    
    // Guardar configuración
    document.getElementById('guardarConfiguracionBtn').addEventListener('click', function() {
        guardarConfiguracion();
    });
    
    // Restaurar configuración
    document.getElementById('restaurarConfiguracionBtn').addEventListener('click', function() {
        cargarConfiguracion();
    });
    
    function cargarConfiguracion() {
        fetch('/api/configuracion')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const config = data.configuracion;
                    document.getElementById('nombre_tienda').value = config.nombre_tienda || '';
                    document.getElementById('descripcion_tienda').value = config.descripcion_tienda || '';
                    document.getElementById('whatsapp_admin').value = config.whatsapp_admin || '';
                    document.getElementById('ultima_actualizacion').textContent = config.ultima_actualizacion || '-';
                    
                    // Actualizar vista previa
                    document.getElementById('preview_nombre').textContent = config.nombre_tienda || 'Mi Tienda Online';
                    document.getElementById('preview_descripcion').textContent = config.descripcion_tienda || 'Descripción de la tienda';
                    document.getElementById('preview_whatsapp').textContent = config.whatsapp_admin || 'Sin WhatsApp configurado';
                    
                    // Actualizar vista previa del logo
                    actualizarVistaPreviaLogo(config.logo_url || '');
                    
                    // Actualizar configuración del banner
                    document.getElementById('banner_text').value = config.banner_text || '';
                    document.getElementById('banner_activo').checked = config.banner_activo || false;
                    actualizarVistaPreviaBanner(config.banner_url || '', config.banner_text || '');
                }
            })
            .catch(error => {
                console.error('Error al cargar configuración:', error);
            });
            
        // Cargar colores
        cargarColores();
    }
    
    function guardarConfiguracion() {
        const nombre = document.getElementById('nombre_tienda').value.trim();
        const descripcion = document.getElementById('descripcion_tienda').value.trim();
        const whatsapp = document.getElementById('whatsapp_admin').value.trim();
        
        if (!nombre) {
            alert('⚠️ El nombre de la tienda es obligatorio');
            return;
        }
        
        const btn = document.getElementById('guardarConfiguracionBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        const data = {
            nombre_tienda: nombre,
            descripcion_tienda: descripcion,
            whatsapp_admin: whatsapp
        };
        
        fetch('/api/configuracion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Configuración guardada exitosamente');
                document.getElementById('ultima_actualizacion').textContent = data.ultima_actualizacion;
            } else {
                alert('❌ Error al guardar configuración: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al guardar configuración');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // ===== FUNCIONES DEL LOGO =====
    
    // Event listeners para el logo
    document.getElementById('subirLogoBtn').addEventListener('click', function() {
        subirLogo();
    });
    
    document.getElementById('eliminarLogoBtn').addEventListener('click', function() {
        eliminarLogo();
    });
    
    // Vista previa del archivo seleccionado
    document.getElementById('logo_tienda').addEventListener('change', function() {
        const archivo = this.files[0];
        if (archivo) {
            // Validar tamaño (máx. 5MB)
            if (archivo.size > 5 * 1024 * 1024) {
                alert('⚠️ El archivo es demasiado grande. Máximo 5MB permitido.');
                this.value = '';
                return;
            }
            
            // Validar tipo de archivo
            const tiposPermitidos = ['image/png', 'image/jpg', 'image/jpeg', 'image/gif', 'image/webp'];
            if (!tiposPermitidos.includes(archivo.type)) {
                alert('⚠️ Formato de archivo no permitido. Use PNG, JPG, JPEG, GIF o WEBP.');
                this.value = '';
                return;
            }
            
            // Mostrar vista previa
            const reader = new FileReader();
            reader.onload = function(e) {
                mostrarVistaPreviaArchivo(e.target.result);
            };
            reader.readAsDataURL(archivo);
        }
    });
    
    function subirLogo() {
        const archivo = document.getElementById('logo_tienda').files[0];
        
        if (!archivo) {
            alert('⚠️ Por favor selecciona un archivo de imagen');
            return;
        }
        
        const btn = document.getElementById('subirLogoBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
        btn.disabled = true;
        
        const formData = new FormData();
        formData.append('logo', archivo);
        
        fetch('/api/configuracion/logo', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Logo actualizado exitosamente');
                actualizarVistaPreviaLogo(data.logo_url);
                document.getElementById('logo_tienda').value = '';
            } else {
                alert('❌ Error al subir logo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al subir logo');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function eliminarLogo() {
        if (!confirm('¿Estás seguro de que quieres eliminar el logo actual?')) {
            return;
        }
        
        const btn = document.getElementById('eliminarLogoBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
        btn.disabled = true;
        
        fetch('/api/configuracion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                nombre_tienda: document.getElementById('nombre_tienda').value,
                descripcion_tienda: document.getElementById('descripcion_tienda').value,
                whatsapp_admin: document.getElementById('whatsapp_admin').value,
                logo_url: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Logo eliminado exitosamente');
                actualizarVistaPreviaLogo('');
            } else {
                alert('❌ Error al eliminar logo: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al eliminar logo');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function actualizarVistaPreviaLogo(logoUrl) {
        const previewDiv = document.getElementById('preview_logo');
        const eliminarBtn = document.getElementById('eliminarLogoBtn');
        
        if (logoUrl) {
            previewDiv.innerHTML = `<img src="${logoUrl}" alt="Logo" style="max-width: 100%; max-height: 60px; object-fit: contain;">`;
            eliminarBtn.style.display = 'inline-block';
        } else {
            previewDiv.innerHTML = '<i class="fas fa-image text-muted fa-2x"></i><span class="text-muted ms-2">Sin logo</span>';
            eliminarBtn.style.display = 'none';
        }
    }
    
    function mostrarVistaPreviaArchivo(dataUrl) {
        const previewDiv = document.getElementById('preview_logo');
        previewDiv.innerHTML = `<img src="${dataUrl}" alt="Vista previa" style="max-width: 100%; max-height: 60px; object-fit: contain;">`;
    }
    
    // ===== FUNCIONES DEL BANNER =====
    
    // ===== GESTIÓN DE MÚLTIPLES BANNERS =====
    
    // Cargar banners al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        cargarBanners();
    });
    
    // Event listeners para múltiples banners
    document.getElementById('crearBannerBtn').addEventListener('click', function() {
        crearBanner();
    });
    
    // Vista previa del archivo seleccionado en el modal
    document.getElementById('banner_imagen_nueva').addEventListener('change', function() {
        const archivo = this.files[0];
        if (archivo) {
            // Validar tamaño (máx. 5MB)
            if (archivo.size > 5 * 1024 * 1024) {
                alert('⚠️ El archivo es demasiado grande. Máximo 5MB permitido.');
                this.value = '';
                return;
            }
            
            // Validar tipo de archivo
            const tiposPermitidos = ['image/png', 'image/jpg', 'image/jpeg', 'image/gif', 'image/webp'];
            if (!tiposPermitidos.includes(archivo.type)) {
                alert('⚠️ Formato de archivo no permitido. Use PNG, JPG, JPEG, GIF o WEBP.');
                this.value = '';
                return;
            }
            
            // Mostrar vista previa
            const reader = new FileReader();
            reader.onload = function(e) {
                mostrarVistaPreviaNuevoBanner(e.target.result);
            };
            reader.readAsDataURL(archivo);
        }
    });
    
    function cargarBanners() {
        fetch('/api/banners')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarBanners(data.banners);
            } else {
                console.error('Error al cargar banners:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    function mostrarBanners(banners) {
        const bannersList = document.getElementById('bannersList');
        const noBannersMessage = document.getElementById('noBannersMessage');
        
        if (banners.length === 0) {
            bannersList.innerHTML = '';
            noBannersMessage.style.display = 'block';
            return;
        }
        
        noBannersMessage.style.display = 'none';
        bannersList.innerHTML = banners.map(banner => `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${banner.nombre}</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="banner_activo_${banner.id}" 
                                       ${banner.activo ? 'checked' : ''} onchange="toggleBanner(${banner.id}, this.checked)">
                            </div>
                        </div>
                        <div class="text-center mb-3">
                            <img src="${banner.imagen_url}" alt="${banner.nombre}" 
                                 class="img-fluid rounded" style="max-height: 120px; object-fit: cover;">
                        </div>
                        ${banner.texto ? `<p class="card-text small text-muted">"${banner.texto}"</p>` : ''}
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Orden: ${banner.orden}</small>
                            <div>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarBanner(${banner.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    function crearBanner() {
        const nombre = document.getElementById('banner_nombre').value.trim();
        const texto = document.getElementById('banner_texto').value.trim();
        const archivo = document.getElementById('banner_imagen_nueva').files[0];
        
        if (!nombre) {
            alert('⚠️ El nombre del banner es obligatorio');
            return;
        }
        
        if (!archivo) {
            alert('⚠️ Por favor selecciona una imagen');
            return;
        }
        
        const btn = document.getElementById('crearBannerBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
        btn.disabled = true;
        
        const formData = new FormData();
        formData.append('imagen', archivo);
        formData.append('nombre', nombre);
        formData.append('texto', texto);
        
        fetch('/api/banners', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Banner creado exitosamente');
                // Cerrar modal y limpiar formulario
                const modal = bootstrap.Modal.getInstance(document.getElementById('nuevoBannerModal'));
                modal.hide();
                limpiarFormularioBanner();
                cargarBanners(); // Recargar la lista
            } else {
                alert('❌ Error al crear banner: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al crear banner');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function toggleBanner(bannerId, activo) {
        fetch(`/api/banners/${bannerId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ activo: activo })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar la lista
                cargarBanners();
            } else {
                alert('❌ Error al actualizar banner: ' + data.error);
                // Revertir el checkbox
                document.getElementById(`banner_activo_${bannerId}`).checked = !activo;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al actualizar banner');
            // Revertir el checkbox
            document.getElementById(`banner_activo_${bannerId}`).checked = !activo;
        });
    }
    
    function eliminarBanner(bannerId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este banner?')) {
            return;
        }
        
        fetch(`/api/banners/${bannerId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Banner eliminado exitosamente');
                cargarBanners(); // Recargar la lista
            } else {
                alert('❌ Error al eliminar banner: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al eliminar banner');
        });
    }
    
    function mostrarVistaPreviaNuevoBanner(dataUrl) {
        const previewDiv = document.getElementById('preview_nuevo_banner');
        const bannerText = document.getElementById('banner_texto').value;
        previewDiv.innerHTML = `
            <div class="w-100">
                <img src="${dataUrl}" alt="Vista previa" style="max-width: 100%; max-height: 120px; object-fit: cover; border-radius: 4px;">
                ${bannerText ? `<p class="mt-2 mb-0 small text-muted">"${bannerText}"</p>` : ''}
            </div>
        `;
    }
    
    function limpiarFormularioBanner() {
        document.getElementById('banner_nombre').value = '';
        document.getElementById('banner_texto').value = '';
        document.getElementById('banner_imagen_nueva').value = '';
        document.getElementById('preview_nuevo_banner').innerHTML = `
            <div class="text-center">
                <i class="fas fa-image text-muted fa-3x"></i>
                <p class="text-muted mt-2">Selecciona una imagen</p>
            </div>
        `;
    }
    
    // ===== GESTIÓN DE COLORES =====
    
    // Event listeners para colores
    document.getElementById('guardarColoresBtn').addEventListener('click', function() {
        guardarColores();
    });
    
    document.getElementById('restaurarColoresBtn').addEventListener('click', function() {
        restaurarColoresDefault();
    });
    
    // Sincronizar inputs de color con inputs de texto
    const colorInputs = document.querySelectorAll('input[type="color"]');
    colorInputs.forEach(input => {
        input.addEventListener('input', function() {
            const textInput = document.getElementById(this.id + '_text');
            if (textInput) {
                textInput.value = this.value;
            }
        });
    });
    
    function cargarColores() {
        fetch('/api/configuracion/colores')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const colores = data.colores;
                
                // Actualizar todos los inputs de color
                Object.keys(colores).forEach(colorKey => {
                    const colorInput = document.getElementById(colorKey);
                    const textInput = document.getElementById(colorKey + '_text');
                    
                    if (colorInput && textInput) {
                        colorInput.value = colores[colorKey];
                        textInput.value = colores[colorKey];
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error al cargar colores:', error);
        });
    }
    
    function guardarColores() {
        const colores = {};
        const colorInputs = document.querySelectorAll('input[type="color"]');
        
        colorInputs.forEach(input => {
            colores[input.id] = input.value;
        });
        
        const btn = document.getElementById('guardarColoresBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        fetch('/api/configuracion/colores', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(colores)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Colores guardados exitosamente');
                // Recargar la página para aplicar los cambios
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('❌ Error al guardar colores: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al guardar colores');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function restaurarColoresDefault() {
        if (!confirm('¿Estás seguro de que quieres restaurar los colores por defecto?')) {
            return;
        }
        
        const coloresDefault = {
            'color_primario': '#007bff',
            'color_secundario': '#6c757d',
            'color_exito': '#28a745',
            'color_peligro': '#dc3545',
            'color_advertencia': '#ffc107',
            'color_info': '#17a2b8',
            'color_fondo': '#ffffff',
            'color_texto': '#333333',
            'color_fondo_secundario': '#f8f9fa',
            'color_borde': '#dee2e6'
        };
        
        // Actualizar los inputs
        Object.keys(coloresDefault).forEach(colorKey => {
            const colorInput = document.getElementById(colorKey);
            const textInput = document.getElementById(colorKey + '_text');
            
            if (colorInput && textInput) {
                colorInput.value = coloresDefault[colorKey];
                textInput.value = coloresDefault[colorKey];
            }
        });
        
        alert('✅ Colores restaurados por defecto. Haz clic en "Guardar Colores" para aplicar los cambios.');
    }
    
    // ===== CAMBIO DE CONTRASEÑA =====
    
    // Event listeners para cambio de contraseña
    document.getElementById('cambiarPasswordBtn').addEventListener('click', function() {
        cambiarPassword();
    });
    
    document.getElementById('limpiarPasswordBtn').addEventListener('click', function() {
        limpiarFormularioPassword();
    });
    
    // Validación de contraseña en tiempo real
    document.getElementById('password_nueva').addEventListener('input', function() {
        validarSeguridadPassword(this.value);
    });
    
    document.getElementById('password_confirmar').addEventListener('input', function() {
        validarConfirmacionPassword();
    });
    
    function cambiarPassword() {
        const passwordActual = document.getElementById('password_actual').value.trim();
        const passwordNueva = document.getElementById('password_nueva').value.trim();
        const passwordConfirmar = document.getElementById('password_confirmar').value.trim();
        
        // Validaciones del lado del cliente
        if (!passwordActual) {
            alert('⚠️ La contraseña actual es obligatoria');
            return;
        }
        
        if (!passwordNueva) {
            alert('⚠️ La nueva contraseña es obligatoria');
            return;
        }
        
        if (passwordNueva.length < 6) {
            alert('⚠️ La nueva contraseña debe tener al menos 6 caracteres');
            return;
        }
        
        if (passwordNueva !== passwordConfirmar) {
            alert('⚠️ Las contraseñas nuevas no coinciden');
            return;
        }
        
        // Confirmar cambio
        const confirmacion = confirm('¿Estás seguro de que quieres cambiar tu contraseña?\n\n⚠️ Esta acción no se puede deshacer.');
        if (!confirmacion) return;
        
        const btn = document.getElementById('cambiarPasswordBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando...';
        btn.disabled = true;
        
        const data = {
            password_actual: passwordActual,
            password_nueva: passwordNueva,
            password_confirmar: passwordConfirmar
        };
        
        fetch('/api/cambiar-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Contraseña cambiada exitosamente');
                limpiarFormularioPassword();
            } else {
                alert('❌ Error al cambiar contraseña: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al cambiar contraseña');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function limpiarFormularioPassword() {
        document.getElementById('password_actual').value = '';
        document.getElementById('password_nueva').value = '';
        document.getElementById('password_confirmar').value = '';
        document.getElementById('password-strength').innerHTML = '<i class="fas fa-info-circle"></i> Ingresa una nueva contraseña';
        document.getElementById('password-strength').className = 'text-muted';
    }
    
    function validarSeguridadPassword(password) {
        const strengthDiv = document.getElementById('password-strength');
        let strength = 0;
        let message = '';
        let className = '';
        
        if (password.length === 0) {
            message = '<i class="fas fa-info-circle"></i> Ingresa una nueva contraseña';
            className = 'text-muted';
        } else if (password.length < 6) {
            message = '<i class="fas fa-exclamation-triangle"></i> Muy débil (mínimo 6 caracteres)';
            className = 'text-danger';
        } else {
            strength = 1;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            switch (strength) {
                case 1:
                    message = '<i class="fas fa-exclamation-triangle"></i> Débil';
                    className = 'text-warning';
                    break;
                case 2:
                    message = '<i class="fas fa-shield-alt"></i> Regular';
                    className = 'text-info';
                    break;
                case 3:
                    message = '<i class="fas fa-shield-alt"></i> Buena';
                    className = 'text-primary';
                    break;
                case 4:
                case 5:
                    message = '<i class="fas fa-shield-alt"></i> Muy fuerte';
                    className = 'text-success';
                    break;
            }
        }
        
        strengthDiv.innerHTML = message;
        strengthDiv.className = className;
    }
    
    function validarConfirmacionPassword() {
        const passwordNueva = document.getElementById('password_nueva').value;
        const passwordConfirmar = document.getElementById('password_confirmar').value;
        
        if (passwordConfirmar.length > 0) {
            if (passwordNueva === passwordConfirmar) {
                document.getElementById('password_confirmar').className = 'form-control is-valid';
            } else {
                document.getElementById('password_confirmar').className = 'form-control is-invalid';
            }
        } else {
            document.getElementById('password_confirmar').className = 'form-control';
        }
    }
    
    // ===== ACTUALIZACIÓN RÁPIDA DE ESTADO DE PEDIDOS =====
    
    function actualizarEstado(pedidoId, nuevoEstado) {
        // Actualizar la interfaz inmediatamente (optimistic update)
        actualizarInterfazEstado(pedidoId, nuevoEstado);
        
        // Enviar la petición al servidor en segundo plano
        fetch(`/api/pedido/${pedidoId}/estado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // Si hay error, revertir el cambio
                console.error('Error al actualizar estado:', data.error);
                // Aquí podrías revertir el cambio o mostrar un mensaje de error
                alert('Error al actualizar el estado del pedido: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // En caso de error de red, también podrías revertir el cambio
            alert('Error de conexión al actualizar el estado');
        });
    }
    
    function actualizarInterfazEstado(pedidoId, nuevoEstado) {
        // Buscar la tarjeta del pedido
        const card = document.querySelector(`[data-pedido-id="${pedidoId}"]`);
        if (!card) return;
        
        // Actualizar el badge de estado
        const badge = card.querySelector('.badge');
        if (badge) {
            badge.className = 'badge';
            badge.textContent = nuevoEstado.charAt(0).toUpperCase() + nuevoEstado.slice(1);
            
            // Aplicar color según el estado
            switch (nuevoEstado) {
                case 'pendiente':
                    badge.classList.add('bg-warning');
                    break;
                case 'confirmado':
                    badge.classList.add('bg-info');
                    break;
                case 'entregado':
                    badge.classList.add('bg-success');
                    break;
                default:
                    badge.classList.add('bg-secondary');
            }
        }
        
        // Actualizar el select para que mantenga el valor seleccionado
        const select = card.querySelector('select');
        if (select) {
            select.value = nuevoEstado;
        }
    }
    
    // ===== ACTUALIZAR PANEL DEL ADMINISTRADOR =====
    
    document.getElementById('actualizarPanelBtn').addEventListener('click', function() {
        actualizarPanel();
    });
    
    function actualizarPanel() {
        const btn = document.getElementById('actualizarPanelBtn');
        const originalHTML = btn.innerHTML;
        
        // Mostrar indicador de carga
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
        btn.disabled = true;
        
        // Simular un pequeño delay para mostrar la animación
        setTimeout(() => {
            // Recargar la página para obtener datos actualizados
            window.location.reload();
        }, 500);
    }
    
    // ===== GESTIÓN DE CATEGORÍAS =====
    
    // Event listeners para el modal de categorías
    document.getElementById('guardarCategoriaBtn').addEventListener('click', function() {
        guardarCategoria();
    });
    
    // Vista previa en tiempo real
    document.getElementById('categoria_nombre').addEventListener('input', function() {
        const nombre = this.value || 'Nombre de la categoría';
        document.getElementById('preview_nombre').textContent = nombre;
    });
    
    document.getElementById('categoria_icono').addEventListener('change', function() {
        const icono = this.value;
        const previewIcono = document.getElementById('preview_icono');
        previewIcono.className = icono + ' me-2';
    });
    
    document.getElementById('categoria_color').addEventListener('input', function() {
        const color = this.value;
        document.getElementById('preview_icono').style.color = color;
        document.getElementById('preview_badge').style.backgroundColor = color;
    });
    
    function nuevaCategoria() {
        // Limpiar formulario
        document.getElementById('categoriaForm').reset();
        document.getElementById('categoria_id').value = '';
        document.getElementById('categoria_activa').checked = true;
        
        // Actualizar título del modal
        document.getElementById('categoriaModalTitle').innerHTML = '<i class="fas fa-tag"></i> Nueva Categoría';
        document.getElementById('guardarCategoriaBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Categoría';
        
        // Actualizar vista previa
        actualizarVistaPreviaCategoria();
    }
    
    function editarCategoria(id, nombre, descripcion, icono, color, activa) {
        // Llenar formulario con datos de la categoría
        document.getElementById('categoria_id').value = id;
        document.getElementById('categoria_nombre').value = nombre;
        document.getElementById('categoria_descripcion').value = descripcion || '';
        document.getElementById('categoria_icono').value = icono;
        document.getElementById('categoria_color').value = color;
        document.getElementById('categoria_activa').checked = activa;
        
        // Actualizar título del modal
        document.getElementById('categoriaModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Categoría';
        document.getElementById('guardarCategoriaBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Categoría';
        
        // Actualizar vista previa
        actualizarVistaPreviaCategoria();
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('categoriaModal'));
        modal.show();
    }
    
    function actualizarVistaPreviaCategoria() {
        const nombre = document.getElementById('categoria_nombre').value || 'Nombre de la categoría';
        const icono = document.getElementById('categoria_icono').value;
        const color = document.getElementById('categoria_color').value;
        
        document.getElementById('preview_nombre').textContent = nombre;
        document.getElementById('preview_icono').className = icono + ' me-2';
        document.getElementById('preview_icono').style.color = color;
        document.getElementById('preview_badge').style.backgroundColor = color;
    }
    
    function guardarCategoria() {
        const categoriaId = document.getElementById('categoria_id').value;
        const nombre = document.getElementById('categoria_nombre').value.trim();
        const descripcion = document.getElementById('categoria_descripcion').value.trim();
        const icono = document.getElementById('categoria_icono').value;
        const color = document.getElementById('categoria_color').value;
        const activa = document.getElementById('categoria_activa').checked;
        
        // Validaciones
        if (!nombre) {
            alert('⚠️ El nombre de la categoría es obligatorio');
            return;
        }
        
        const btn = document.getElementById('guardarCategoriaBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        const data = {
            nombre: nombre,
            descripcion: descripcion,
            icono: icono,
            color: color,
            activa: activa
        };
        
        const url = categoriaId ? `/api/categoria/${categoriaId}` : '/api/categoria';
        const method = categoriaId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.mensaje);
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('categoriaModal'));
                modal.hide();
                // Recargar página para mostrar cambios
                location.reload();
            } else {
                alert('❌ Error: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al guardar la categoría');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function eliminarCategoria(categoriaId, nombre) {
        const confirmacion = confirm(`¿Estás seguro de que quieres eliminar la categoría "${nombre}"?\n\n⚠️ Esta acción no se puede deshacer.`);
        if (!confirmacion) return;
        
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        fetch(`/api/categoria/${categoriaId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.mensaje);
                location.reload();
            } else {
                alert('❌ Error: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error al eliminar la categoría');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // ===== SISTEMA RESPONSIVO =====
    
    // Sincronizar tabs móviles y de escritorio
    function sincronizarTabs() {
        // Event listeners para tabs de escritorio
        document.querySelectorAll('#adminTabs .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                const targetId = e.target.getAttribute('data-bs-target');
                // Activar el tab móvil correspondiente
                const mobileTab = document.querySelector(`#${e.target.id}-mobile`);
                if (mobileTab) {
                    mobileTab.classList.add('active');
                    // Remover active de otros tabs móviles
                    document.querySelectorAll('#mobileMenu .btn').forEach(btn => {
                        if (btn !== mobileTab) btn.classList.remove('active');
                    });
                }
            });
        });
        
        // Event listeners para tabs móviles
        document.querySelectorAll('#mobileMenu .btn').forEach(tab => {
            tab.addEventListener('click', function(e) {
                const targetId = e.target.getAttribute('data-bs-target');
                // Activar el tab de escritorio correspondiente
                const desktopTab = document.querySelector(`#${e.target.id.replace('-mobile', '')}`);
                if (desktopTab) {
                    desktopTab.click();
                }
                // Cerrar menú móvil después de seleccionar
                const mobileMenu = document.getElementById('mobileMenu');
                if (mobileMenu) {
                    const bsCollapse = new bootstrap.Collapse(mobileMenu, {toggle: false});
                    bsCollapse.hide();
                }
            });
        });
    }
    
    // Mejorar experiencia táctil
    function mejorarExperienciaTactil() {
        // Aumentar área de toque para botones pequeños
        document.querySelectorAll('.btn-sm').forEach(btn => {
            btn.style.minHeight = '44px'; // Tamaño mínimo recomendado para touch
        });
        
        // Mejorar selectores
        document.querySelectorAll('.form-select').forEach(select => {
            select.style.minHeight = '44px';
        });
        
        // Mejorar inputs
        document.querySelectorAll('.form-control').forEach(input => {
            input.style.minHeight = '44px';
        });
    }
    
    // ===== SISTEMA DE NOTIFICACIONES =====
    
    let notificacionesActivas = true;
    let ultimoContadorPedidos = 0;
    let intervaloNotificaciones = null;
    
    // Función para cambiar de tab
    function cambiarTab(tabName) {
        const tabButton = document.querySelector(`#${tabName}-tab`);
        if (tabButton) {
            tabButton.click();
        }
    }
    
    // Función para ocultar notificación
    function ocultarNotificacion() {
        const alert = document.getElementById('pedidosAlert');
        alert.classList.add('d-none');
    }
    
    // Función para reproducir sonido de notificación
    function reproducirSonidoNotificacion() {
        if (!notificacionesActivas) return;
        
        try {
            // Crear un sonido de notificación más audible y llamativo
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Crear múltiples tonos para un sonido más llamativo
            const tonos = [
                { frecuencia: 800, duracion: 0.2 },
                { frecuencia: 1000, duracion: 0.2 },
                { frecuencia: 1200, duracion: 0.3 }
            ];
            
            let tiempoInicio = audioContext.currentTime;
            
            tonos.forEach((tono, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(tono.frecuencia, tiempoInicio);
                
                // Volumen más alto para ser más audible
                gainNode.gain.setValueAtTime(0.5, tiempoInicio);
                gainNode.gain.exponentialRampToValueAtTime(0.01, tiempoInicio + tono.duracion);
                
                oscillator.start(tiempoInicio);
                oscillator.stop(tiempoInicio + tono.duracion);
                
                // Pausa entre tonos
                tiempoInicio += tono.duracion + 0.1;
            });
            
            console.log('🔔 Sonido de notificación reproducido');
        } catch (error) {
            console.log('No se pudo reproducir el sonido de notificación:', error);
            
            // Fallback: usar el sonido del sistema si está disponible
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.volume = 0.7;
                audio.play().catch(e => console.log('No se pudo reproducir audio de fallback:', e));
            } catch (fallbackError) {
                console.log('No se pudo usar el fallback de audio:', fallbackError);
            }
        }
    }
    
    // Variables para detectar visibilidad de la página
    let paginaVisible = true;
    let ultimaVerificacion = Date.now();
    
    // Detectar cuando la página está visible o en segundo plano
    document.addEventListener('visibilitychange', function() {
        paginaVisible = !document.hidden;
        if (paginaVisible) {
            console.log('📱 Página visible - verificando pedidos pendientes');
            // Verificar inmediatamente cuando la página vuelve a ser visible
            actualizarNotificaciones();
        } else {
            console.log('📱 Página en segundo plano - notificaciones seguirán funcionando');
        }
    });
    
    // Función para actualizar notificaciones
    function actualizarNotificaciones() {
        if (!notificacionesActivas) return;
        
        fetch('/api/notificaciones/pedidos')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const totalPendientes = data.total_pendientes;
                    const pedidosBadge = document.getElementById('pedidosBadge');
                    const pedidosAlert = document.getElementById('pedidosAlert');
                    const pedidosCount = document.getElementById('pedidosCount');
                    const ultimoPedidoInfo = document.getElementById('ultimoPedidoInfo');
                    
                    // Actualizar badge del botón de pedidos (escritorio)
                    if (totalPendientes > 0) {
                        pedidosBadge.textContent = totalPendientes;
                        pedidosBadge.classList.remove('d-none');
                    } else {
                        pedidosBadge.classList.add('d-none');
                    }
                    
                    // Actualizar badge del botón de pedidos (móvil)
                    const pedidosBadgeMobile = document.getElementById('pedidosBadgeMobile');
                    if (pedidosBadgeMobile) {
                        if (totalPendientes > 0) {
                            pedidosBadgeMobile.textContent = totalPendientes;
                            pedidosBadgeMobile.classList.remove('d-none');
                        } else {
                            pedidosBadgeMobile.classList.add('d-none');
                        }
                    }
                    
                    // Mostrar alerta si hay pedidos pendientes
                    if (totalPendientes > 0) {
                        pedidosCount.textContent = totalPendientes;
                        
                        // Mostrar información del último pedido
                        if (data.ultimo_pedido) {
                            const fecha = new Date(data.ultimo_pedido.fecha_pedido);
                            const hora = fecha.toLocaleTimeString('es-ES', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: true
                            });
                            ultimoPedidoInfo.textContent = `Último pedido: #${data.ultimo_pedido.id} - ${data.ultimo_pedido.cliente_nombre} (${hora})`;
                        }
                        
                        pedidosAlert.classList.remove('d-none');
                        
                        // Reproducir sonido si hay nuevos pedidos
                        if (totalPendientes > ultimoContadorPedidos) {
                            console.log(`🔔 Nuevo pedido detectado! Total: ${totalPendientes}, Anterior: ${ultimoContadorPedidos}`);
                            
                            // Reproducir sonido inmediatamente
                            setTimeout(() => {
                                reproducirSonidoNotificacion();
                            }, 100);
                            
                            // Mostrar notificación del navegador si está disponible
                            if ('Notification' in window && Notification.permission === 'granted') {
                                // Crear notificación más detallada
                                const notificacion = new Notification('🛒 Nuevo Pedido Recibido', {
                                    body: `Pedido #${data.ultimo_pedido.id} de ${data.ultimo_pedido.cliente_nombre}\nTotal: S/${data.ultimo_pedido.total}\nHaz clic para ver detalles`,
                                    icon: '/static/favicon.ico',
                                    tag: 'nuevo-pedido',
                                    requireInteraction: true, // Mantener la notificación hasta que el usuario la cierre
                                    badge: '/static/favicon.ico'
                                });
                                
                                // Agregar evento de clic para abrir la página
                                notificacion.onclick = function() {
                                    window.focus();
                                    // Cambiar a la pestaña de pedidos
                                    const pedidosTab = document.getElementById('pedidos-tab');
                                    if (pedidosTab) {
                                        pedidosTab.click();
                                    }
                                    notificacion.close();
                                };
                                
                                // Cerrar automáticamente después de 10 segundos
                                setTimeout(() => {
                                    notificacion.close();
                                }, 10000);
                            }
                            
                            // Hacer parpadear la pestaña si no está activa
                            if (document.hidden) {
                                document.title = '🔔 NUEVO PEDIDO - Panel Admin';
                                setTimeout(() => {
                                    document.title = 'Panel de Administración - Mi Tienda Online';
                                }, 5000);
                            }
                        }
                    } else {
                        pedidosAlert.classList.add('d-none');
                    }
                    
                    ultimoContadorPedidos = totalPendientes;
                }
            })
            .catch(error => {
                console.error('Error al obtener notificaciones:', error);
            });
    }
    
    // Función para activar/desactivar notificaciones
    function toggleNotificaciones() {
        notificacionesActivas = !notificacionesActivas;
        const icon = document.getElementById('notificationIcon');
        const btn = document.getElementById('toggleNotificationsBtn');
        
        if (notificacionesActivas) {
            icon.className = 'fas fa-bell';
            btn.className = 'btn btn-outline-info';
            btn.title = 'Desactivar notificaciones';
            
            // Iniciar polling
            if (!intervaloNotificaciones) {
                actualizarNotificaciones();
                intervaloNotificaciones = setInterval(actualizarNotificaciones, 10000); // Cada 10 segundos
            }
        } else {
            icon.className = 'fas fa-bell-slash';
            btn.className = 'btn btn-outline-secondary';
            btn.title = 'Activar notificaciones';
            
            // Detener polling
            if (intervaloNotificaciones) {
                clearInterval(intervaloNotificaciones);
                intervaloNotificaciones = null;
            }
        }
    }
    
    // Event listeners para notificaciones
    document.getElementById('toggleNotificationsBtn').addEventListener('click', toggleNotificaciones);
    document.getElementById('testSoundBtn').addEventListener('click', function() {
        reproducirSonidoNotificacion();
        console.log('🔊 Probando sonido de notificación...');
    });
    
    // Event listener para configurar notificaciones del navegador
    document.getElementById('configNotificationsBtn').addEventListener('click', function() {
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                alert('✅ Las notificaciones del navegador ya están activadas.\n\nRecibirás notificaciones de nuevos pedidos incluso cuando no estés viendo la página.');
            } else if (Notification.permission === 'denied') {
                alert('❌ Las notificaciones del navegador están bloqueadas.\n\nPara activarlas:\n1. Haz clic en el ícono de candado en la barra de direcciones\n2. Selecciona "Permitir" en notificaciones\n3. Recarga la página');
            } else {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        alert('✅ ¡Notificaciones activadas!\n\nAhora recibirás notificaciones de nuevos pedidos incluso cuando no estés viendo la página.');
                        mostrarNotificacionPrueba();
                    } else {
                        alert('❌ Permisos de notificación denegados.\n\nLas notificaciones del navegador no funcionarán.');
                    }
                });
            }
        } else {
            alert('❌ Tu navegador no soporta notificaciones del sistema.\n\nUsa Chrome, Firefox o Edge para una mejor experiencia.');
        }
    });
    
    // Función para solicitar permisos de notificación
    function solicitarPermisosNotificacion() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        console.log('✅ Permisos de notificación concedidos');
                        mostrarNotificacionPrueba();
                    } else {
                        console.log('❌ Permisos de notificación denegados');
                    }
                });
            } else if (Notification.permission === 'granted') {
                console.log('✅ Permisos de notificación ya concedidos');
            } else {
                console.log('❌ Permisos de notificación denegados');
            }
        } else {
            console.log('❌ Este navegador no soporta notificaciones');
        }
    }
    
    // Función para mostrar notificación de prueba
    function mostrarNotificacionPrueba() {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('🔔 Notificaciones Activadas', {
                body: 'Ahora recibirás notificaciones de nuevos pedidos',
                icon: '/static/favicon.ico',
                tag: 'configuracion'
            });
        }
    }
    
    // Solicitar permisos automáticamente al cargar la página
    solicitarPermisosNotificacion();
    
    // Inicializar notificaciones al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar funciones responsivas
        sincronizarTabs();
        mejorarExperienciaTactil();
        
        // Esperar un poco antes de iniciar las notificaciones
        setTimeout(() => {
            // Cargar el estado inicial sin reproducir sonido
            fetch('/api/notificaciones/pedidos')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        ultimoContadorPedidos = data.total_pendientes;
                        console.log(`📊 Estado inicial: ${ultimoContadorPedidos} pedidos pendientes`);
                    }
                })
                .catch(error => {
                    console.error('Error al obtener estado inicial:', error);
                });
            
            // Iniciar el polling
            if (notificacionesActivas) {
                intervaloNotificaciones = setInterval(actualizarNotificaciones, 10000); // Cada 10 segundos
            }
        }, 2000);
    });
    
    // Actualizar notificaciones cuando se cambia de tab a pedidos
    document.getElementById('pedidos-tab').addEventListener('click', function() {
        setTimeout(actualizarNotificaciones, 500);
    });
    
    // ===== FUNCIONES DE EXPORTAR/IMPORTAR PRODUCTOS =====
    
    function exportarProductos() {
        // Mostrar indicador de carga
        const btnExportar = event.target.closest('button');
        const textoOriginal = btnExportar.innerHTML;
        btnExportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando...';
        btnExportar.disabled = true;
        
        fetch('/api/productos/exportar')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al exportar productos');
                }
                return response.blob();
            })
            .then(blob => {
                // Crear enlace de descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `productos_exportados_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Mostrar mensaje de éxito
                mostrarNotificacion('✅ Productos exportados exitosamente', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarNotificacion('❌ Error al exportar productos: ' + error.message, 'error');
            })
            .finally(() => {
                // Restaurar botón
                btnExportar.innerHTML = textoOriginal;
                btnExportar.disabled = false;
            });
    }
    
    function importarProductos(input) {
        const archivo = input.files[0];
        if (!archivo) return;
        
        // Validar tipo de archivo
        if (!archivo.name.toLowerCase().endsWith('.txt')) {
            mostrarNotificacion('❌ Por favor selecciona un archivo de texto (.txt)', 'error');
            input.value = '';
            return;
        }
        
        // Confirmar importación
        const confirmacion = confirm(`¿Estás seguro de que quieres importar productos desde "${archivo.name}"?\n\nEsto puede actualizar productos existentes y crear nuevos productos.`);
        if (!confirmacion) {
            input.value = '';
            return;
        }
        
        // Mostrar indicador de carga
        const btnImportar = document.querySelector('button[onclick*="importarArchivo"]');
        const textoOriginal = btnImportar.innerHTML;
        btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
        btnImportar.disabled = true;
        
        const formData = new FormData();
        formData.append('archivo', archivo);
        
        fetch('/api/productos/importar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const detalles = data.detalles;
                let mensaje = `✅ Importación completada exitosamente!\n\n`;
                mensaje += `📦 Productos importados: ${detalles.productos_importados}\n`;
                mensaje += `🔄 Productos actualizados: ${detalles.productos_actualizados}\n`;
                mensaje += `🏷️ Categorías creadas: ${detalles.categorias_creadas}\n`;
                mensaje += `❌ Errores: ${detalles.errores}`;
                
                if (detalles.lista_errores && detalles.lista_errores.length > 0) {
                    mensaje += `\n\nErrores encontrados:\n${detalles.lista_errores.join('\n')}`;
                }
                
                mostrarNotificacion(mensaje, 'success');
                
                // Recargar la lista de productos
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                mostrarNotificacion('❌ Error al importar productos: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('❌ Error al importar productos: ' + error.message, 'error');
        })
        .finally(() => {
            // Restaurar botón y limpiar input
            btnImportar.innerHTML = textoOriginal;
            btnImportar.disabled = false;
            input.value = '';
        });
    }
    
    function mostrarNotificacion(mensaje, tipo = 'info') {
        // Crear elemento de notificación
        const notificacion = document.createElement('div');
        notificacion.className = `alert alert-${tipo === 'error' ? 'danger' : tipo} alert-dismissible fade show position-fixed`;
        notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px; white-space: pre-line;';
        notificacion.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notificacion);
        
        // Auto-remover después de 5 segundos
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}
