{% extends "base.html" %}

{% block title %}Administraci√≥n - Mi Tienda Online{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-cogs"></i> Panel de Administraci√≥n
        </h1>
    </div>
</div>

<!-- Tabs de navegaci√≥n -->
<ul class="nav nav-tabs" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button" role="tab">
            <i class="fas fa-box"></i> Productos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos" type="button" role="tab">
            <i class="fas fa-shopping-cart"></i> Pedidos
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="categorias-tab" data-bs-toggle="tab" data-bs-target="#categorias" type="button" role="tab">
            <i class="fas fa-tags"></i> Categor√≠as
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="configuracion-tab" data-bs-toggle="tab" data-bs-target="#configuracion" type="button" role="tab">
            <i class="fas fa-cog"></i> Configuraci√≥n
        </button>
    </li>
</ul>

<!-- Barra de notificaciones y controles -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Notificaciones de pedidos -->
    <div class="notifications-container">
        <div class="alert alert-warning d-none" id="pedidosAlert" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-bell me-2"></i>
                <div>
                    <strong id="pedidosCount">0</strong> pedidos pendientes
                    <small class="d-block text-muted" id="ultimoPedidoInfo"></small>
                </div>
                <button type="button" class="btn-close ms-auto" onclick="ocultarNotificacion()"></button>
            </div>
        </div>
    </div>
    
    <!-- Controles del panel -->
    <div class="d-flex align-items-center gap-2">
        <!-- Contador de notificaciones en el bot√≥n de pedidos -->
        <div class="position-relative">
            <button class="btn btn-outline-primary" id="pedidos-tab-btn" onclick="cambiarTab('pedidos')" title="Ver pedidos">
                <i class="fas fa-shopping-cart"></i> Pedidos
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="pedidosBadge">
                    0
                </span>
            </button>
        </div>
        
        <!-- Bot√≥n de actualizar -->
        <button class="btn btn-outline-primary" id="actualizarPanelBtn" title="Actualizar panel del administrador">
            <i class="fas fa-sync-alt"></i> Actualizar Panel
        </button>
        
        <!-- Bot√≥n de notificaciones -->
        <button class="btn btn-outline-info" id="toggleNotificationsBtn" title="Activar/Desactivar notificaciones">
            <i class="fas fa-bell" id="notificationIcon"></i>
        </button>
        
        <!-- Bot√≥n para probar sonido -->
        <button class="btn btn-outline-success" id="testSoundBtn" title="Probar sonido de notificaci√≥n">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>
</div>

<div class="tab-content" id="adminTabsContent">
    <!-- Tab de Productos -->
    <div class="tab-pane fade show active" id="productos" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Gesti√≥n de Productos</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productoModal">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                </div>
                
                <div class="row">
                    {% for producto in productos %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-box text-primary"></i> {{ producto.nombre }}
                                </h6>
                                <span class="badge bg-secondary">#{{ producto.id }}</span>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Precio</small>
                                        <div class="fw-bold text-success">${{ "%.2f"|format(producto.precio) }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Stock</small>
                                        <div class="fw-bold text-info">{{ producto.stock }}</div>
                                    </div>
                                </div>
                                
                                {% if producto.descripcion %}
                                <div class="mb-3">
                                    <small class="text-muted">Descripci√≥n</small>
                                    <div class="small">{{ producto.descripcion[:50] }}{% if producto.descripcion|length > 50 %}...{% endif %}</div>
                                </div>
                                {% endif %}
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        {% if producto.activo %}
                                        <span class="badge bg-success" id="status-{{ producto.id }}">Activo</span>
                                        {% else %}
                                        <span class="badge bg-secondary" id="status-{{ producto.id }}">Inactivo</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if producto.activo %}
                                        <button class="btn btn-sm btn-outline-warning" onclick="toggleProductStatus({{ producto.id }}, false)" title="Desactivar producto">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-success" onclick="toggleProductStatus({{ producto.id }}, true)" title="Activar producto">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editarProducto({{ producto.id }}, '{{ producto.nombre|replace("'", "\\'") }}', '{{ producto.descripcion|replace("'", "\\'") if producto.descripcion else "" }}', {{ producto.precio }}, {{ producto.stock }}, '{{ producto.imagen if producto.imagen else "" }}', {{ producto.activo|lower }}, {{ producto.categoria_id if producto.categoria_id else 'null' }})" title="Editar producto">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarProducto({{ producto.id }})" title="Eliminar producto">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab de Pedidos -->
    <div class="tab-pane fade" id="pedidos" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <h3>Gesti√≥n de Pedidos</h3>
                
                <div class="row">
                    {% for pedido in pedidos %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm" data-pedido-id="{{ pedido.id }}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-shopping-cart text-primary"></i> Pedido #{{ pedido.id }}
                                </h6>
                                <small class="text-muted">{{ pedido.fecha_pedido.strftime('%d/%m/%Y') }}</small>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <small class="text-muted">Cliente</small>
                                        <div class="fw-bold">{{ pedido.cliente_nombre }}</div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Tel√©fono</small>
                                        <div class="small">{{ pedido.cliente_telefono }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Total</small>
                                        <div class="fw-bold text-success">${{ "%.2f"|format(pedido.total) }}</div>
                                    </div>
                                </div>
                                
                                {% if pedido.cliente_direccion %}
                                <div class="mb-3">
                                    <small class="text-muted">Direcci√≥n</small>
                                    <div class="small">{{ pedido.cliente_direccion[:40] }}{% if pedido.cliente_direccion|length > 40 %}...{% endif %}</div>
                                </div>
                                {% endif %}
                                
                                <div class="mb-3">
                                    <small class="text-muted">Estado</small>
                                    <div>
                                        <select class="form-select form-select-sm" onchange="actualizarEstado({{ pedido.id }}, this.value)">
                                            <option value="pendiente" {% if pedido.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                            <option value="confirmado" {% if pedido.estado == 'confirmado' %}selected{% endif %}>Confirmado</option>
                                            <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> {{ pedido.fecha_pedido.strftime('%H:%M') }}
                                    </small>
                                    <div>
                                        {% if pedido.estado == 'pendiente' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                        {% elif pedido.estado == 'confirmado' %}
                                        <span class="badge bg-info">Confirmado</span>
                                        {% elif pedido.estado == 'entregado' %}
                                        <span class="badge bg-success">Entregado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-info" onclick="verDetallePedido({{ pedido.id }}, '{{ pedido.cliente_nombre|replace("'", "\\'") }}', '{{ pedido.cliente_telefono|replace("'", "\\'") }}', '{{ pedido.cliente_direccion|replace("'", "\\'") }}', {{ pedido.total }}, '{{ pedido.estado }}', '{{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}', '{{ pedido.cliente_comentarios|replace("'", "\\'") if pedido.cliente_comentarios else "" }}')" title="Ver detalles del pedido">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarPedido({{ pedido.id }}, '{{ pedido.cliente_nombre|replace("'", "\\'") }}')" title="Eliminar pedido">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab de Categor√≠as -->
    <div class="tab-pane fade" id="categorias" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-tags"></i> Gesti√≥n de Categor√≠as</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoriaModal" onclick="nuevaCategoria()">
                        <i class="fas fa-plus"></i> Nueva Categor√≠a
                    </button>
                </div>
                
                <!-- Lista de Categor√≠as -->
                <div class="row" id="categorias-container">
                    <!-- Debug: Mostrar informaci√≥n de categor√≠as -->
                    <div class="col-12 mb-3">
                        <div class="alert alert-info">
                            <strong>Debug:</strong> Total de categor√≠as: {{ categorias|length }}
                            {% if categorias %}
                                <br>Categor√≠as encontradas: 
                                {% for cat in categorias %}
                                    {{ cat.nombre }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                <br>No hay categor√≠as en la base de datos
                            {% endif %}
                        </div>
                    </div>
                    
                    {% for categoria in categorias %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: {{ categoria.color }}20; border-left: 4px solid {{ categoria.color }};">
                                <h6 class="mb-0">
                                    <i class="{{ categoria.icono }}" style="color: {{ categoria.color }};"></i> {{ categoria.nombre }}
                                </h6>
                                <span class="badge bg-secondary">#{{ categoria.id }}</span>
                            </div>
                            <div class="card-body">
                                {% if categoria.descripcion %}
                                <p class="card-text text-muted">{{ categoria.descripcion }}</p>
                                {% endif %}
                                
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Productos</small>
                                        <div class="fw-bold text-info">{{ categoria.productos|length }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Estado</small>
                                        <div>
                                            {% if categoria.activa %}
                                            <span class="badge bg-success">Activa</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inactiva</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">Color</small>
                                    <div class="d-flex align-items-center">
                                        <div class="color-preview me-2" style="width: 20px; height: 20px; background-color: {{ categoria.color }}; border-radius: 50%;"></div>
                                        <span class="small">{{ categoria.color }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editarCategoria({{ categoria.id }}, '{{ categoria.nombre|replace("'", "\\'") }}', '{{ categoria.descripcion|replace("'", "\\'") if categoria.descripcion else "" }}', '{{ categoria.icono }}', '{{ categoria.color }}', {{ categoria.activa|lower }})" title="Editar categor√≠a">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="eliminarCategoria({{ categoria.id }}, '{{ categoria.nombre|replace("'", "\\'") }}')" title="Eliminar categor√≠a">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if not categorias %}
                <div class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-tags fa-4x text-muted mb-4"></i>
                        <h4>No hay categor√≠as</h4>
                        <p class="text-muted">Crea tu primera categor√≠a para organizar tus productos.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoriaModal" onclick="nuevaCategoria()">
                            <i class="fas fa-plus"></i> Crear Primera Categor√≠a
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tab de Configuraci√≥n -->
    <div class="tab-pane fade" id="configuracion" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <h3><i class="fas fa-cog"></i> Configuraci√≥n de la Tienda</h3>
                <p class="text-muted">Personaliza la informaci√≥n de tu tienda online</p>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-store"></i> Informaci√≥n General</h5>
                    </div>
                    <div class="card-body">
                        <form id="configuracionForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="nombre_tienda" class="form-label">
                                            <i class="fas fa-signature"></i> Nombre de la Tienda
                                        </label>
                                        <input type="text" class="form-control" id="nombre_tienda" 
                                               placeholder="Ej: Mi Tienda Online" maxlength="50">
                                        <div class="form-text">Este nombre aparecer√° en el encabezado de tu tienda</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Vista Previa</label>
                                        <div class="border rounded p-2 bg-light">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-store text-primary me-2"></i>
                                                <span id="preview_nombre" class="fw-bold">Mi Tienda Online</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="descripcion_tienda" class="form-label">
                                                <i class="fas fa-info-circle"></i> Descripci√≥n de la Tienda
                                            </label>
                                            <textarea class="form-control" id="descripcion_tienda" rows="3" 
                                                      placeholder="Describe brevemente tu tienda..." maxlength="200"></textarea>
                                            <div class="form-text">Descripci√≥n que aparecer√° en la p√°gina principal</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Vista Previa</label>
                                            <div class="border rounded p-2 bg-light">
                                                <small id="preview_descripcion" class="text-muted">Descripci√≥n de la tienda</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="whatsapp_admin" class="form-label">
                                                <i class="fab fa-whatsapp text-success"></i> WhatsApp del Administrador
                                            </label>
                                            <input type="tel" class="form-control" id="whatsapp_admin" 
                                                   placeholder="Ej: +51987654321" maxlength="20">
                                            <div class="form-text">N√∫mero de WhatsApp para que los clientes te contacten</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Vista Previa</label>
                                            <div class="border rounded p-2 bg-light">
                                                <div class="d-flex align-items-center">
                                                    <i class="fab fa-whatsapp text-success me-2"></i>
                                                    <span id="preview_whatsapp" class="text-muted">Sin WhatsApp configurado</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-primary" id="guardarConfiguracionBtn">
                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="restaurarConfiguracionBtn">
                                        <i class="fas fa-undo"></i> Restaurar Valores
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> √öltima actualizaci√≥n: <span id="ultima_actualizacion">-</span>
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-key"></i> Cambiar Contrase√±a</h5>
                    </div>
                    <div class="card-body">
                        <form id="cambiarPasswordForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_actual" class="form-label">
                                            <i class="fas fa-lock"></i> Contrase√±a Actual
                                        </label>
                                        <input type="password" class="form-control" id="password_actual" required>
                                        <div class="form-text">Ingresa tu contrase√±a actual para confirmar</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_nueva" class="form-label">
                                            <i class="fas fa-key"></i> Nueva Contrase√±a
                                        </label>
                                        <input type="password" class="form-control" id="password_nueva" required minlength="6">
                                        <div class="form-text">M√≠nimo 6 caracteres</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_confirmar" class="form-label">
                                            <i class="fas fa-check-circle"></i> Confirmar Nueva Contrase√±a
                                        </label>
                                        <input type="password" class="form-control" id="password_confirmar" required>
                                        <div class="form-text">Repite la nueva contrase√±a</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Seguridad de la Contrase√±a</label>
                                        <div class="border rounded p-2 bg-light">
                                            <div id="password-strength" class="text-muted">
                                                <i class="fas fa-info-circle"></i> Ingresa una nueva contrase√±a
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-warning" id="cambiarPasswordBtn">
                                        <i class="fas fa-key"></i> Cambiar Contrase√±a
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="limpiarPasswordBtn">
                                        <i class="fas fa-eraser"></i> Limpiar
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt"></i> Usuario actual: <strong>{{ current_user.username }}</strong>
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Informaci√≥n del Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Configuraciones Disponibles:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> Nombre de la tienda</li>
                                    <li><i class="fas fa-check text-success"></i> Descripci√≥n de la tienda</li>
                                    <li><i class="fas fa-clock text-warning"></i> Logo de la tienda (pr√≥ximamente)</li>
                                    <li><i class="fas fa-clock text-warning"></i> Colores personalizados (pr√≥ximamente)</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Estad√≠sticas:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-box"></i> Productos activos: <span class="badge bg-primary">{{ productos_activos }}</span></li>
                                    <li><i class="fas fa-shopping-cart"></i> Total pedidos: <span class="badge bg-success">{{ total_pedidos }}</span></li>
                                    <li><i class="fas fa-user"></i> Usuarios registrados: <span class="badge bg-info">{{ total_usuarios }}</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Producto -->
<div class="modal fade" id="productoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productoModalTitle">
                    <i class="fas fa-box"></i> Nuevo Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productoForm">
                    <input type="hidden" id="producto_id">
                    <div class="mb-3">
                        <label for="producto_nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="producto_nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="producto_descripcion" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="producto_descripcion" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="producto_precio" class="form-label">Precio *</label>
                        <input type="number" class="form-control" id="producto_precio" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="producto_stock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="producto_stock" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="producto_imagen" class="form-label">URL de Imagen</label>
                        <input type="url" class="form-control" id="producto_imagen">
                    </div>
                    <div class="mb-3">
                        <label for="producto_categoria" class="form-label">
                            <i class="fas fa-tags"></i> Categor√≠a
                        </label>
                        <select class="form-select" id="producto_categoria">
                            <option value="">Sin categor√≠a</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Selecciona la categor√≠a del producto</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="producto_activo" checked>
                            <label class="form-check-label" for="producto_activo">
                                Producto activo
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="guardarProductoBtn">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Categor√≠a -->
<div class="modal fade" id="categoriaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoriaModalTitle">
                    <i class="fas fa-tag"></i> Nueva Categor√≠a
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoriaForm">
                    <input type="hidden" id="categoria_id" name="categoria_id">
                    
                    <div class="mb-3">
                        <label for="categoria_nombre" class="form-label">
                            <i class="fas fa-tag"></i> Nombre de la Categor√≠a *
                        </label>
                        <input type="text" class="form-control" id="categoria_nombre" name="categoria_nombre" required maxlength="50">
                        <div class="form-text">Nombre √∫nico para la categor√≠a</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoria_descripcion" class="form-label">
                            <i class="fas fa-align-left"></i> Descripci√≥n
                        </label>
                        <textarea class="form-control" id="categoria_descripcion" name="categoria_descripcion" rows="3" maxlength="200"></textarea>
                        <div class="form-text">Descripci√≥n opcional de la categor√≠a</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria_icono" class="form-label">
                                    <i class="fas fa-icons"></i> Icono
                                </label>
                                <select class="form-select" id="categoria_icono" name="categoria_icono">
                                    <option value="fas fa-tag">üè∑Ô∏è Etiqueta</option>
                                    <option value="fas fa-utensils">üçΩÔ∏è Comida</option>
                                    <option value="fas fa-coffee">‚òï Bebidas</option>
                                    <option value="fas fa-ice-cream">üç¶ Postres</option>
                                    <option value="fas fa-laptop">üíª Servicios</option>
                                    <option value="fas fa-heart">‚ù§Ô∏è Salud</option>
                                    <option value="fas fa-car">üöó Transporte</option>
                                    <option value="fas fa-home">üè† Hogar</option>
                                    <option value="fas fa-gamepad">üéÆ Entretenimiento</option>
                                    <option value="fas fa-gift">üéÅ Regalos</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria_color" class="form-label">
                                    <i class="fas fa-palette"></i> Color
                                </label>
                                <input type="color" class="form-control form-control-color" id="categoria_color" name="categoria_color" value="#007bff">
                                <div class="form-text">Color de la categor√≠a</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="categoria_activa" name="categoria_activa" checked>
                            <label class="form-check-label" for="categoria_activa">
                                <i class="fas fa-eye"></i> Categor√≠a activa
                            </label>
                        </div>
                        <div class="form-text">Las categor√≠as inactivas no se mostrar√°n en la tienda</div>
                    </div>
                    
                    <!-- Vista previa -->
                    <div class="mb-3">
                        <label class="form-label">Vista Previa</label>
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center">
                                <i id="preview_icono" class="fas fa-tag me-2" style="color: #007bff;"></i>
                                <span id="preview_nombre" class="fw-bold">Nombre de la categor√≠a</span>
                            </div>
                            <div class="mt-2">
                                <span class="badge" id="preview_badge" style="background-color: #007bff;">Categor√≠a</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="guardarCategoriaBtn">
                    <i class="fas fa-save"></i> Guardar Categor√≠a
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalle de Pedido -->
<div class="modal fade" id="detallePedidoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt"></i> Detalle del Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallePedidoContent">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="confirmarPedidoBtn" onclick="abrirWhatsAppCliente()">
                    <i class="fab fa-whatsapp"></i> Enviar WhatsApp al Cliente
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Gesti√≥n de productos
    document.getElementById('guardarProductoBtn').addEventListener('click', function() {
        const productoId = document.getElementById('producto_id').value;
        
        // Validaciones
        const nombre = document.getElementById('producto_nombre').value.trim();
        const precio = parseFloat(document.getElementById('producto_precio').value);
        const stock = parseInt(document.getElementById('producto_stock').value);
        
        if (!nombre) {
            alert('El nombre del producto es obligatorio');
            return;
        }
        
        if (isNaN(precio) || precio <= 0) {
            alert('El precio debe ser un n√∫mero mayor a 0');
            return;
        }
        
        if (isNaN(stock) || stock < 0) {
            alert('El stock debe ser un n√∫mero mayor o igual a 0');
            return;
        }
        
        const productoData = {
            nombre: nombre,
            descripcion: document.getElementById('producto_descripcion').value.trim(),
            precio: precio,
            stock: stock,
            imagen: document.getElementById('producto_imagen').value.trim(),
            activo: document.getElementById('producto_activo').checked,
            categoria_id: document.getElementById('producto_categoria').value || null
        };
        
        const url = productoId ? `/api/producto/${productoId}` : '/api/producto';
        const method = productoId ? 'PUT' : 'POST';
        
        // Mostrar indicador de carga
        const btn = document.getElementById('guardarProductoBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productoData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let mensaje = '';
                if (productoId) {
                    mensaje = '‚úÖ Producto actualizado exitosamente';
                } else {
                    mensaje = '‚úÖ Producto creado exitosamente';
                }
                alert(mensaje);
                location.reload();
            } else {
                alert('‚ùå Error al guardar el producto: ' + data.error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar el producto');
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    });
    
    function editarProducto(id, nombre, descripcion, precio, stock, imagen, activo, categoria_id) {
        console.log('Editando producto ID:', id);
        
        // Verificar que el modal existe
        const modal = document.getElementById('productoModal');
        if (!modal) {
            alert('Error: Modal no encontrado. Verifica que el HTML est√© correcto.');
            return;
        }
        
        // Llenar formulario con datos del producto
        document.getElementById('producto_id').value = id || '';
        document.getElementById('producto_nombre').value = nombre || '';
        document.getElementById('producto_descripcion').value = descripcion || '';
        document.getElementById('producto_precio').value = precio || '';
        document.getElementById('producto_stock').value = stock || '';
        document.getElementById('producto_imagen').value = imagen || '';
        document.getElementById('producto_activo').checked = activo === 'true' || activo === true;
        
        // Establecer la categor√≠a seleccionada
        const categoriaSelect = document.getElementById('producto_categoria');
        if (categoria_id && categoria_id !== 'None' && categoria_id !== '') {
            categoriaSelect.value = categoria_id;
        } else {
            categoriaSelect.value = '';
        }
        
        // Cambiar t√≠tulo y bot√≥n
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Producto';
        
        // Mostrar modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        console.log('Modal abierto exitosamente para producto:', nombre, 'con categor√≠a:', categoria_id);
    }
    
    function duplicarProducto(producto) {
        // Cambiar t√≠tulo del modal
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-copy"></i> Duplicar Producto';
        
        // Llenar formulario con datos del producto (sin ID para crear nuevo)
        document.getElementById('producto_id').value = '';
        document.getElementById('producto_nombre').value = producto.nombre + ' (Copia)';
        document.getElementById('producto_descripcion').value = producto.descripcion || '';
        document.getElementById('producto_precio').value = producto.precio;
        document.getElementById('producto_stock').value = 0; // Stock en 0 para la copia
        document.getElementById('producto_imagen').value = producto.imagen || '';
        document.getElementById('producto_activo').checked = false; // Inactivo por defecto
        
        // Cambiar texto del bot√≥n
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Crear Copia';
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('productoModal'));
        modal.show();
        
        // Enfocar en el campo nombre y seleccionar todo el texto
        setTimeout(() => {
            const nombreField = document.getElementById('producto_nombre');
            nombreField.focus();
            nombreField.select();
        }, 500);
    }
    
    function toggleProductStatus(productoId, nuevoEstado) {
        const accion = nuevoEstado ? 'activar' : 'desactivar';
        const confirmacion = confirm(`¬øEst√°s seguro de que quieres ${accion} este producto?`);
        
        if (!confirmacion) return;
        
        // Mostrar indicador de carga
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        const productoData = {
            activo: nuevoEstado
        };
        
        fetch(`/api/producto/${productoId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productoData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar la interfaz sin recargar la p√°gina
                const statusElement = document.getElementById(`status-${productoId}`);
                if (nuevoEstado) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Activo';
                    btn.className = 'btn btn-sm btn-outline-warning ms-1';
                    btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    btn.onclick = () => toggleProductStatus(productoId, false);
                } else {
                    statusElement.className = 'badge bg-secondary';
                    statusElement.textContent = 'Inactivo';
                    btn.className = 'btn btn-sm btn-outline-success ms-1';
                    btn.innerHTML = '<i class="fas fa-eye"></i>';
                    btn.onclick = () => toggleProductStatus(productoId, true);
                }
                btn.disabled = false;
                alert(`‚úÖ Producto ${accion}do exitosamente`);
            } else {
                alert('‚ùå Error al actualizar el producto: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al actualizar el producto');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function eliminarProducto(id) {
        const confirmMessage = `¬øEst√°s seguro de que quieres eliminar este producto?

‚ö†Ô∏è IMPORTANTE:
- Si el producto tiene pedidos asociados, solo se desactivar√°
- Si no tiene pedidos, se eliminar√° permanentemente
- Esta acci√≥n no se puede deshacer

¬øContinuar?`;
        
        if (confirm(confirmMessage)) {
            // Mostrar indicador de carga
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
            btn.disabled = true;
            
            fetch(`/api/producto/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.mensaje);
                    location.reload();
                } else {
                    alert('Error al eliminar el producto: ' + data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    }
    
    // Gesti√≥n de pedidos
    function actualizarEstado(pedidoId, nuevoEstado) {
        fetch(`/api/pedido/${pedidoId}/estado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Estado actualizado exitosamente');
            } else {
                alert('Error al actualizar el estado: ' + data.error);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar el estado');
            location.reload();
        });
    }
    
    // Variables globales para almacenar datos del pedido
    let pedidoActual = {};
    
    function verDetallePedido(id, cliente_nombre, cliente_telefono, cliente_direccion, total, estado, fecha_pedido, cliente_comentarios) {
        console.log('Viendo detalle del pedido ID:', id);
        
        // Guardar datos del pedido en variables globales
        pedidoActual = {
            id: id,
            cliente_nombre: cliente_nombre,
            cliente_telefono: cliente_telefono,
            cliente_direccion: cliente_direccion,
            total: total,
            estado: estado,
            fecha_pedido: fecha_pedido,
            cliente_comentarios: cliente_comentarios
        };
        
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Informaci√≥n del Cliente</h6>
                    <p><strong>Nombre:</strong> ${cliente_nombre || 'No especificado'}</p>
                    <p><strong>Tel√©fono:</strong> ${cliente_telefono || 'No especificado'}</p>
                    <p><strong>Direcci√≥n:</strong> ${cliente_direccion || 'No especificada'}</p>
                    ${cliente_comentarios ? `<p><strong>Comentarios:</strong> ${cliente_comentarios}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Informaci√≥n del Pedido</h6>
                    <p><strong>ID:</strong> #${id}</p>
                    <p><strong>Fecha:</strong> ${fecha_pedido}</p>
                    <p><strong>Estado:</strong> <span class="badge bg-${estado === 'pendiente' ? 'warning' : estado === 'confirmado' ? 'info' : 'success'}">${estado}</span></p>
                    <p><strong>Total:</strong> $${total.toFixed(2)}</p>
                </div>
            </div>
            <hr>
            <h6>Productos</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Cargar los items del pedido via AJAX
        fetch(`/api/pedido/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pedido = data.pedido;
                    
                    // Agregar items del pedido
                    pedido.items.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.producto ? item.producto.nombre : 'Producto eliminado'}</td>
                                <td>${item.cantidad}</td>
                                <td>$${item.precio_unitario.toFixed(2)}</td>
                                <td>$${(item.precio_unitario * item.cantidad).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary">
                                        <th colspan="3">Total</th>
                                        <th>$${pedido.total.toFixed(2)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('detallePedidoContent').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('detallePedidoModal'));
                    modal.show();
                } else {
                    alert('Error al cargar los detalles del pedido: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los detalles del pedido');
            });
    }
    
    function abrirWhatsAppCliente() {
        if (!pedidoActual.id) {
            alert('Error: No hay datos del pedido disponibles');
            return;
        }
        
        // Obtener los items del pedido para incluir en el mensaje
        fetch(`/api/pedido/${pedidoActual.id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pedido = data.pedido;
                    let mensaje = '';
                    
                    // Debug: Mostrar el estado en consola
                    console.log('Estado del pedido:', pedido.estado);
                    
                    // Generar mensaje seg√∫n el estado del pedido
                    if (pedido.estado === 'entregado') {
                        mensaje = generarMensajeEntregado(pedido);
                    } else if (pedido.estado === 'confirmado') {
                        mensaje = generarMensajeConfirmado(pedido);
                    } else {
                        mensaje = generarMensajePendiente(pedido);
                    }
                    
                    // Limpiar n√∫mero de tel√©fono
                    let numeroLimpio = pedidoActual.cliente_telefono.replace(/\D/g, '');
                    if (!numeroLimpio.startsWith('51')) {
                        numeroLimpio = '51' + numeroLimpio;
                    }
                    
                    // Crear URL de WhatsApp
                    const mensajeCodificado = encodeURIComponent(mensaje);
                    const urlWhatsApp = `https://wa.me/${numeroLimpio}?text=${mensajeCodificado}`;
                    
                    // Abrir WhatsApp en nueva pesta√±a
                    window.open(urlWhatsApp, '_blank');
                    
                    // Mostrar mensaje de confirmaci√≥n
                    alert(`‚úÖ WhatsApp abierto para ${pedidoActual.cliente_nombre}\nüì± N√∫mero: ${pedidoActual.cliente_telefono}\nüìã Estado: ${pedido.estado}\n\nEl mensaje est√° pre-llenado con los datos del pedido.`);
                    
                } else {
                    alert('‚ùå Error al cargar los detalles del pedido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error al cargar los detalles del pedido');
            });
    }
    
    function generarMensajeEntregado(pedido) {
        let mensaje = `üéâ *PEDIDO ENTREGADO #${pedido.id}*\n\n`;
        mensaje += `¬°Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `¬°Excelente noticia! Tu pedido ha sido *entregado exitosamente*.\n\n`;
        mensaje += `üìã *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `‚Ä¢ ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - $${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\nüí∞ *Total pagado: $${pedido.total.toFixed(2)}*\n`;
        mensaje += `üìç *Direcci√≥n de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `üìÖ *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n`;
        mensaje += `‚úÖ *Fecha de entrega:* ${new Date().toLocaleDateString('es-PE')}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `üí¨ *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `üéä *¬°Pedido completado exitosamente!*\n\n`;
        mensaje += `üåü *¬°Gracias por elegirnos!*\n`;
        mensaje += `Esperamos que hayas disfrutado tu pedido.\n\n`;
        mensaje += `‚≠ê *¬øTe gustar√≠a calificar nuestro servicio?*\n`;
        mensaje += `Tu opini√≥n es muy importante para nosotros.\n\n`;
        mensaje += `üîÑ *¬øQuieres hacer otro pedido?*\n`;
        mensaje += `Estamos aqu√≠ para servirte nuevamente.\n\n`;
        mensaje += `¬°Que tengas un excelente d√≠a! üòä`;
        
        return mensaje;
    }
    
    function generarMensajeConfirmado(pedido) {
        let mensaje = `‚úÖ *PEDIDO CONFIRMADO #${pedido.id}*\n\n`;
        mensaje += `¬°Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `Tu pedido ha sido *confirmado* y est√° siendo preparado.\n\n`;
        mensaje += `üìã *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `‚Ä¢ ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - $${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\nüí∞ *Total: $${pedido.total.toFixed(2)}*\n`;
        mensaje += `üìç *Direcci√≥n de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `üìÖ *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `üí¨ *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `üöö *Estado:* Confirmado - En preparaci√≥n\n`;
        mensaje += `‚è∞ *Tiempo estimado:* 30-45 minutos\n\n`;
        mensaje += `¬°Gracias por elegirnos! Te contactaremos cuando est√© listo para entrega. üòä`;
        
        return mensaje;
    }
    
    function generarMensajePendiente(pedido) {
        let mensaje = `üìù *PEDIDO RECIBIDO #${pedido.id}*\n\n`;
        mensaje += `¬°Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `Hemos recibido tu pedido y lo estamos procesando.\n\n`;
        mensaje += `üìã *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `‚Ä¢ ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - $${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\nüí∞ *Total: $${pedido.total.toFixed(2)}*\n`;
        mensaje += `üìç *Direcci√≥n de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `üìÖ *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `üí¨ *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `‚è≥ *Estado:* Pendiente de confirmaci√≥n\n`;
        mensaje += `üìû Te contactaremos pronto para confirmar tu pedido.\n\n`;
        mensaje += `¬°Gracias por elegirnos! üòä`;
        
        return mensaje;
    }
    
    function eliminarPedido(pedidoId, clienteNombre) {
        // Confirmar eliminaci√≥n
        const confirmacion = confirm(`¬øEst√°s seguro de que quieres eliminar el pedido #${pedidoId} del cliente "${clienteNombre}"?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`);
        if (!confirmacion) return;
        
        // Mostrar loading
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        // Llamar a la API para eliminar el pedido
        fetch(`/api/pedido/${pedidoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Pedido eliminado exitosamente');
                // Recargar la p√°gina para actualizar la lista
                location.reload();
            } else {
                alert('‚ùå Error al eliminar el pedido: ' + data.error);
                // Restaurar bot√≥n
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar el pedido');
            // Restaurar bot√≥n
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // Limpiar formulario al cerrar modal
    document.getElementById('productoModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('productoForm').reset();
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-box"></i> Nuevo Producto';
        document.getElementById('producto_id').value = '';
        document.getElementById('producto_activo').checked = true; // Por defecto activo
        
        // Restaurar texto del bot√≥n
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Guardar';
    });
    
    // ===== CONFIGURACI√ìN DE LA TIENDA =====
    
    // Cargar configuraci√≥n al abrir la pesta√±a
    document.getElementById('configuracion-tab').addEventListener('click', function() {
        cargarConfiguracion();
    });
    
    // Actualizar vista previa en tiempo real
    document.getElementById('nombre_tienda').addEventListener('input', function() {
        const nombre = this.value || 'Mi Tienda Online';
        document.getElementById('preview_nombre').textContent = nombre;
    });
    
    document.getElementById('descripcion_tienda').addEventListener('input', function() {
        const descripcion = this.value || 'Descripci√≥n de la tienda';
        document.getElementById('preview_descripcion').textContent = descripcion;
    });
    
    document.getElementById('whatsapp_admin').addEventListener('input', function() {
        const whatsapp = this.value || 'Sin WhatsApp configurado';
        document.getElementById('preview_whatsapp').textContent = whatsapp;
    });
    
    // Guardar configuraci√≥n
    document.getElementById('guardarConfiguracionBtn').addEventListener('click', function() {
        guardarConfiguracion();
    });
    
    // Restaurar configuraci√≥n
    document.getElementById('restaurarConfiguracionBtn').addEventListener('click', function() {
        cargarConfiguracion();
    });
    
    function cargarConfiguracion() {
        fetch('/api/configuracion')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const config = data.configuracion;
                    document.getElementById('nombre_tienda').value = config.nombre_tienda || '';
                    document.getElementById('descripcion_tienda').value = config.descripcion_tienda || '';
                    document.getElementById('whatsapp_admin').value = config.whatsapp_admin || '';
                    document.getElementById('ultima_actualizacion').textContent = config.ultima_actualizacion || '-';
                    
                    // Actualizar vista previa
                    document.getElementById('preview_nombre').textContent = config.nombre_tienda || 'Mi Tienda Online';
                    document.getElementById('preview_descripcion').textContent = config.descripcion_tienda || 'Descripci√≥n de la tienda';
                    document.getElementById('preview_whatsapp').textContent = config.whatsapp_admin || 'Sin WhatsApp configurado';
                }
            })
            .catch(error => {
                console.error('Error al cargar configuraci√≥n:', error);
            });
    }
    
    function guardarConfiguracion() {
        const nombre = document.getElementById('nombre_tienda').value.trim();
        const descripcion = document.getElementById('descripcion_tienda').value.trim();
        const whatsapp = document.getElementById('whatsapp_admin').value.trim();
        
        if (!nombre) {
            alert('‚ö†Ô∏è El nombre de la tienda es obligatorio');
            return;
        }
        
        const btn = document.getElementById('guardarConfiguracionBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        const data = {
            nombre_tienda: nombre,
            descripcion_tienda: descripcion,
            whatsapp_admin: whatsapp
        };
        
        fetch('/api/configuracion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Configuraci√≥n guardada exitosamente');
                document.getElementById('ultima_actualizacion').textContent = data.ultima_actualizacion;
            } else {
                alert('‚ùå Error al guardar configuraci√≥n: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al guardar configuraci√≥n');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // ===== CAMBIO DE CONTRASE√ëA =====
    
    // Event listeners para cambio de contrase√±a
    document.getElementById('cambiarPasswordBtn').addEventListener('click', function() {
        cambiarPassword();
    });
    
    document.getElementById('limpiarPasswordBtn').addEventListener('click', function() {
        limpiarFormularioPassword();
    });
    
    // Validaci√≥n de contrase√±a en tiempo real
    document.getElementById('password_nueva').addEventListener('input', function() {
        validarSeguridadPassword(this.value);
    });
    
    document.getElementById('password_confirmar').addEventListener('input', function() {
        validarConfirmacionPassword();
    });
    
    function cambiarPassword() {
        const passwordActual = document.getElementById('password_actual').value.trim();
        const passwordNueva = document.getElementById('password_nueva').value.trim();
        const passwordConfirmar = document.getElementById('password_confirmar').value.trim();
        
        // Validaciones del lado del cliente
        if (!passwordActual) {
            alert('‚ö†Ô∏è La contrase√±a actual es obligatoria');
            return;
        }
        
        if (!passwordNueva) {
            alert('‚ö†Ô∏è La nueva contrase√±a es obligatoria');
            return;
        }
        
        if (passwordNueva.length < 6) {
            alert('‚ö†Ô∏è La nueva contrase√±a debe tener al menos 6 caracteres');
            return;
        }
        
        if (passwordNueva !== passwordConfirmar) {
            alert('‚ö†Ô∏è Las contrase√±as nuevas no coinciden');
            return;
        }
        
        // Confirmar cambio
        const confirmacion = confirm('¬øEst√°s seguro de que quieres cambiar tu contrase√±a?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.');
        if (!confirmacion) return;
        
        const btn = document.getElementById('cambiarPasswordBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando...';
        btn.disabled = true;
        
        const data = {
            password_actual: passwordActual,
            password_nueva: passwordNueva,
            password_confirmar: passwordConfirmar
        };
        
        fetch('/api/cambiar-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Contrase√±a cambiada exitosamente');
                limpiarFormularioPassword();
            } else {
                alert('‚ùå Error al cambiar contrase√±a: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al cambiar contrase√±a');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function limpiarFormularioPassword() {
        document.getElementById('password_actual').value = '';
        document.getElementById('password_nueva').value = '';
        document.getElementById('password_confirmar').value = '';
        document.getElementById('password-strength').innerHTML = '<i class="fas fa-info-circle"></i> Ingresa una nueva contrase√±a';
        document.getElementById('password-strength').className = 'text-muted';
    }
    
    function validarSeguridadPassword(password) {
        const strengthDiv = document.getElementById('password-strength');
        let strength = 0;
        let message = '';
        let className = '';
        
        if (password.length === 0) {
            message = '<i class="fas fa-info-circle"></i> Ingresa una nueva contrase√±a';
            className = 'text-muted';
        } else if (password.length < 6) {
            message = '<i class="fas fa-exclamation-triangle"></i> Muy d√©bil (m√≠nimo 6 caracteres)';
            className = 'text-danger';
        } else {
            strength = 1;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            switch (strength) {
                case 1:
                    message = '<i class="fas fa-exclamation-triangle"></i> D√©bil';
                    className = 'text-warning';
                    break;
                case 2:
                    message = '<i class="fas fa-shield-alt"></i> Regular';
                    className = 'text-info';
                    break;
                case 3:
                    message = '<i class="fas fa-shield-alt"></i> Buena';
                    className = 'text-primary';
                    break;
                case 4:
                case 5:
                    message = '<i class="fas fa-shield-alt"></i> Muy fuerte';
                    className = 'text-success';
                    break;
            }
        }
        
        strengthDiv.innerHTML = message;
        strengthDiv.className = className;
    }
    
    function validarConfirmacionPassword() {
        const passwordNueva = document.getElementById('password_nueva').value;
        const passwordConfirmar = document.getElementById('password_confirmar').value;
        
        if (passwordConfirmar.length > 0) {
            if (passwordNueva === passwordConfirmar) {
                document.getElementById('password_confirmar').className = 'form-control is-valid';
            } else {
                document.getElementById('password_confirmar').className = 'form-control is-invalid';
            }
        } else {
            document.getElementById('password_confirmar').className = 'form-control';
        }
    }
    
    // ===== ACTUALIZACI√ìN R√ÅPIDA DE ESTADO DE PEDIDOS =====
    
    function actualizarEstado(pedidoId, nuevoEstado) {
        // Actualizar la interfaz inmediatamente (optimistic update)
        actualizarInterfazEstado(pedidoId, nuevoEstado);
        
        // Enviar la petici√≥n al servidor en segundo plano
        fetch(`/api/pedido/${pedidoId}/estado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // Si hay error, revertir el cambio
                console.error('Error al actualizar estado:', data.error);
                // Aqu√≠ podr√≠as revertir el cambio o mostrar un mensaje de error
                alert('Error al actualizar el estado del pedido: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // En caso de error de red, tambi√©n podr√≠as revertir el cambio
            alert('Error de conexi√≥n al actualizar el estado');
        });
    }
    
    function actualizarInterfazEstado(pedidoId, nuevoEstado) {
        // Buscar la tarjeta del pedido
        const card = document.querySelector(`[data-pedido-id="${pedidoId}"]`);
        if (!card) return;
        
        // Actualizar el badge de estado
        const badge = card.querySelector('.badge');
        if (badge) {
            badge.className = 'badge';
            badge.textContent = nuevoEstado.charAt(0).toUpperCase() + nuevoEstado.slice(1);
            
            // Aplicar color seg√∫n el estado
            switch (nuevoEstado) {
                case 'pendiente':
                    badge.classList.add('bg-warning');
                    break;
                case 'confirmado':
                    badge.classList.add('bg-info');
                    break;
                case 'entregado':
                    badge.classList.add('bg-success');
                    break;
                default:
                    badge.classList.add('bg-secondary');
            }
        }
        
        // Actualizar el select para que mantenga el valor seleccionado
        const select = card.querySelector('select');
        if (select) {
            select.value = nuevoEstado;
        }
    }
    
    // ===== ACTUALIZAR PANEL DEL ADMINISTRADOR =====
    
    document.getElementById('actualizarPanelBtn').addEventListener('click', function() {
        actualizarPanel();
    });
    
    function actualizarPanel() {
        const btn = document.getElementById('actualizarPanelBtn');
        const originalHTML = btn.innerHTML;
        
        // Mostrar indicador de carga
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
        btn.disabled = true;
        
        // Simular un peque√±o delay para mostrar la animaci√≥n
        setTimeout(() => {
            // Recargar la p√°gina para obtener datos actualizados
            window.location.reload();
        }, 500);
    }
    
    // ===== GESTI√ìN DE CATEGOR√çAS =====
    
    // Event listeners para el modal de categor√≠as
    document.getElementById('guardarCategoriaBtn').addEventListener('click', function() {
        guardarCategoria();
    });
    
    // Vista previa en tiempo real
    document.getElementById('categoria_nombre').addEventListener('input', function() {
        const nombre = this.value || 'Nombre de la categor√≠a';
        document.getElementById('preview_nombre').textContent = nombre;
    });
    
    document.getElementById('categoria_icono').addEventListener('change', function() {
        const icono = this.value;
        const previewIcono = document.getElementById('preview_icono');
        previewIcono.className = icono + ' me-2';
    });
    
    document.getElementById('categoria_color').addEventListener('input', function() {
        const color = this.value;
        document.getElementById('preview_icono').style.color = color;
        document.getElementById('preview_badge').style.backgroundColor = color;
    });
    
    function nuevaCategoria() {
        // Limpiar formulario
        document.getElementById('categoriaForm').reset();
        document.getElementById('categoria_id').value = '';
        document.getElementById('categoria_activa').checked = true;
        
        // Actualizar t√≠tulo del modal
        document.getElementById('categoriaModalTitle').innerHTML = '<i class="fas fa-tag"></i> Nueva Categor√≠a';
        document.getElementById('guardarCategoriaBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Categor√≠a';
        
        // Actualizar vista previa
        actualizarVistaPreviaCategoria();
    }
    
    function editarCategoria(id, nombre, descripcion, icono, color, activa) {
        // Llenar formulario con datos de la categor√≠a
        document.getElementById('categoria_id').value = id;
        document.getElementById('categoria_nombre').value = nombre;
        document.getElementById('categoria_descripcion').value = descripcion || '';
        document.getElementById('categoria_icono').value = icono;
        document.getElementById('categoria_color').value = color;
        document.getElementById('categoria_activa').checked = activa;
        
        // Actualizar t√≠tulo del modal
        document.getElementById('categoriaModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Categor√≠a';
        document.getElementById('guardarCategoriaBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Categor√≠a';
        
        // Actualizar vista previa
        actualizarVistaPreviaCategoria();
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('categoriaModal'));
        modal.show();
    }
    
    function actualizarVistaPreviaCategoria() {
        const nombre = document.getElementById('categoria_nombre').value || 'Nombre de la categor√≠a';
        const icono = document.getElementById('categoria_icono').value;
        const color = document.getElementById('categoria_color').value;
        
        document.getElementById('preview_nombre').textContent = nombre;
        document.getElementById('preview_icono').className = icono + ' me-2';
        document.getElementById('preview_icono').style.color = color;
        document.getElementById('preview_badge').style.backgroundColor = color;
    }
    
    function guardarCategoria() {
        const categoriaId = document.getElementById('categoria_id').value;
        const nombre = document.getElementById('categoria_nombre').value.trim();
        const descripcion = document.getElementById('categoria_descripcion').value.trim();
        const icono = document.getElementById('categoria_icono').value;
        const color = document.getElementById('categoria_color').value;
        const activa = document.getElementById('categoria_activa').checked;
        
        // Validaciones
        if (!nombre) {
            alert('‚ö†Ô∏è El nombre de la categor√≠a es obligatorio');
            return;
        }
        
        const btn = document.getElementById('guardarCategoriaBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        const data = {
            nombre: nombre,
            descripcion: descripcion,
            icono: icono,
            color: color,
            activa: activa
        };
        
        const url = categoriaId ? `/api/categoria/${categoriaId}` : '/api/categoria';
        const method = categoriaId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.mensaje);
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('categoriaModal'));
                modal.hide();
                // Recargar p√°gina para mostrar cambios
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al guardar la categor√≠a');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function eliminarCategoria(categoriaId, nombre) {
        const confirmacion = confirm(`¬øEst√°s seguro de que quieres eliminar la categor√≠a "${nombre}"?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`);
        if (!confirmacion) return;
        
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        fetch(`/api/categoria/${categoriaId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.mensaje);
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar la categor√≠a');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // ===== SISTEMA DE NOTIFICACIONES =====
    
    let notificacionesActivas = true;
    let ultimoContadorPedidos = 0;
    let intervaloNotificaciones = null;
    
    // Funci√≥n para cambiar de tab
    function cambiarTab(tabName) {
        const tabButton = document.querySelector(`#${tabName}-tab`);
        if (tabButton) {
            tabButton.click();
        }
    }
    
    // Funci√≥n para ocultar notificaci√≥n
    function ocultarNotificacion() {
        const alert = document.getElementById('pedidosAlert');
        alert.classList.add('d-none');
    }
    
    // Funci√≥n para reproducir sonido de notificaci√≥n
    function reproducirSonidoNotificacion() {
        if (!notificacionesActivas) return;
        
        try {
            // Crear un sonido de notificaci√≥n m√°s audible y llamativo
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Crear m√∫ltiples tonos para un sonido m√°s llamativo
            const tonos = [
                { frecuencia: 800, duracion: 0.2 },
                { frecuencia: 1000, duracion: 0.2 },
                { frecuencia: 1200, duracion: 0.3 }
            ];
            
            let tiempoInicio = audioContext.currentTime;
            
            tonos.forEach((tono, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(tono.frecuencia, tiempoInicio);
                
                // Volumen m√°s alto para ser m√°s audible
                gainNode.gain.setValueAtTime(0.5, tiempoInicio);
                gainNode.gain.exponentialRampToValueAtTime(0.01, tiempoInicio + tono.duracion);
                
                oscillator.start(tiempoInicio);
                oscillator.stop(tiempoInicio + tono.duracion);
                
                // Pausa entre tonos
                tiempoInicio += tono.duracion + 0.1;
            });
            
            console.log('üîî Sonido de notificaci√≥n reproducido');
        } catch (error) {
            console.log('No se pudo reproducir el sonido de notificaci√≥n:', error);
            
            // Fallback: usar el sonido del sistema si est√° disponible
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.volume = 0.7;
                audio.play().catch(e => console.log('No se pudo reproducir audio de fallback:', e));
            } catch (fallbackError) {
                console.log('No se pudo usar el fallback de audio:', fallbackError);
            }
        }
    }
    
    // Funci√≥n para actualizar notificaciones
    function actualizarNotificaciones() {
        if (!notificacionesActivas) return;
        
        fetch('/api/notificaciones/pedidos')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const totalPendientes = data.total_pendientes;
                    const pedidosBadge = document.getElementById('pedidosBadge');
                    const pedidosAlert = document.getElementById('pedidosAlert');
                    const pedidosCount = document.getElementById('pedidosCount');
                    const ultimoPedidoInfo = document.getElementById('ultimoPedidoInfo');
                    
                    // Actualizar badge del bot√≥n de pedidos
                    if (totalPendientes > 0) {
                        pedidosBadge.textContent = totalPendientes;
                        pedidosBadge.classList.remove('d-none');
                    } else {
                        pedidosBadge.classList.add('d-none');
                    }
                    
                    // Mostrar alerta si hay pedidos pendientes
                    if (totalPendientes > 0) {
                        pedidosCount.textContent = totalPendientes;
                        
                        // Mostrar informaci√≥n del √∫ltimo pedido
                        if (data.ultimo_pedido) {
                            const fecha = new Date(data.ultimo_pedido.fecha_pedido);
                            const hora = fecha.toLocaleTimeString('es-PE', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                            ultimoPedidoInfo.textContent = `√öltimo pedido: #${data.ultimo_pedido.id} - ${data.ultimo_pedido.cliente_nombre} (${hora})`;
                        }
                        
                        pedidosAlert.classList.remove('d-none');
                        
                        // Reproducir sonido si hay nuevos pedidos
                        if (totalPendientes > ultimoContadorPedidos) {
                            console.log(`üîî Nuevo pedido detectado! Total: ${totalPendientes}, Anterior: ${ultimoContadorPedidos}`);
                            
                            // Reproducir sonido inmediatamente
                            setTimeout(() => {
                                reproducirSonidoNotificacion();
                            }, 100);
                            
                            // Mostrar notificaci√≥n del navegador si est√° disponible
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('üõí Nuevo Pedido', {
                                    body: `Pedido #${data.ultimo_pedido.id} de ${data.ultimo_pedido.cliente_nombre} - $${data.ultimo_pedido.total}`,
                                    icon: '/static/favicon.ico',
                                    tag: 'nuevo-pedido'
                                });
                            }
                            
                            // Hacer parpadear la pesta√±a si no est√° activa
                            if (document.hidden) {
                                document.title = 'üîî NUEVO PEDIDO - Panel Admin';
                                setTimeout(() => {
                                    document.title = 'Panel de Administraci√≥n - Mi Tienda Online';
                                }, 5000);
                            }
                        }
                    } else {
                        pedidosAlert.classList.add('d-none');
                    }
                    
                    ultimoContadorPedidos = totalPendientes;
                }
            })
            .catch(error => {
                console.error('Error al obtener notificaciones:', error);
            });
    }
    
    // Funci√≥n para activar/desactivar notificaciones
    function toggleNotificaciones() {
        notificacionesActivas = !notificacionesActivas;
        const icon = document.getElementById('notificationIcon');
        const btn = document.getElementById('toggleNotificationsBtn');
        
        if (notificacionesActivas) {
            icon.className = 'fas fa-bell';
            btn.className = 'btn btn-outline-info';
            btn.title = 'Desactivar notificaciones';
            
            // Iniciar polling
            if (!intervaloNotificaciones) {
                actualizarNotificaciones();
                intervaloNotificaciones = setInterval(actualizarNotificaciones, 10000); // Cada 10 segundos
            }
        } else {
            icon.className = 'fas fa-bell-slash';
            btn.className = 'btn btn-outline-secondary';
            btn.title = 'Activar notificaciones';
            
            // Detener polling
            if (intervaloNotificaciones) {
                clearInterval(intervaloNotificaciones);
                intervaloNotificaciones = null;
            }
        }
    }
    
    // Event listeners para notificaciones
    document.getElementById('toggleNotificationsBtn').addEventListener('click', toggleNotificaciones);
    document.getElementById('testSoundBtn').addEventListener('click', function() {
        reproducirSonidoNotificacion();
        console.log('üîä Probando sonido de notificaci√≥n...');
    });
    
    // Solicitar permisos de notificaci√≥n del navegador
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Inicializar notificaciones al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        // Esperar un poco antes de iniciar las notificaciones
        setTimeout(() => {
            // Cargar el estado inicial sin reproducir sonido
            fetch('/api/notificaciones/pedidos')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        ultimoContadorPedidos = data.total_pendientes;
                        console.log(`üìä Estado inicial: ${ultimoContadorPedidos} pedidos pendientes`);
                    }
                })
                .catch(error => {
                    console.error('Error al obtener estado inicial:', error);
                });
            
            // Iniciar el polling
            if (notificacionesActivas) {
                intervaloNotificaciones = setInterval(actualizarNotificaciones, 10000); // Cada 10 segundos
            }
        }, 2000);
    });
    
    // Actualizar notificaciones cuando se cambia de tab a pedidos
    document.getElementById('pedidos-tab').addEventListener('click', function() {
        setTimeout(actualizarNotificaciones, 500);
    });
</script>
{% endblock %}
