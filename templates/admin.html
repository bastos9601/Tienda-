{% extends "base.html" %}

{% block title %}Administraci√≥n - Mi Tienda Online{% endblock %}

{% block content %}
<!-- Header responsivo -->
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <h1 class="mb-2 mb-md-0">
                <i class="fas fa-cogs"></i> 
                <span class="d-none d-sm-inline">Panel de Administraci√≥n</span>
                <span class="d-inline d-sm-none">Admin</span>
            </h1>
            
            <!-- Bot√≥n de men√∫ m√≥vil -->
            <button class="btn btn-outline-primary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#mobileMenu" aria-expanded="false">
                <i class="fas fa-bars"></i> Men√∫
            </button>
        </div>
    </div>
</div>

<!-- Navegaci√≥n responsiva -->
<div class="row">
    <div class="col-12">
        <!-- Tabs de escritorio -->
        <ul class="nav nav-tabs d-none d-md-flex" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="productos-tab" data-bs-toggle="tab" data-bs-target="#productos" type="button" role="tab">
                    <i class="fas fa-box"></i> <span class="d-none d-lg-inline">Productos</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos" type="button" role="tab">
                    <i class="fas fa-shopping-cart"></i> <span class="d-none d-lg-inline">Pedidos</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="categorias-tab" data-bs-toggle="tab" data-bs-target="#categorias" type="button" role="tab">
                    <i class="fas fa-tags"></i> <span class="d-none d-lg-inline">Categor√≠as</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="configuracion-tab" data-bs-toggle="tab" data-bs-target="#configuracion" type="button" role="tab">
                    <i class="fas fa-cog"></i> <span class="d-none d-lg-inline">Configuraci√≥n</span>
                </button>
            </li>
        </ul>
        
        <!-- Men√∫ m√≥vil colapsable -->
        <div class="collapse d-md-none mb-3" id="mobileMenu">
            <div class="card">
                <div class="card-body p-2">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary text-start" id="productos-tab-mobile" data-bs-toggle="tab" data-bs-target="#productos" type="button" role="tab">
                            <i class="fas fa-box me-2"></i> Productos
                        </button>
                        <button class="btn btn-outline-primary text-start position-relative" id="pedidos-tab-mobile" data-bs-toggle="tab" data-bs-target="#pedidos" type="button" role="tab">
                            <i class="fas fa-shopping-cart me-2"></i> Pedidos
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="pedidosBadgeMobile">
                                0
                            </span>
                        </button>
                        <button class="btn btn-outline-primary text-start" id="categorias-tab-mobile" data-bs-toggle="tab" data-bs-target="#categorias" type="button" role="tab">
                            <i class="fas fa-tags me-2"></i> Categor√≠as
                        </button>
                        <button class="btn btn-outline-primary text-start" id="configuracion-tab-mobile" data-bs-toggle="tab" data-bs-target="#configuracion" type="button" role="tab">
                            <i class="fas fa-cog me-2"></i> Configuraci√≥n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Barra de notificaciones y controles responsiva -->
<div class="row mb-3">
    <div class="col-12">
        <!-- Notificaciones de pedidos -->
        <div class="notifications-container mb-3">
            <div class="alert alert-warning d-none" id="pedidosAlert" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bell me-2"></i>
                    <div class="flex-grow-1">
                        <strong id="pedidosCount">0</strong> pedidos pendientes
                        <small class="d-block text-muted" id="ultimoPedidoInfo"></small>
                    </div>
                    <button type="button" class="btn-close" onclick="ocultarNotificacion()"></button>
                </div>
            </div>
        </div>
        
        <!-- Controles del panel responsivos -->
        <div class="row g-2">
            <!-- Controles principales -->
            <div class="col-12 col-sm-6 col-md-8">
                <div class="d-flex flex-wrap gap-2">
                    <!-- Bot√≥n de pedidos (solo en escritorio) -->
                    <div class="position-relative d-none d-md-block">
                        <button class="btn btn-outline-primary" id="pedidos-tab-btn" onclick="cambiarTab('pedidos')" title="Ver pedidos">
                            <i class="fas fa-shopping-cart"></i> <span class="d-none d-lg-inline">Pedidos</span>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none" id="pedidosBadge">
                                0
                            </span>
                        </button>
                    </div>
                    
                    <!-- Bot√≥n de actualizar -->
                    <button class="btn btn-outline-primary" id="actualizarPanelBtn" title="Actualizar panel del administrador">
                        <i class="fas fa-sync-alt"></i> <span class="d-none d-sm-inline">Actualizar</span>
                    </button>
                </div>
            </div>
            
            <!-- Controles de notificaciones -->
            <div class="col-12 col-sm-6 col-md-4">
                <div class="d-flex flex-wrap gap-2 justify-content-sm-end">
                    <!-- Bot√≥n de notificaciones -->
                    <button class="btn btn-outline-info" id="toggleNotificationsBtn" title="Activar/Desactivar notificaciones">
                        <i class="fas fa-bell" id="notificationIcon"></i>
                        <span class="d-none d-sm-inline ms-1">Notif.</span>
                    </button>
                    
                    <!-- Bot√≥n para configurar notificaciones del navegador -->
                    <button class="btn btn-outline-success" id="configNotificationsBtn" title="Configurar notificaciones del navegador">
                        <i class="fas fa-cog" id="configIcon"></i>
                        <span class="d-none d-sm-inline ms-1">Config.</span>
                    </button>
                    
                    <!-- Bot√≥n para probar sonido -->
                    <button class="btn btn-outline-success" id="testSoundBtn" title="Probar sonido de notificaci√≥n">
                        <i class="fas fa-volume-up"></i>
                        <span class="d-none d-sm-inline ms-1">Sonido</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="adminTabsContent">
    <!-- Tab de Productos -->
    <div class="tab-pane fade show active" id="productos" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <!-- Header responsivo -->
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3">
                    <h3 class="mb-2 mb-sm-0">
                        <i class="fas fa-box"></i> 
                        <span class="d-none d-sm-inline">Gesti√≥n de Productos</span>
                        <span class="d-inline d-sm-none">Productos</span>
                    </h3>
                    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-sm-auto">
                        <button class="btn btn-success" onclick="exportarProductos()">
                            <i class="fas fa-download"></i> 
                            <span class="d-none d-sm-inline">Exportar</span>
                        </button>
                        <button class="btn btn-info" onclick="document.getElementById('importarArchivo').click()">
                            <i class="fas fa-upload"></i> 
                            <span class="d-none d-sm-inline">Importar</span>
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productoModal">
                            <i class="fas fa-plus"></i> 
                            <span class="d-none d-sm-inline">Nuevo Producto</span>
                            <span class="d-inline d-sm-none">Nuevo</span>
                        </button>
                    </div>
                </div>
                
                <!-- Input oculto para importar archivos -->
                <input type="file" id="importarArchivo" accept=".txt" style="display: none;" onchange="importarProductos(this)">
                
                <!-- Grid responsivo de productos -->
                <div class="row g-3">
                    {% for producto in productos %}
                    <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-truncate" title="{{ producto.nombre }}">
                                    <i class="fas fa-box text-primary"></i> 
                                    <span class="d-none d-sm-inline">{{ producto.nombre }}</span>
                                    <span class="d-inline d-sm-none">{{ producto.nombre[:15] }}{% if producto.nombre|length > 15 %}...{% endif %}</span>
                                </h6>
                                <span class="badge bg-secondary">#{{ producto.id }}</span>
                            </div>
                            <div class="card-body">
                                <!-- Informaci√≥n del producto -->
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Precio</small>
                                        <div class="fw-bold text-success">S/{{ "%.2f"|format(producto.precio) }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Stock</small>
                                        <div class="fw-bold text-info">{{ producto.stock }}</div>
                                    </div>
                                </div>
                                
                                {% if producto.descripcion %}
                                <div class="mb-3">
                                    <small class="text-muted d-block">Descripci√≥n</small>
                                    <div class="small text-truncate" title="{{ producto.descripcion }}">
                                        {{ producto.descripcion[:40] }}{% if producto.descripcion|length > 40 %}...{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Estado y controles -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        {% if producto.activo %}
                                        <span class="badge bg-success" id="status-{{ producto.id }}">Activo</span>
                                        {% else %}
                                        <span class="badge bg-secondary" id="status-{{ producto.id }}">Inactivo</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        {% if producto.activo %}
                                        <button class="btn btn-sm btn-outline-warning" onclick="toggleProductStatus({{ producto.id }}, false)" title="Desactivar producto">
                                            <i class="fas fa-eye-slash"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-success" onclick="toggleProductStatus({{ producto.id }}, true)" title="Activar producto">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light p-2">
                                <!-- Botones de acci√≥n responsivos -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editarProducto({{ producto.id }}, '{{ producto.nombre|replace("'", "\\") }}', '{{ producto.descripcion|replace("'", "\\") if producto.descripcion else "" }}', {{ producto.precio }}, {{ producto.stock }}, '{{ producto.imagen if producto.imagen else "" }}', {{ producto.activo|lower }}, {{ producto.categoria_id if producto.categoria_id else 'null' }})" title="Editar producto">
                                        <i class="fas fa-edit"></i> 
                                        <span class="d-none d-sm-inline ms-1">Editar</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" onclick="eliminarProducto({{ producto.id }})" title="Eliminar producto">
                                        <i class="fas fa-trash"></i> 
                                        <span class="d-none d-sm-inline ms-1">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab de Pedidos -->
    <div class="tab-pane fade" id="pedidos" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <h3>
                    <i class="fas fa-shopping-cart"></i> 
                    <span class="d-none d-sm-inline">Gesti√≥n de Pedidos</span>
                    <span class="d-inline d-sm-none">Pedidos</span>
                </h3>
                
                <!-- Grid responsivo de pedidos -->
                <div class="row g-3">
                    {% for pedido in pedidos %}
                    <div class="col-12 col-lg-6 col-xl-4">
                        <div class="card h-100 shadow-sm" data-pedido-id="{{ pedido.id }}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-shopping-cart text-primary"></i> 
                                    <span class="d-none d-sm-inline">Pedido #{{ pedido.id }}</span>
                                    <span class="d-inline d-sm-none">#{{ pedido.id }}</span>
                                </h6>
                                <small class="text-muted">{{ pedido.fecha_pedido.strftime('%d/%m/%Y') }}</small>
                            </div>
                            <div class="card-body">
                                <!-- Informaci√≥n del cliente -->
                                <div class="mb-3">
                                    <small class="text-muted d-block">Cliente</small>
                                    <div class="fw-bold text-truncate" title="{{ pedido.cliente_nombre }}">{{ pedido.cliente_nombre }}</div>
                                </div>
                                
                                <!-- Tel√©fono y Total -->
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Tel√©fono</small>
                                        <div class="small">{{ pedido.cliente_telefono }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Total</small>
                                        <div class="fw-bold text-success">S/{{ "%.2f"|format(pedido.total) }}</div>
                                    </div>
                                </div>
                                
                                <!-- Direcci√≥n -->
                                {% if pedido.cliente_direccion %}
                                <div class="mb-3">
                                    <small class="text-muted d-block">Direcci√≥n</small>
                                    <div class="small text-truncate" title="{{ pedido.cliente_direccion }}">
                                        {{ pedido.cliente_direccion[:35] }}{% if pedido.cliente_direccion|length > 35 %}...{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Estado -->
                                <div class="mb-3">
                                    <small class="text-muted d-block">Estado</small>
                                    <select class="form-select form-select-sm" onchange="actualizarEstado({{ pedido.id }}, this.value)">
                                        <option value="pendiente" {% if pedido.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="confirmado" {% if pedido.estado == 'confirmado' %}selected{% endif %}>Confirmado</option>
                                        <option value="entregado" {% if pedido.estado == 'entregado' %}selected{% endif %}>Entregado</option>
                                    </select>
                                </div>
                                
                                <!-- Hora y badge de estado -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> {{ pedido.fecha_pedido.strftime('%I:%M %p') }}
                                    </small>
                                    <div>
                                        {% if pedido.estado == 'pendiente' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                        {% elif pedido.estado == 'confirmado' %}
                                        <span class="badge bg-info">Confirmado</span>
                                        {% elif pedido.estado == 'entregado' %}
                                        <span class="badge bg-success">Entregado</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light p-2">
                                <!-- Botones de acci√≥n responsivos -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-sm btn-outline-info flex-fill" onclick="verDetallePedido({{ pedido.id }}, '{{ pedido.cliente_nombre|replace("'", "\\") }}', '{{ pedido.cliente_telefono|replace("'", "\\") }}', '{{ pedido.cliente_direccion|replace("'", "\\") }}', {{ pedido.total }}, '{{ pedido.estado }}', '{{ pedido.fecha_pedido.strftime('%d/%m/%Y %I:%M %p') }}', '{{ pedido.cliente_comentarios|replace("'", "\\") if pedido.cliente_comentarios else "" }}')" title="Ver detalles del pedido">
                                        <i class="fas fa-eye"></i> 
                                        <span class="d-none d-sm-inline ms-1">Ver</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" onclick="eliminarPedido({{ pedido.id }}, '{{ pedido.cliente_nombre|replace("'", "\\") }}')" title="Eliminar pedido">
                                        <i class="fas fa-trash"></i> 
                                        <span class="d-none d-sm-inline ms-1">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab de Categor√≠as -->
    <div class="tab-pane fade" id="categorias" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <!-- Header responsivo -->
                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-4">
                    <h3 class="mb-2 mb-sm-0">
                        <i class="fas fa-tags"></i> 
                        <span class="d-none d-sm-inline">Gesti√≥n de Categor√≠as</span>
                        <span class="d-inline d-sm-none">Categor√≠as</span>
                    </h3>
                    <button class="btn btn-primary w-100 w-sm-auto" data-bs-toggle="modal" data-bs-target="#categoriaModal" onclick="nuevaCategoria()">
                        <i class="fas fa-plus"></i> 
                        <span class="d-none d-sm-inline">Nueva Categor√≠a</span>
                        <span class="d-inline d-sm-none">Nueva</span>
                    </button>
                </div>
                
                <!-- Lista de Categor√≠as -->
                <div class="row" id="categorias-container">
                    <!-- Debug: Mostrar informaci√≥n de categor√≠as -->
                    <div class="col-12 mb-3">
                        <div class="alert alert-info">
                            <strong>Debug:</strong> Total de categor√≠as: {{ categorias|length }}
                            {% if categorias %}
                                <br>Categor√≠as encontradas: 
                                {% for cat in categorias %}
                                    {{ cat.nombre }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                <br>No hay categor√≠as en la base de datos
                            {% endif %}
                        </div>
                    </div>
                    
                    {% for categoria in categorias %}
                    <div class="col-12 col-sm-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: {{ categoria.color }}20; border-left: 4px solid {{ categoria.color }};">
                                <h6 class="mb-0 text-truncate" title="{{ categoria.nombre }}">
                                    <i class="{{ categoria.icono }}" style="color: {{ categoria.color }};"></i> 
                                    <span class="d-none d-sm-inline">{{ categoria.nombre }}</span>
                                    <span class="d-inline d-sm-none">{{ categoria.nombre[:15] }}{% if categoria.nombre|length > 15 %}...{% endif %}</span>
                                </h6>
                                <span class="badge bg-secondary">#{{ categoria.id }}</span>
                            </div>
                            <div class="card-body">
                                {% if categoria.descripcion %}
                                <p class="card-text text-muted small">{{ categoria.descripcion[:60] }}{% if categoria.descripcion|length > 60 %}...{% endif %}</p>
                                {% endif %}
                                
                                <div class="row g-2 mb-3">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Productos</small>
                                        <div class="fw-bold text-info">{{ categoria.productos|length }}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Estado</small>
                                        <div>
                                            {% if categoria.activa %}
                                            <span class="badge bg-success">Activa</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Inactiva</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted d-block">Color</small>
                                    <div class="d-flex align-items-center">
                                        <div class="color-preview me-2" style="width: 20px; height: 20px; background-color: {{ categoria.color }}; border-radius: 50%;"></div>
                                        <span class="small">{{ categoria.color }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light p-2">
                                <!-- Botones de acci√≥n responsivos -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editarCategoria({{ categoria.id }}, '{{ categoria.nombre|replace("'", "\\") }}', '{{ categoria.descripcion|replace("'", "\\") if categoria.descripcion else "" }}', '{{ categoria.icono }}', '{{ categoria.color }}', {{ categoria.activa|lower }})" title="Editar categor√≠a">
                                        <i class="fas fa-edit"></i> 
                                        <span class="d-none d-sm-inline ms-1">Editar</span>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger flex-fill" onclick="eliminarCategoria({{ categoria.id }}, '{{ categoria.nombre|replace("'", "\\") }}')" title="Eliminar categor√≠a">
                                        <i class="fas fa-trash"></i> 
                                        <span class="d-none d-sm-inline ms-1">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if not categorias %}
                <div class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-tags fa-4x text-muted mb-4"></i>
                        <h4>No hay categor√≠as</h4>
                        <p class="text-muted">Crea tu primera categor√≠a para organizar tus productos.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoriaModal" onclick="nuevaCategoria()">
                            <i class="fas fa-plus"></i> Crear Primera Categor√≠a
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Tab de Configuraci√≥n -->
    <div class="tab-pane fade" id="configuracion" role="tabpanel">
        <div class="row mt-4">
            <div class="col-12">
                <h3><i class="fas fa-cog"></i> Configuraci√≥n de la Tienda</h3>
                <p class="text-muted">Personaliza la informaci√≥n de tu tienda online</p>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-store"></i> Informaci√≥n General</h5>
                    </div>
                    <div class="card-body">
                        <form id="configuracionForm">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="nombre_tienda" class="form-label">
                                            <i class="fas fa-signature"></i> Nombre de la Tienda
                                        </label>
                                        <input type="text" class="form-control" id="nombre_tienda" 
                                               placeholder="Ej: Mi Tienda Online" maxlength="50">
                                        <div class="form-text">Este nombre aparecer√° en el encabezado de tu tienda</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Vista Previa</label>
                                        <div class="border rounded p-2 bg-light">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-store text-primary me-2"></i>
                                                <span id="preview_nombre" class="fw-bold">Mi Tienda Online</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="descripcion_tienda" class="form-label">
                                                <i class="fas fa-info-circle"></i> Descripci√≥n de la Tienda
                                            </label>
                                            <textarea class="form-control" id="descripcion_tienda" rows="3" 
                                                      placeholder="Describe brevemente tu tienda..." maxlength="200"></textarea>
                                            <div class="form-text">Descripci√≥n que aparecer√° en la p√°gina principal</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Vista Previa</label>
                                            <div class="border rounded p-2 bg-light">
                                                <small id="preview_descripcion" class="text-muted">Descripci√≥n de la tienda</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="whatsapp_admin" class="form-label">
                                                <i class="fab fa-whatsapp text-success"></i> WhatsApp del Administrador
                                            </label>
                                            <input type="tel" class="form-control" id="whatsapp_admin" 
                                                   placeholder="Ej: +51987654321" maxlength="20">
                                            <div class="form-text">N√∫mero de WhatsApp para que los clientes te contacten</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Vista Previa</label>
                                            <div class="border rounded p-2 bg-light">
                                                <div class="d-flex align-items-center">
                                                    <i class="fab fa-whatsapp text-success me-2"></i>
                                                    <span id="preview_whatsapp" class="text-muted">Sin WhatsApp configurado</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-primary" id="guardarConfiguracionBtn">
                                        <i class="fas fa-save"></i> Guardar Configuraci√≥n
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="restaurarConfiguracionBtn">
                                        <i class="fas fa-undo"></i> Restaurar Valores
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> √öltima actualizaci√≥n: <span id="ultima_actualizacion">-</span>
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-key"></i> Cambiar Contrase√±a</h5>
                    </div>
                    <div class="card-body">
                        <form id="cambiarPasswordForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_actual" class="form-label">
                                            <i class="fas fa-lock"></i> Contrase√±a Actual
                                        </label>
                                        <input type="password" class="form-control" id="password_actual" required>
                                        <div class="form-text">Ingresa tu contrase√±a actual para confirmar</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_nueva" class="form-label">
                                            <i class="fas fa-key"></i> Nueva Contrase√±a
                                        </label>
                                        <input type="password" class="form-control" id="password_nueva" required minlength="6">
                                        <div class="form-text">M√≠nimo 6 caracteres</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="password_confirmar" class="form-label">
                                            <i class="fas fa-check-circle"></i> Confirmar Nueva Contrase√±a
                                        </label>
                                        <input type="password" class="form-control" id="password_confirmar" required>
                                        <div class="form-text">Repite la nueva contrase√±a</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Seguridad de la Contrase√±a</label>
                                        <div class="border rounded p-2 bg-light">
                                            <div id="password-strength" class="text-muted">
                                                <i class="fas fa-info-circle"></i> Ingresa una nueva contrase√±a
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-warning" id="cambiarPasswordBtn">
                                        <i class="fas fa-key"></i> Cambiar Contrase√±a
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary ms-2" id="limpiarPasswordBtn">
                                        <i class="fas fa-eraser"></i> Limpiar
                                    </button>
                                </div>
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-shield-alt"></i> Usuario actual: <strong>{{ current_user.username }}</strong>
                                    </small>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Informaci√≥n del Sistema</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Configuraciones Disponibles:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> Nombre de la tienda</li>
                                    <li><i class="fas fa-check text-success"></i> Descripci√≥n de la tienda</li>
                                    <li><i class="fas fa-clock text-warning"></i> Logo de la tienda (pr√≥ximamente)</li>
                                    <li><i class="fas fa-clock text-warning"></i> Colores personalizados (pr√≥ximamente)</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Estad√≠sticas:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-box"></i> Productos activos: <span class="badge bg-primary">{{ productos_activos }}</span></li>
                                    <li><i class="fas fa-shopping-cart"></i> Total pedidos: <span class="badge bg-success">{{ total_pedidos }}</span></li>
                                    <li><i class="fas fa-user"></i> Usuarios registrados: <span class="badge bg-info">{{ total_usuarios }}</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Producto -->
<div class="modal fade" id="productoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productoModalTitle">
                    <i class="fas fa-box"></i> 
                    <span class="d-none d-sm-inline">Nuevo Producto</span>
                    <span class="d-inline d-sm-none">Producto</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productoForm">
                    <input type="hidden" id="producto_id">
                    <div class="mb-3">
                        <label for="producto_nombre" class="form-label">Nombre *</label>
                        <input type="text" class="form-control" id="producto_nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="producto_descripcion" class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" id="producto_descripcion" rows="3"></textarea>
                    </div>
                    <div class="row g-3">
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="producto_precio" class="form-label">Precio *</label>
                                <input type="number" class="form-control" id="producto_precio" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="producto_stock" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="producto_stock" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="producto_imagen" class="form-label">
                            <i class="fas fa-image"></i> Imagen del Producto
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="file" class="form-control" id="producto_imagen_file" accept="image/*" onchange="previewImage(this)">
                                <div class="form-text">Selecciona una imagen desde tu ordenador</div>
                            </div>
                            <div class="col-md-6">
                                <input type="url" class="form-control" id="producto_imagen" placeholder="O pega una URL de imagen">
                                <div class="form-text">O pega una URL de imagen</div>
                            </div>
                        </div>
                        <div id="imagen_preview" class="mt-2" style="display: none;">
                            <img id="preview_img" src="" alt="Vista previa" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="producto_categoria" class="form-label">
                            <i class="fas fa-tags"></i> Categor√≠a
                        </label>
                        <select class="form-select" id="producto_categoria">
                            <option value="">Sin categor√≠a</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Selecciona la categor√≠a del producto</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="producto_activo" checked>
                            <label class="form-check-label" for="producto_activo">
                                Producto activo
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times d-sm-none"></i>
                    <span class="d-none d-sm-inline">Cancelar</span>
                </button>
                <button type="button" class="btn btn-primary" id="guardarProductoBtn">
                    <i class="fas fa-save"></i> 
                    <span class="d-none d-sm-inline ms-1">Guardar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Categor√≠a -->
<div class="modal fade" id="categoriaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoriaModalTitle">
                    <i class="fas fa-tag"></i> 
                    <span class="d-none d-sm-inline">Nueva Categor√≠a</span>
                    <span class="d-inline d-sm-none">Categor√≠a</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoriaForm">
                    <input type="hidden" id="categoria_id" name="categoria_id">
                    
                    <div class="mb-3">
                        <label for="categoria_nombre" class="form-label">
                            <i class="fas fa-tag"></i> Nombre de la Categor√≠a *
                        </label>
                        <input type="text" class="form-control" id="categoria_nombre" name="categoria_nombre" required maxlength="50">
                        <div class="form-text">Nombre √∫nico para la categor√≠a</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="categoria_descripcion" class="form-label">
                            <i class="fas fa-align-left"></i> Descripci√≥n
                        </label>
                        <textarea class="form-control" id="categoria_descripcion" name="categoria_descripcion" rows="3" maxlength="200"></textarea>
                        <div class="form-text">Descripci√≥n opcional de la categor√≠a</div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="categoria_icono" class="form-label">
                                    <i class="fas fa-icons"></i> Icono
                                </label>
                                <select class="form-select" id="categoria_icono" name="categoria_icono">
                                    <option value="fas fa-tag">üè∑Ô∏è Etiqueta</option>
                                    <option value="fas fa-utensils">üçΩÔ∏è Comida</option>
                                    <option value="fas fa-coffee">‚òï Bebidas</option>
                                    <option value="fas fa-ice-cream">üç¶ Postres</option>
                                    <option value="fas fa-laptop">üíª Servicios</option>
                                    <option value="fas fa-heart">‚ù§Ô∏è Salud</option>
                                    <option value="fas fa-car">üöó Transporte</option>
                                    <option value="fas fa-home">üè† Hogar</option>
                                    <option value="fas fa-gamepad">üéÆ Entretenimiento</option>
                                    <option value="fas fa-gift">üéÅ Regalos</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-sm-6">
                            <div class="mb-3">
                                <label for="categoria_color" class="form-label">
                                    <i class="fas fa-palette"></i> Color
                                </label>
                                <input type="color" class="form-control form-control-color" id="categoria_color" name="categoria_color" value="#007bff">
                                <div class="form-text">Color de la categor√≠a</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="categoria_activa" name="categoria_activa" checked>
                            <label class="form-check-label" for="categoria_activa">
                                <i class="fas fa-eye"></i> Categor√≠a activa
                            </label>
                        </div>
                        <div class="form-text">Las categor√≠as inactivas no se mostrar√°n en la tienda</div>
                    </div>
                    
                    <!-- Vista previa -->
                    <div class="mb-3">
                        <label class="form-label">Vista Previa</label>
                        <div class="border rounded p-3 bg-light">
                            <div class="d-flex align-items-center">
                                <i id="preview_icono" class="fas fa-tag me-2" style="color: #007bff;"></i>
                                <span id="preview_nombre" class="fw-bold">Nombre de la categor√≠a</span>
                            </div>
                            <div class="mt-2">
                                <span class="badge" id="preview_badge" style="background-color: #007bff;">Categor√≠a</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times d-sm-none"></i>
                    <span class="d-none d-sm-inline">Cancelar</span>
                </button>
                <button type="button" class="btn btn-primary" id="guardarCategoriaBtn">
                    <i class="fas fa-save"></i> 
                    <span class="d-none d-sm-inline ms-1">Guardar Categor√≠a</span>
                    <span class="d-inline d-sm-none">Guardar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Detalle de Pedido -->
<div class="modal fade" id="detallePedidoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-receipt"></i> 
                    <span class="d-none d-sm-inline">Detalle del Pedido</span>
                    <span class="d-inline d-sm-none">Pedido</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallePedidoContent">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success flex-fill flex-md-fill-0" id="confirmarPedidoBtn" onclick="abrirWhatsAppCliente()">
                    <i class="fab fa-whatsapp"></i> 
                    <span class="d-none d-sm-inline ms-1">Enviar WhatsApp al Cliente</span>
                    <span class="d-inline d-sm-none">WhatsApp</span>
                </button>
                <button type="button" class="btn btn-secondary flex-fill flex-md-fill-0" data-bs-dismiss="modal">
                    <i class="fas fa-times d-sm-none"></i>
                    <span class="d-none d-sm-inline">Cerrar</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    /* Estilos responsivos adicionales */
    @media (max-width: 767.98px) {
        /* Mejorar espaciado en m√≥viles */
        .container-fluid {
            padding-left: 15px;
            padding-right: 15px;
        }
        
        /* Ajustar cards para m√≥viles */
        .card {
            margin-bottom: 1rem;
        }
        
        /* Mejorar botones en m√≥viles */
        .btn {
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Mejorar formularios en m√≥viles */
        .form-control, .form-select {
            min-height: 44px;
            font-size: 16px; /* Evita zoom en iOS */
        }
        
        /* Ajustar modales en m√≥viles */
        .modal-dialog {
            margin: 0.5rem;
        }
        
        /* Mejorar navegaci√≥n m√≥vil */
        .nav-tabs {
            border-bottom: none;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
        }
        
        /* Ajustar badges en m√≥viles */
        .badge {
            font-size: 0.75em;
        }
        
        /* Mejorar alertas en m√≥viles */
        .alert {
            font-size: 0.9rem;
        }
        
        /* Ajustar tablas en m√≥viles */
        .table-responsive {
            border-radius: 0.375rem;
        }
        
        /* Mejorar espaciado de grid */
        .row.g-3 {
            --bs-gutter-x: 1rem;
            --bs-gutter-y: 1rem;
        }
    }
    
    @media (max-width: 575.98px) {
        /* Ajustes para pantallas muy peque√±as */
        .card-header h6 {
            font-size: 0.9rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .card-footer {
            padding: 0.5rem;
        }
        
        /* Botones de acci√≥n en una columna */
        .d-grid.gap-2.d-md-flex {
            display: grid !important;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        /* Ajustar texto en m√≥viles */
        .text-truncate {
            max-width: 120px;
        }
    }
    
    /* Mejorar experiencia t√°ctil */
    .btn:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* Animaciones suaves */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Mejorar contraste en m√≥viles */
    @media (max-width: 767.98px) {
        .text-muted {
            color: #6c757d !important;
        }
        
        .btn-outline-primary {
            border-width: 2px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Gesti√≥n de productos
    document.getElementById('guardarProductoBtn').addEventListener('click', function() {
        const productoId = document.getElementById('producto_id').value;
        
        // Validaciones
        const nombre = document.getElementById('producto_nombre').value.trim();
        const precio = parseFloat(document.getElementById('producto_precio').value);
        const stock = parseInt(document.getElementById('producto_stock').value);
        
        if (!nombre) {
            alert('El nombre del producto es obligatorio');
            return;
        }
        
        if (isNaN(precio) || precio <= 0) {
            alert('El precio debe ser un n√∫mero mayor a 0');
            return;
        }
        
        if (isNaN(stock) || stock < 0) {
            alert('El stock debe ser un n√∫mero mayor o igual a 0');
            return;
        }
        
        // Verificar si hay un archivo de imagen seleccionado
        const archivoImagen = document.getElementById('producto_imagen_file').files[0];
        const urlImagen = document.getElementById('producto_imagen').value.trim();
        
        // Mostrar indicador de carga
        const btn = document.getElementById('guardarProductoBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        // Si hay archivo de imagen, subirlo primero
        if (archivoImagen) {
            subirImagenYGuardarProducto(archivoImagen, nombre, productoId);
        } else {
            // Si no hay archivo, guardar directamente con URL
            guardarProductoConURL(urlImagen, productoId);
        }
    });
    
    function subirImagenYGuardarProducto(archivo, nombreProducto, productoId) {
        const formData = new FormData();
        formData.append('imagen', archivo);
        formData.append('nombre_producto', nombreProducto);
        
        fetch('/api/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Imagen subida exitosamente, ahora guardar el producto
                guardarProductoConURL(data.url_imagen, productoId);
            } else {
                throw new Error(data.error || 'Error al subir la imagen');
            }
        })
        .catch(error => {
            console.error('Error al subir imagen:', error);
            alert('Error al subir la imagen: ' + error.message);
            resetearBotonGuardar();
        });
    }
    
    function guardarProductoConURL(urlImagen, productoId) {
        const productoData = {
            nombre: document.getElementById('producto_nombre').value.trim(),
            descripcion: document.getElementById('producto_descripcion').value.trim(),
            precio: parseFloat(document.getElementById('producto_precio').value),
            stock: parseInt(document.getElementById('producto_stock').value),
            imagen: urlImagen,
            activo: document.getElementById('producto_activo').checked,
            categoria_id: document.getElementById('producto_categoria').value || null
        };
        
        const url = productoId ? `/api/producto/${productoId}` : '/api/producto';
        const method = productoId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productoData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let mensaje = '';
                if (productoId) {
                    mensaje = '‚úÖ Producto actualizado exitosamente';
                } else {
                    mensaje = '‚úÖ Producto creado exitosamente';
                }
                alert(mensaje);
                location.reload();
            } else {
                alert('‚ùå Error al guardar el producto: ' + data.error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al guardar el producto');
            resetearBotonGuardar();
        });
    }
    
    function resetearBotonGuardar() {
        const btn = document.getElementById('guardarProductoBtn');
        btn.innerHTML = '<i class="fas fa-save"></i> <span class="d-none d-sm-inline ms-1">Guardar</span>';
        btn.disabled = false;
    }
    
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagen_preview');
                const img = document.getElementById('preview_img');
                img.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    
    function editarProducto(id, nombre, descripcion, precio, stock, imagen, activo, categoria_id) {
        console.log('Editando producto ID:', id);
        
        // Verificar que el modal existe
        const modal = document.getElementById('productoModal');
        if (!modal) {
            alert('Error: Modal no encontrado. Verifica que el HTML est√© correcto.');
            return;
        }
        
        // Llenar formulario con datos del producto
        document.getElementById('producto_id').value = id || '';
        document.getElementById('producto_nombre').value = nombre || '';
        document.getElementById('producto_descripcion').value = descripcion || '';
        document.getElementById('producto_precio').value = precio || '';
        document.getElementById('producto_stock').value = stock || '';
        document.getElementById('producto_imagen').value = imagen || '';
        document.getElementById('producto_activo').checked = activo === 'true' || activo === true;
        
        // Limpiar archivo de imagen y mostrar vista previa si hay URL
        document.getElementById('producto_imagen_file').value = '';
        if (imagen) {
            const preview = document.getElementById('imagen_preview');
            const img = document.getElementById('preview_img');
            img.src = imagen;
            preview.style.display = 'block';
        } else {
            document.getElementById('imagen_preview').style.display = 'none';
        }
        
        // Establecer la categor√≠a seleccionada
        const categoriaSelect = document.getElementById('producto_categoria');
        if (categoria_id && categoria_id !== 'None' && categoria_id !== '') {
            categoriaSelect.value = categoria_id;
        } else {
            categoriaSelect.value = '';
        }
        
        // Cambiar t√≠tulo y bot√≥n
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Producto';
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Producto';
        
        // Mostrar modal
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        
        console.log('Modal abierto exitosamente para producto:', nombre, 'con categor√≠a:', categoria_id);
    }
    
    function duplicarProducto(producto) {
        // Cambiar t√≠tulo del modal
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-copy"></i> Duplicar Producto';
        
        // Llenar formulario con datos del producto (sin ID para crear nuevo)
        document.getElementById('producto_id').value = '';
        document.getElementById('producto_nombre').value = producto.nombre + ' (Copia)';
        document.getElementById('producto_descripcion').value = producto.descripcion || '';
        document.getElementById('producto_precio').value = producto.precio;
        document.getElementById('producto_stock').value = 0; // Stock en 0 para la copia
        document.getElementById('producto_imagen').value = producto.imagen || '';
        document.getElementById('producto_activo').checked = false; // Inactivo por defecto
        
        // Cambiar texto del bot√≥n
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Crear Copia';
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('productoModal'));
        modal.show();
        
        // Enfocar en el campo nombre y seleccionar todo el texto
        setTimeout(() => {
            const nombreField = document.getElementById('producto_nombre');
            nombreField.focus();
            nombreField.select();
        }, 500);
    }
    
    function toggleProductStatus(productoId, nuevoEstado) {
        const accion = nuevoEstado ? 'activar' : 'desactivar';
        const confirmacion = confirm(`¬øEst√°s seguro de que quieres ${accion} este producto?`);
        
        if (!confirmacion) return;
        
        // Mostrar indicador de carga
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        const productoData = {
            activo: nuevoEstado
        };
        
        fetch(`/api/producto/${productoId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(productoData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Actualizar la interfaz sin recargar la p√°gina
                const statusElement = document.getElementById(`status-${productoId}`);
                if (nuevoEstado) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'Activo';
                    btn.className = 'btn btn-sm btn-outline-warning ms-1';
                    btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    btn.onclick = () => toggleProductStatus(productoId, false);
                } else {
                    statusElement.className = 'badge bg-secondary';
                    statusElement.textContent = 'Inactivo';
                    btn.className = 'btn btn-sm btn-outline-success ms-1';
                    btn.innerHTML = '<i class="fas fa-eye"></i>';
                    btn.onclick = () => toggleProductStatus(productoId, true);
                }
                btn.disabled = false;
                alert(`‚úÖ Producto ${accion}do exitosamente`);
            } else {
                alert('‚ùå Error al actualizar el producto: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al actualizar el producto');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function eliminarProducto(id) {
        const confirmMessage = `¬øEst√°s seguro de que quieres eliminar este producto?

‚ö†Ô∏è IMPORTANTE:
- Si el producto tiene pedidos asociados, solo se desactivar√°
- Si no tiene pedidos, se eliminar√° permanentemente
- Esta acci√≥n no se puede deshacer

¬øContinuar?`;
        
        if (confirm(confirmMessage)) {
            // Mostrar indicador de carga
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
            btn.disabled = true;
            
            fetch(`/api/producto/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.mensaje);
                    location.reload();
                } else {
                    alert('Error al eliminar el producto: ' + data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    }
    
    // Gesti√≥n de pedidos
    function actualizarEstado(pedidoId, nuevoEstado) {
        fetch(`/api/pedido/${pedidoId}/estado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Estado actualizado exitosamente');
            } else {
                alert('Error al actualizar el estado: ' + data.error);
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar el estado');
            location.reload();
        });
    }
    
    // Variables globales para almacenar datos del pedido
    let pedidoActual = {};
    
    function verDetallePedido(id, cliente_nombre, cliente_telefono, cliente_direccion, total, estado, fecha_pedido, cliente_comentarios) {
        console.log('Viendo detalle del pedido ID:', id);
        
        // Guardar datos del pedido en variables globales
        pedidoActual = {
            id: id,
            cliente_nombre: cliente_nombre,
            cliente_telefono: cliente_telefono,
            cliente_direccion: cliente_direccion,
            total: total,
            estado: estado,
            fecha_pedido: fecha_pedido,
            cliente_comentarios: cliente_comentarios
        };
        
        let html = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Informaci√≥n del Cliente</h6>
                    <p><strong>Nombre:</strong> ${cliente_nombre || 'No especificado'}</p>
                    <p><strong>Tel√©fono:</strong> ${cliente_telefono || 'No especificado'}</p>
                    <p><strong>Direcci√≥n:</strong> ${cliente_direccion || 'No especificada'}</p>
                    ${cliente_comentarios ? `<p><strong>Comentarios:</strong> ${cliente_comentarios}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Informaci√≥n del Pedido</h6>
                    <p><strong>ID:</strong> #${id}</p>
                    <p><strong>Fecha:</strong> ${fecha_pedido}</p>
                    <p><strong>Estado:</strong> <span class="badge bg-${estado === 'pendiente' ? 'warning' : estado === 'confirmado' ? 'info' : 'success'}">${estado}</span></p>
                    <p><strong>Total:</strong> S/${total.toFixed(2)}</p>
                </div>
            </div>
            <hr>
            <h6>Productos</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Cargar los items del pedido via AJAX
        fetch(`/api/pedido/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pedido = data.pedido;
                    
                    // Agregar items del pedido
                    pedido.items.forEach(item => {
                        html += `
                            <tr>
                                <td>${item.producto ? item.producto.nombre : 'Producto eliminado'}</td>
                                <td>${item.cantidad}</td>
                                <td>S/${item.precio_unitario.toFixed(2)}</td>
                                <td>S/${(item.precio_unitario * item.cantidad).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary">
                                        <th colspan="3">Total</th>
                                        <th>S/${pedido.total.toFixed(2)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('detallePedidoContent').innerHTML = html;
                    const modal = new bootstrap.Modal(document.getElementById('detallePedidoModal'));
                    modal.show();
                } else {
                    alert('Error al cargar los detalles del pedido: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los detalles del pedido');
            });
    }
    
    function abrirWhatsAppCliente() {
        if (!pedidoActual.id) {
            alert('Error: No hay datos del pedido disponibles');
            return;
        }
        
        // Obtener los items del pedido para incluir en el mensaje
        fetch(`/api/pedido/${pedidoActual.id}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pedido = data.pedido;
                    let mensaje = '';
                    
                    // Debug: Mostrar el estado en consola
                    console.log('Estado del pedido:', pedido.estado);
                    
                    // Generar mensaje seg√∫n el estado del pedido
                    if (pedido.estado === 'entregado') {
                        mensaje = generarMensajeEntregado(pedido);
                    } else if (pedido.estado === 'confirmado') {
                        mensaje = generarMensajeConfirmado(pedido);
                    } else {
                        mensaje = generarMensajePendiente(pedido);
                    }
                    
                    // Limpiar n√∫mero de tel√©fono
                    let numeroLimpio = pedidoActual.cliente_telefono.replace(/\D/g, '');
                    if (!numeroLimpio.startsWith('51')) {
                        numeroLimpio = '51' + numeroLimpio;
                    }
                    
                    // Crear URL de WhatsApp
                    const mensajeCodificado = encodeURIComponent(mensaje);
                    const urlWhatsApp = `https://wa.me/${numeroLimpio}?text=${mensajeCodificado}`;
                    
                    // Abrir WhatsApp en nueva pesta√±a
                    window.open(urlWhatsApp, '_blank');
                    
                    // Mostrar mensaje de confirmaci√≥n
                    alert(`‚úÖ WhatsApp abierto para ${pedidoActual.cliente_nombre}\nüì± N√∫mero: ${pedidoActual.cliente_telefono}\nüìã Estado: ${pedido.estado}\n\nEl mensaje est√° pre-llenado con los datos del pedido.`);
                    
                } else {
                    alert('‚ùå Error al cargar los detalles del pedido');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå Error al cargar los detalles del pedido');
            });
    }
    
    function generarMensajeEntregado(pedido) {
        let mensaje = `üéâ *PEDIDO ENTREGADO #${pedido.id}*\n\n`;
        mensaje += `¬°Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `¬°Excelente noticia! Tu pedido ha sido *entregado exitosamente*.\n\n`;
        mensaje += `üìã *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `‚Ä¢ ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - S/${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\nüí∞ *Total pagado: S/${pedido.total.toFixed(2)}*\n`;
        mensaje += `üìç *Direcci√≥n de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `üìÖ *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n`;
        mensaje += `‚úÖ *Fecha de entrega:* ${new Date().toLocaleDateString('es-PE')}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `üí¨ *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `üéä *¬°Pedido completado exitosamente!*\n\n`;
        mensaje += `üåü *¬°Gracias por elegirnos!*\n`;
        mensaje += `Esperamos que hayas disfrutado tu pedido.\n\n`;
        mensaje += `‚≠ê *¬øTe gustar√≠a calificar nuestro servicio?*\n`;
        mensaje += `Tu opini√≥n es muy importante para nosotros.\n\n`;
        mensaje += `üîÑ *¬øQuieres hacer otro pedido?*\n`;
        mensaje += `Estamos aqu√≠ para servirte nuevamente.\n\n`;
        mensaje += `¬°Que tengas un excelente d√≠a! üòä`;
        
        return mensaje;
    }
    
    function generarMensajeConfirmado(pedido) {
        let mensaje = `‚úÖ *PEDIDO CONFIRMADO #${pedido.id}*\n\n`;
        mensaje += `¬°Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `Tu pedido ha sido *confirmado* y est√° siendo preparado.\n\n`;
        mensaje += `üìã *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `‚Ä¢ ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - S/${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\nüí∞ *Total: S/${pedido.total.toFixed(2)}*\n`;
        mensaje += `üìç *Direcci√≥n de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `üìÖ *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `üí¨ *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `üöö *Estado:* Confirmado - En preparaci√≥n\n`;
        mensaje += `‚è∞ *Tiempo estimado:* 30-45 minutos\n\n`;
        mensaje += `¬°Gracias por elegirnos! Te contactaremos cuando est√© listo para entrega. üòä`;
        
        return mensaje;
    }
    
    function generarMensajePendiente(pedido) {
        let mensaje = `üìù *PEDIDO RECIBIDO #${pedido.id}*\n\n`;
        mensaje += `¬°Hola ${pedidoActual.cliente_nombre}!\n\n`;
        mensaje += `Hemos recibido tu pedido y lo estamos procesando.\n\n`;
        mensaje += `üìã *Resumen de tu pedido:*\n`;
        
        // Agregar items del pedido
        pedido.items.forEach(item => {
            mensaje += `‚Ä¢ ${item.producto ? item.producto.nombre : 'Producto eliminado'} x${item.cantidad} - S/${(item.precio_unitario * item.cantidad).toFixed(2)}\n`;
        });
        
        mensaje += `\nüí∞ *Total: S/${pedido.total.toFixed(2)}*\n`;
        mensaje += `üìç *Direcci√≥n de entrega:* ${pedidoActual.cliente_direccion}\n`;
        mensaje += `üìÖ *Fecha del pedido:* ${pedidoActual.fecha_pedido}\n\n`;
        
        if (pedidoActual.cliente_comentarios) {
            mensaje += `üí¨ *Tus comentarios:* ${pedidoActual.cliente_comentarios}\n\n`;
        }
        
        mensaje += `‚è≥ *Estado:* Pendiente de confirmaci√≥n\n`;
        mensaje += `üìû Te contactaremos pronto para confirmar tu pedido.\n\n`;
        mensaje += `¬°Gracias por elegirnos! üòä`;
        
        return mensaje;
    }
    
    function eliminarPedido(pedidoId, clienteNombre) {
        // Confirmar eliminaci√≥n
        const confirmacion = confirm(`¬øEst√°s seguro de que quieres eliminar el pedido #${pedidoId} del cliente "${clienteNombre}"?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`);
        if (!confirmacion) return;
        
        // Mostrar loading
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        // Llamar a la API para eliminar el pedido
        fetch(`/api/pedido/${pedidoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Pedido eliminado exitosamente');
                // Recargar la p√°gina para actualizar la lista
                location.reload();
            } else {
                alert('‚ùå Error al eliminar el pedido: ' + data.error);
                // Restaurar bot√≥n
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar el pedido');
            // Restaurar bot√≥n
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // Limpiar formulario al cerrar modal
    document.getElementById('productoModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('productoForm').reset();
        document.getElementById('productoModalTitle').innerHTML = '<i class="fas fa-box"></i> Nuevo Producto';
        document.getElementById('producto_id').value = '';
        document.getElementById('producto_activo').checked = true; // Por defecto activo
        
        // Limpiar vista previa de imagen
        document.getElementById('imagen_preview').style.display = 'none';
        document.getElementById('preview_img').src = '';
        
        // Restaurar texto del bot√≥n
        document.getElementById('guardarProductoBtn').innerHTML = '<i class="fas fa-save"></i> Guardar';
    });
    
    // ===== CONFIGURACI√ìN DE LA TIENDA =====
    
    // Cargar configuraci√≥n al abrir la pesta√±a
    document.getElementById('configuracion-tab').addEventListener('click', function() {
        cargarConfiguracion();
    });
    
    // Actualizar vista previa en tiempo real
    document.getElementById('nombre_tienda').addEventListener('input', function() {
        const nombre = this.value || 'Mi Tienda Online';
        document.getElementById('preview_nombre').textContent = nombre;
    });
    
    document.getElementById('descripcion_tienda').addEventListener('input', function() {
        const descripcion = this.value || 'Descripci√≥n de la tienda';
        document.getElementById('preview_descripcion').textContent = descripcion;
    });
    
    document.getElementById('whatsapp_admin').addEventListener('input', function() {
        const whatsapp = this.value || 'Sin WhatsApp configurado';
        document.getElementById('preview_whatsapp').textContent = whatsapp;
    });
    
    // Guardar configuraci√≥n
    document.getElementById('guardarConfiguracionBtn').addEventListener('click', function() {
        guardarConfiguracion();
    });
    
    // Restaurar configuraci√≥n
    document.getElementById('restaurarConfiguracionBtn').addEventListener('click', function() {
        cargarConfiguracion();
    });
    
    function cargarConfiguracion() {
        fetch('/api/configuracion')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const config = data.configuracion;
                    document.getElementById('nombre_tienda').value = config.nombre_tienda || '';
                    document.getElementById('descripcion_tienda').value = config.descripcion_tienda || '';
                    document.getElementById('whatsapp_admin').value = config.whatsapp_admin || '';
                    document.getElementById('ultima_actualizacion').textContent = config.ultima_actualizacion || '-';
                    
                    // Actualizar vista previa
                    document.getElementById('preview_nombre').textContent = config.nombre_tienda || 'Mi Tienda Online';
                    document.getElementById('preview_descripcion').textContent = config.descripcion_tienda || 'Descripci√≥n de la tienda';
                    document.getElementById('preview_whatsapp').textContent = config.whatsapp_admin || 'Sin WhatsApp configurado';
                }
            })
            .catch(error => {
                console.error('Error al cargar configuraci√≥n:', error);
            });
    }
    
    function guardarConfiguracion() {
        const nombre = document.getElementById('nombre_tienda').value.trim();
        const descripcion = document.getElementById('descripcion_tienda').value.trim();
        const whatsapp = document.getElementById('whatsapp_admin').value.trim();
        
        if (!nombre) {
            alert('‚ö†Ô∏è El nombre de la tienda es obligatorio');
            return;
        }
        
        const btn = document.getElementById('guardarConfiguracionBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        const data = {
            nombre_tienda: nombre,
            descripcion_tienda: descripcion,
            whatsapp_admin: whatsapp
        };
        
        fetch('/api/configuracion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Configuraci√≥n guardada exitosamente');
                document.getElementById('ultima_actualizacion').textContent = data.ultima_actualizacion;
            } else {
                alert('‚ùå Error al guardar configuraci√≥n: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al guardar configuraci√≥n');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // ===== CAMBIO DE CONTRASE√ëA =====
    
    // Event listeners para cambio de contrase√±a
    document.getElementById('cambiarPasswordBtn').addEventListener('click', function() {
        cambiarPassword();
    });
    
    document.getElementById('limpiarPasswordBtn').addEventListener('click', function() {
        limpiarFormularioPassword();
    });
    
    // Validaci√≥n de contrase√±a en tiempo real
    document.getElementById('password_nueva').addEventListener('input', function() {
        validarSeguridadPassword(this.value);
    });
    
    document.getElementById('password_confirmar').addEventListener('input', function() {
        validarConfirmacionPassword();
    });
    
    function cambiarPassword() {
        const passwordActual = document.getElementById('password_actual').value.trim();
        const passwordNueva = document.getElementById('password_nueva').value.trim();
        const passwordConfirmar = document.getElementById('password_confirmar').value.trim();
        
        // Validaciones del lado del cliente
        if (!passwordActual) {
            alert('‚ö†Ô∏è La contrase√±a actual es obligatoria');
            return;
        }
        
        if (!passwordNueva) {
            alert('‚ö†Ô∏è La nueva contrase√±a es obligatoria');
            return;
        }
        
        if (passwordNueva.length < 6) {
            alert('‚ö†Ô∏è La nueva contrase√±a debe tener al menos 6 caracteres');
            return;
        }
        
        if (passwordNueva !== passwordConfirmar) {
            alert('‚ö†Ô∏è Las contrase√±as nuevas no coinciden');
            return;
        }
        
        // Confirmar cambio
        const confirmacion = confirm('¬øEst√°s seguro de que quieres cambiar tu contrase√±a?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.');
        if (!confirmacion) return;
        
        const btn = document.getElementById('cambiarPasswordBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando...';
        btn.disabled = true;
        
        const data = {
            password_actual: passwordActual,
            password_nueva: passwordNueva,
            password_confirmar: passwordConfirmar
        };
        
        fetch('/api/cambiar-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ Contrase√±a cambiada exitosamente');
                limpiarFormularioPassword();
            } else {
                alert('‚ùå Error al cambiar contrase√±a: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al cambiar contrase√±a');
        })
        .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function limpiarFormularioPassword() {
        document.getElementById('password_actual').value = '';
        document.getElementById('password_nueva').value = '';
        document.getElementById('password_confirmar').value = '';
        document.getElementById('password-strength').innerHTML = '<i class="fas fa-info-circle"></i> Ingresa una nueva contrase√±a';
        document.getElementById('password-strength').className = 'text-muted';
    }
    
    function validarSeguridadPassword(password) {
        const strengthDiv = document.getElementById('password-strength');
        let strength = 0;
        let message = '';
        let className = '';
        
        if (password.length === 0) {
            message = '<i class="fas fa-info-circle"></i> Ingresa una nueva contrase√±a';
            className = 'text-muted';
        } else if (password.length < 6) {
            message = '<i class="fas fa-exclamation-triangle"></i> Muy d√©bil (m√≠nimo 6 caracteres)';
            className = 'text-danger';
        } else {
            strength = 1;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            switch (strength) {
                case 1:
                    message = '<i class="fas fa-exclamation-triangle"></i> D√©bil';
                    className = 'text-warning';
                    break;
                case 2:
                    message = '<i class="fas fa-shield-alt"></i> Regular';
                    className = 'text-info';
                    break;
                case 3:
                    message = '<i class="fas fa-shield-alt"></i> Buena';
                    className = 'text-primary';
                    break;
                case 4:
                case 5:
                    message = '<i class="fas fa-shield-alt"></i> Muy fuerte';
                    className = 'text-success';
                    break;
            }
        }
        
        strengthDiv.innerHTML = message;
        strengthDiv.className = className;
    }
    
    function validarConfirmacionPassword() {
        const passwordNueva = document.getElementById('password_nueva').value;
        const passwordConfirmar = document.getElementById('password_confirmar').value;
        
        if (passwordConfirmar.length > 0) {
            if (passwordNueva === passwordConfirmar) {
                document.getElementById('password_confirmar').className = 'form-control is-valid';
            } else {
                document.getElementById('password_confirmar').className = 'form-control is-invalid';
            }
        } else {
            document.getElementById('password_confirmar').className = 'form-control';
        }
    }
    
    // ===== ACTUALIZACI√ìN R√ÅPIDA DE ESTADO DE PEDIDOS =====
    
    function actualizarEstado(pedidoId, nuevoEstado) {
        // Actualizar la interfaz inmediatamente (optimistic update)
        actualizarInterfazEstado(pedidoId, nuevoEstado);
        
        // Enviar la petici√≥n al servidor en segundo plano
        fetch(`/api/pedido/${pedidoId}/estado`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // Si hay error, revertir el cambio
                console.error('Error al actualizar estado:', data.error);
                // Aqu√≠ podr√≠as revertir el cambio o mostrar un mensaje de error
                alert('Error al actualizar el estado del pedido: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // En caso de error de red, tambi√©n podr√≠as revertir el cambio
            alert('Error de conexi√≥n al actualizar el estado');
        });
    }
    
    function actualizarInterfazEstado(pedidoId, nuevoEstado) {
        // Buscar la tarjeta del pedido
        const card = document.querySelector(`[data-pedido-id="${pedidoId}"]`);
        if (!card) return;
        
        // Actualizar el badge de estado
        const badge = card.querySelector('.badge');
        if (badge) {
            badge.className = 'badge';
            badge.textContent = nuevoEstado.charAt(0).toUpperCase() + nuevoEstado.slice(1);
            
            // Aplicar color seg√∫n el estado
            switch (nuevoEstado) {
                case 'pendiente':
                    badge.classList.add('bg-warning');
                    break;
                case 'confirmado':
                    badge.classList.add('bg-info');
                    break;
                case 'entregado':
                    badge.classList.add('bg-success');
                    break;
                default:
                    badge.classList.add('bg-secondary');
            }
        }
        
        // Actualizar el select para que mantenga el valor seleccionado
        const select = card.querySelector('select');
        if (select) {
            select.value = nuevoEstado;
        }
    }
    
    // ===== ACTUALIZAR PANEL DEL ADMINISTRADOR =====
    
    document.getElementById('actualizarPanelBtn').addEventListener('click', function() {
        actualizarPanel();
    });
    
    function actualizarPanel() {
        const btn = document.getElementById('actualizarPanelBtn');
        const originalHTML = btn.innerHTML;
        
        // Mostrar indicador de carga
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
        btn.disabled = true;
        
        // Simular un peque√±o delay para mostrar la animaci√≥n
        setTimeout(() => {
            // Recargar la p√°gina para obtener datos actualizados
            window.location.reload();
        }, 500);
    }
    
    // ===== GESTI√ìN DE CATEGOR√çAS =====
    
    // Event listeners para el modal de categor√≠as
    document.getElementById('guardarCategoriaBtn').addEventListener('click', function() {
        guardarCategoria();
    });
    
    // Vista previa en tiempo real
    document.getElementById('categoria_nombre').addEventListener('input', function() {
        const nombre = this.value || 'Nombre de la categor√≠a';
        document.getElementById('preview_nombre').textContent = nombre;
    });
    
    document.getElementById('categoria_icono').addEventListener('change', function() {
        const icono = this.value;
        const previewIcono = document.getElementById('preview_icono');
        previewIcono.className = icono + ' me-2';
    });
    
    document.getElementById('categoria_color').addEventListener('input', function() {
        const color = this.value;
        document.getElementById('preview_icono').style.color = color;
        document.getElementById('preview_badge').style.backgroundColor = color;
    });
    
    function nuevaCategoria() {
        // Limpiar formulario
        document.getElementById('categoriaForm').reset();
        document.getElementById('categoria_id').value = '';
        document.getElementById('categoria_activa').checked = true;
        
        // Actualizar t√≠tulo del modal
        document.getElementById('categoriaModalTitle').innerHTML = '<i class="fas fa-tag"></i> Nueva Categor√≠a';
        document.getElementById('guardarCategoriaBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Categor√≠a';
        
        // Actualizar vista previa
        actualizarVistaPreviaCategoria();
    }
    
    function editarCategoria(id, nombre, descripcion, icono, color, activa) {
        // Llenar formulario con datos de la categor√≠a
        document.getElementById('categoria_id').value = id;
        document.getElementById('categoria_nombre').value = nombre;
        document.getElementById('categoria_descripcion').value = descripcion || '';
        document.getElementById('categoria_icono').value = icono;
        document.getElementById('categoria_color').value = color;
        document.getElementById('categoria_activa').checked = activa;
        
        // Actualizar t√≠tulo del modal
        document.getElementById('categoriaModalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Categor√≠a';
        document.getElementById('guardarCategoriaBtn').innerHTML = '<i class="fas fa-save"></i> Actualizar Categor√≠a';
        
        // Actualizar vista previa
        actualizarVistaPreviaCategoria();
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('categoriaModal'));
        modal.show();
    }
    
    function actualizarVistaPreviaCategoria() {
        const nombre = document.getElementById('categoria_nombre').value || 'Nombre de la categor√≠a';
        const icono = document.getElementById('categoria_icono').value;
        const color = document.getElementById('categoria_color').value;
        
        document.getElementById('preview_nombre').textContent = nombre;
        document.getElementById('preview_icono').className = icono + ' me-2';
        document.getElementById('preview_icono').style.color = color;
        document.getElementById('preview_badge').style.backgroundColor = color;
    }
    
    function guardarCategoria() {
        const categoriaId = document.getElementById('categoria_id').value;
        const nombre = document.getElementById('categoria_nombre').value.trim();
        const descripcion = document.getElementById('categoria_descripcion').value.trim();
        const icono = document.getElementById('categoria_icono').value;
        const color = document.getElementById('categoria_color').value;
        const activa = document.getElementById('categoria_activa').checked;
        
        // Validaciones
        if (!nombre) {
            alert('‚ö†Ô∏è El nombre de la categor√≠a es obligatorio');
            return;
        }
        
        const btn = document.getElementById('guardarCategoriaBtn');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        
        const data = {
            nombre: nombre,
            descripcion: descripcion,
            icono: icono,
            color: color,
            activa: activa
        };
        
        const url = categoriaId ? `/api/categoria/${categoriaId}` : '/api/categoria';
        const method = categoriaId ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.mensaje);
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('categoriaModal'));
                modal.hide();
                // Recargar p√°gina para mostrar cambios
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al guardar la categor√≠a');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    function eliminarCategoria(categoriaId, nombre) {
        const confirmacion = confirm(`¬øEst√°s seguro de que quieres eliminar la categor√≠a "${nombre}"?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`);
        if (!confirmacion) return;
        
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        fetch(`/api/categoria/${categoriaId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.mensaje);
                location.reload();
            } else {
                alert('‚ùå Error: ' + data.error);
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error al eliminar la categor√≠a');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
    
    // ===== SISTEMA RESPONSIVO =====
    
    // Sincronizar tabs m√≥viles y de escritorio
    function sincronizarTabs() {
        // Event listeners para tabs de escritorio
        document.querySelectorAll('#adminTabs .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                const targetId = e.target.getAttribute('data-bs-target');
                // Activar el tab m√≥vil correspondiente
                const mobileTab = document.querySelector(`#${e.target.id}-mobile`);
                if (mobileTab) {
                    mobileTab.classList.add('active');
                    // Remover active de otros tabs m√≥viles
                    document.querySelectorAll('#mobileMenu .btn').forEach(btn => {
                        if (btn !== mobileTab) btn.classList.remove('active');
                    });
                }
            });
        });
        
        // Event listeners para tabs m√≥viles
        document.querySelectorAll('#mobileMenu .btn').forEach(tab => {
            tab.addEventListener('click', function(e) {
                const targetId = e.target.getAttribute('data-bs-target');
                // Activar el tab de escritorio correspondiente
                const desktopTab = document.querySelector(`#${e.target.id.replace('-mobile', '')}`);
                if (desktopTab) {
                    desktopTab.click();
                }
                // Cerrar men√∫ m√≥vil despu√©s de seleccionar
                const mobileMenu = document.getElementById('mobileMenu');
                if (mobileMenu) {
                    const bsCollapse = new bootstrap.Collapse(mobileMenu, {toggle: false});
                    bsCollapse.hide();
                }
            });
        });
    }
    
    // Mejorar experiencia t√°ctil
    function mejorarExperienciaTactil() {
        // Aumentar √°rea de toque para botones peque√±os
        document.querySelectorAll('.btn-sm').forEach(btn => {
            btn.style.minHeight = '44px'; // Tama√±o m√≠nimo recomendado para touch
        });
        
        // Mejorar selectores
        document.querySelectorAll('.form-select').forEach(select => {
            select.style.minHeight = '44px';
        });
        
        // Mejorar inputs
        document.querySelectorAll('.form-control').forEach(input => {
            input.style.minHeight = '44px';
        });
    }
    
    // ===== SISTEMA DE NOTIFICACIONES =====
    
    let notificacionesActivas = true;
    let ultimoContadorPedidos = 0;
    let intervaloNotificaciones = null;
    
    // Funci√≥n para cambiar de tab
    function cambiarTab(tabName) {
        const tabButton = document.querySelector(`#${tabName}-tab`);
        if (tabButton) {
            tabButton.click();
        }
    }
    
    // Funci√≥n para ocultar notificaci√≥n
    function ocultarNotificacion() {
        const alert = document.getElementById('pedidosAlert');
        alert.classList.add('d-none');
    }
    
    // Funci√≥n para reproducir sonido de notificaci√≥n
    function reproducirSonidoNotificacion() {
        if (!notificacionesActivas) return;
        
        try {
            // Crear un sonido de notificaci√≥n m√°s audible y llamativo
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Crear m√∫ltiples tonos para un sonido m√°s llamativo
            const tonos = [
                { frecuencia: 800, duracion: 0.2 },
                { frecuencia: 1000, duracion: 0.2 },
                { frecuencia: 1200, duracion: 0.3 }
            ];
            
            let tiempoInicio = audioContext.currentTime;
            
            tonos.forEach((tono, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(tono.frecuencia, tiempoInicio);
                
                // Volumen m√°s alto para ser m√°s audible
                gainNode.gain.setValueAtTime(0.5, tiempoInicio);
                gainNode.gain.exponentialRampToValueAtTime(0.01, tiempoInicio + tono.duracion);
                
                oscillator.start(tiempoInicio);
                oscillator.stop(tiempoInicio + tono.duracion);
                
                // Pausa entre tonos
                tiempoInicio += tono.duracion + 0.1;
            });
            
            console.log('üîî Sonido de notificaci√≥n reproducido');
        } catch (error) {
            console.log('No se pudo reproducir el sonido de notificaci√≥n:', error);
            
            // Fallback: usar el sonido del sistema si est√° disponible
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.volume = 0.7;
                audio.play().catch(e => console.log('No se pudo reproducir audio de fallback:', e));
            } catch (fallbackError) {
                console.log('No se pudo usar el fallback de audio:', fallbackError);
            }
        }
    }
    
    // Variables para detectar visibilidad de la p√°gina
    let paginaVisible = true;
    let ultimaVerificacion = Date.now();
    
    // Detectar cuando la p√°gina est√° visible o en segundo plano
    document.addEventListener('visibilitychange', function() {
        paginaVisible = !document.hidden;
        if (paginaVisible) {
            console.log('üì± P√°gina visible - verificando pedidos pendientes');
            // Verificar inmediatamente cuando la p√°gina vuelve a ser visible
            actualizarNotificaciones();
        } else {
            console.log('üì± P√°gina en segundo plano - notificaciones seguir√°n funcionando');
        }
    });
    
    // Funci√≥n para actualizar notificaciones
    function actualizarNotificaciones() {
        if (!notificacionesActivas) return;
        
        fetch('/api/notificaciones/pedidos')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const totalPendientes = data.total_pendientes;
                    const pedidosBadge = document.getElementById('pedidosBadge');
                    const pedidosAlert = document.getElementById('pedidosAlert');
                    const pedidosCount = document.getElementById('pedidosCount');
                    const ultimoPedidoInfo = document.getElementById('ultimoPedidoInfo');
                    
                    // Actualizar badge del bot√≥n de pedidos (escritorio)
                    if (totalPendientes > 0) {
                        pedidosBadge.textContent = totalPendientes;
                        pedidosBadge.classList.remove('d-none');
                    } else {
                        pedidosBadge.classList.add('d-none');
                    }
                    
                    // Actualizar badge del bot√≥n de pedidos (m√≥vil)
                    const pedidosBadgeMobile = document.getElementById('pedidosBadgeMobile');
                    if (pedidosBadgeMobile) {
                        if (totalPendientes > 0) {
                            pedidosBadgeMobile.textContent = totalPendientes;
                            pedidosBadgeMobile.classList.remove('d-none');
                        } else {
                            pedidosBadgeMobile.classList.add('d-none');
                        }
                    }
                    
                    // Mostrar alerta si hay pedidos pendientes
                    if (totalPendientes > 0) {
                        pedidosCount.textContent = totalPendientes;
                        
                        // Mostrar informaci√≥n del √∫ltimo pedido
                        if (data.ultimo_pedido) {
                            const fecha = new Date(data.ultimo_pedido.fecha_pedido);
                            const hora = fecha.toLocaleTimeString('es-ES', { 
                                hour: '2-digit', 
                                minute: '2-digit',
                                hour12: true
                            });
                            ultimoPedidoInfo.textContent = `√öltimo pedido: #${data.ultimo_pedido.id} - ${data.ultimo_pedido.cliente_nombre} (${hora})`;
                        }
                        
                        pedidosAlert.classList.remove('d-none');
                        
                        // Reproducir sonido si hay nuevos pedidos
                        if (totalPendientes > ultimoContadorPedidos) {
                            console.log(`üîî Nuevo pedido detectado! Total: ${totalPendientes}, Anterior: ${ultimoContadorPedidos}`);
                            
                            // Reproducir sonido inmediatamente
                            setTimeout(() => {
                                reproducirSonidoNotificacion();
                            }, 100);
                            
                            // Mostrar notificaci√≥n del navegador si est√° disponible
                            if ('Notification' in window && Notification.permission === 'granted') {
                                // Crear notificaci√≥n m√°s detallada
                                const notificacion = new Notification('üõí Nuevo Pedido Recibido', {
                                    body: `Pedido #${data.ultimo_pedido.id} de ${data.ultimo_pedido.cliente_nombre}\nTotal: S/${data.ultimo_pedido.total}\nHaz clic para ver detalles`,
                                    icon: '/static/favicon.ico',
                                    tag: 'nuevo-pedido',
                                    requireInteraction: true, // Mantener la notificaci√≥n hasta que el usuario la cierre
                                    badge: '/static/favicon.ico'
                                });
                                
                                // Agregar evento de clic para abrir la p√°gina
                                notificacion.onclick = function() {
                                    window.focus();
                                    // Cambiar a la pesta√±a de pedidos
                                    const pedidosTab = document.getElementById('pedidos-tab');
                                    if (pedidosTab) {
                                        pedidosTab.click();
                                    }
                                    notificacion.close();
                                };
                                
                                // Cerrar autom√°ticamente despu√©s de 10 segundos
                                setTimeout(() => {
                                    notificacion.close();
                                }, 10000);
                            }
                            
                            // Hacer parpadear la pesta√±a si no est√° activa
                            if (document.hidden) {
                                document.title = 'üîî NUEVO PEDIDO - Panel Admin';
                                setTimeout(() => {
                                    document.title = 'Panel de Administraci√≥n - Mi Tienda Online';
                                }, 5000);
                            }
                        }
                    } else {
                        pedidosAlert.classList.add('d-none');
                    }
                    
                    ultimoContadorPedidos = totalPendientes;
                }
            })
            .catch(error => {
                console.error('Error al obtener notificaciones:', error);
            });
    }
    
    // Funci√≥n para activar/desactivar notificaciones
    function toggleNotificaciones() {
        notificacionesActivas = !notificacionesActivas;
        const icon = document.getElementById('notificationIcon');
        const btn = document.getElementById('toggleNotificationsBtn');
        
        if (notificacionesActivas) {
            icon.className = 'fas fa-bell';
            btn.className = 'btn btn-outline-info';
            btn.title = 'Desactivar notificaciones';
            
            // Iniciar polling
            if (!intervaloNotificaciones) {
                actualizarNotificaciones();
                intervaloNotificaciones = setInterval(actualizarNotificaciones, 10000); // Cada 10 segundos
            }
        } else {
            icon.className = 'fas fa-bell-slash';
            btn.className = 'btn btn-outline-secondary';
            btn.title = 'Activar notificaciones';
            
            // Detener polling
            if (intervaloNotificaciones) {
                clearInterval(intervaloNotificaciones);
                intervaloNotificaciones = null;
            }
        }
    }
    
    // Event listeners para notificaciones
    document.getElementById('toggleNotificationsBtn').addEventListener('click', toggleNotificaciones);
    document.getElementById('testSoundBtn').addEventListener('click', function() {
        reproducirSonidoNotificacion();
        console.log('üîä Probando sonido de notificaci√≥n...');
    });
    
    // Event listener para configurar notificaciones del navegador
    document.getElementById('configNotificationsBtn').addEventListener('click', function() {
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                alert('‚úÖ Las notificaciones del navegador ya est√°n activadas.\n\nRecibir√°s notificaciones de nuevos pedidos incluso cuando no est√©s viendo la p√°gina.');
            } else if (Notification.permission === 'denied') {
                alert('‚ùå Las notificaciones del navegador est√°n bloqueadas.\n\nPara activarlas:\n1. Haz clic en el √≠cono de candado en la barra de direcciones\n2. Selecciona "Permitir" en notificaciones\n3. Recarga la p√°gina');
            } else {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        alert('‚úÖ ¬°Notificaciones activadas!\n\nAhora recibir√°s notificaciones de nuevos pedidos incluso cuando no est√©s viendo la p√°gina.');
                        mostrarNotificacionPrueba();
                    } else {
                        alert('‚ùå Permisos de notificaci√≥n denegados.\n\nLas notificaciones del navegador no funcionar√°n.');
                    }
                });
            }
        } else {
            alert('‚ùå Tu navegador no soporta notificaciones del sistema.\n\nUsa Chrome, Firefox o Edge para una mejor experiencia.');
        }
    });
    
    // Funci√≥n para solicitar permisos de notificaci√≥n
    function solicitarPermisosNotificacion() {
        if ('Notification' in window) {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        console.log('‚úÖ Permisos de notificaci√≥n concedidos');
                        mostrarNotificacionPrueba();
                    } else {
                        console.log('‚ùå Permisos de notificaci√≥n denegados');
                    }
                });
            } else if (Notification.permission === 'granted') {
                console.log('‚úÖ Permisos de notificaci√≥n ya concedidos');
            } else {
                console.log('‚ùå Permisos de notificaci√≥n denegados');
            }
        } else {
            console.log('‚ùå Este navegador no soporta notificaciones');
        }
    }
    
    // Funci√≥n para mostrar notificaci√≥n de prueba
    function mostrarNotificacionPrueba() {
        if ('Notification' in window && Notification.permission === 'granted') {
            new Notification('üîî Notificaciones Activadas', {
                body: 'Ahora recibir√°s notificaciones de nuevos pedidos',
                icon: '/static/favicon.ico',
                tag: 'configuracion'
            });
        }
    }
    
    // Solicitar permisos autom√°ticamente al cargar la p√°gina
    solicitarPermisosNotificacion();
    
    // Inicializar notificaciones al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar funciones responsivas
        sincronizarTabs();
        mejorarExperienciaTactil();
        
        // Esperar un poco antes de iniciar las notificaciones
        setTimeout(() => {
            // Cargar el estado inicial sin reproducir sonido
            fetch('/api/notificaciones/pedidos')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        ultimoContadorPedidos = data.total_pendientes;
                        console.log(`üìä Estado inicial: ${ultimoContadorPedidos} pedidos pendientes`);
                    }
                })
                .catch(error => {
                    console.error('Error al obtener estado inicial:', error);
                });
            
            // Iniciar el polling
            if (notificacionesActivas) {
                intervaloNotificaciones = setInterval(actualizarNotificaciones, 10000); // Cada 10 segundos
            }
        }, 2000);
    });
    
    // Actualizar notificaciones cuando se cambia de tab a pedidos
    document.getElementById('pedidos-tab').addEventListener('click', function() {
        setTimeout(actualizarNotificaciones, 500);
    });
    
    // ===== FUNCIONES DE EXPORTAR/IMPORTAR PRODUCTOS =====
    
    function exportarProductos() {
        // Mostrar indicador de carga
        const btnExportar = event.target.closest('button');
        const textoOriginal = btnExportar.innerHTML;
        btnExportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exportando...';
        btnExportar.disabled = true;
        
        fetch('/api/productos/exportar')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al exportar productos');
                }
                return response.blob();
            })
            .then(blob => {
                // Crear enlace de descarga
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `productos_exportados_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                // Mostrar mensaje de √©xito
                mostrarNotificacion('‚úÖ Productos exportados exitosamente', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarNotificacion('‚ùå Error al exportar productos: ' + error.message, 'error');
            })
            .finally(() => {
                // Restaurar bot√≥n
                btnExportar.innerHTML = textoOriginal;
                btnExportar.disabled = false;
            });
    }
    
    function importarProductos(input) {
        const archivo = input.files[0];
        if (!archivo) return;
        
        // Validar tipo de archivo
        if (!archivo.name.toLowerCase().endsWith('.txt')) {
            mostrarNotificacion('‚ùå Por favor selecciona un archivo de texto (.txt)', 'error');
            input.value = '';
            return;
        }
        
        // Confirmar importaci√≥n
        const confirmacion = confirm(`¬øEst√°s seguro de que quieres importar productos desde "${archivo.name}"?\n\nEsto puede actualizar productos existentes y crear nuevos productos.`);
        if (!confirmacion) {
            input.value = '';
            return;
        }
        
        // Mostrar indicador de carga
        const btnImportar = document.querySelector('button[onclick*="importarArchivo"]');
        const textoOriginal = btnImportar.innerHTML;
        btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
        btnImportar.disabled = true;
        
        const formData = new FormData();
        formData.append('archivo', archivo);
        
        fetch('/api/productos/importar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const detalles = data.detalles;
                let mensaje = `‚úÖ Importaci√≥n completada exitosamente!\n\n`;
                mensaje += `üì¶ Productos importados: ${detalles.productos_importados}\n`;
                mensaje += `üîÑ Productos actualizados: ${detalles.productos_actualizados}\n`;
                mensaje += `üè∑Ô∏è Categor√≠as creadas: ${detalles.categorias_creadas}\n`;
                mensaje += `‚ùå Errores: ${detalles.errores}`;
                
                if (detalles.lista_errores && detalles.lista_errores.length > 0) {
                    mensaje += `\n\nErrores encontrados:\n${detalles.lista_errores.join('\n')}`;
                }
                
                mostrarNotificacion(mensaje, 'success');
                
                // Recargar la lista de productos
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                mostrarNotificacion('‚ùå Error al importar productos: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('‚ùå Error al importar productos: ' + error.message, 'error');
        })
        .finally(() => {
            // Restaurar bot√≥n y limpiar input
            btnImportar.innerHTML = textoOriginal;
            btnImportar.disabled = false;
            input.value = '';
        });
    }
    
    function mostrarNotificacion(mensaje, tipo = 'info') {
        // Crear elemento de notificaci√≥n
        const notificacion = document.createElement('div');
        notificacion.className = `alert alert-${tipo === 'error' ? 'danger' : tipo} alert-dismissible fade show position-fixed`;
        notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px; white-space: pre-line;';
        notificacion.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notificacion);
        
        // Auto-remover despu√©s de 5 segundos
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.remove();
            }
        }, 5000);
    }
</script>
{% endblock %}
