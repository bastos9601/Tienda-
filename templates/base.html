<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Mi Tienda Online{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Variables CSS dinámicas para colores personalizables */
        :root {
            --color-primario: #007bff;
            --color-secundario: #6c757d;
            --color-exito: #28a745;
            --color-peligro: #dc3545;
            --color-advertencia: #ffc107;
            --color-info: #17a2b8;
            --color-fondo: #ffffff;
            --color-texto: #333333;
            --color-fondo-secundario: #f8f9fa;
            --color-borde: #dee2e6;
        }
        
        /* Aplicar colores dinámicos a elementos principales */
        .navbar-dark.bg-primary {
            background-color: var(--color-primario) !important;
        }
        
        .btn-primary {
            background-color: var(--color-primario);
            border-color: var(--color-primario);
        }
        
        .btn-primary:hover {
            background-color: var(--color-primario);
            border-color: var(--color-primario);
            opacity: 0.9;
        }
        
        .btn-success {
            background-color: var(--color-exito);
            border-color: var(--color-exito);
        }
        
        .btn-danger {
            background-color: var(--color-peligro);
            border-color: var(--color-peligro);
        }
        
        .btn-warning {
            background-color: var(--color-advertencia);
            border-color: var(--color-advertencia);
            color: #000000;
        }
        
        .btn-info {
            background-color: var(--color-info);
            border-color: var(--color-info);
        }
        
        .text-primary {
            color: var(--color-primario) !important;
        }
        
        /* Asegurar que los iconos mantengan su apariencia correcta */
        .fas.text-primary,
        .far.text-primary,
        .fab.text-primary {
            color: var(--color-primario) !important;
            background: none !important;
        }
        
        .text-success {
            color: var(--color-exito) !important;
            background: none !important;
        }
        
        .text-danger {
            color: var(--color-peligro) !important;
            background: none !important;
        }
        
        .text-warning {
            color: var(--color-advertencia) !important;
            background: none !important;
        }
        
        .text-info {
            color: var(--color-info) !important;
            background: none !important;
        }
        
        .bg-primary {
            background-color: var(--color-primario) !important;
        }
        
        .bg-success {
            background-color: var(--color-exito) !important;
        }
        
        .bg-danger {
            background-color: var(--color-peligro) !important;
        }
        
        .bg-warning {
            background-color: var(--color-advertencia) !important;
        }
        
        .bg-info {
            background-color: var(--color-info) !important;
        }
        
        .badge.bg-success {
            background-color: var(--color-exito) !important;
        }
        
        .badge.bg-danger {
            background-color: var(--color-peligro) !important;
        }
        
        .badge.bg-warning {
            background-color: var(--color-advertencia) !important;
        }
        
        .badge.bg-info {
            background-color: var(--color-info) !important;
        }
        
        .product-card {
            transition: transform 0.3s ease;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .cart-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .cart-total {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .btn-whatsapp {
            background-color: #25D366;
            border-color: #25D366;
        }
        .btn-whatsapp:hover {
            background-color: #128C7E;
            border-color: #128C7E;
        }
        
        /* Estilos para notificaciones toast */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px 20px;
            z-index: 9999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            min-width: 250px;
        }
        
        .toast-notification.show {
            transform: translateX(0);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast-content i {
            font-size: 18px;
        }
        
        .toast-content span {
            font-weight: 500;
            color: #333;
        }
        
        /* Estilos para tarjetas de productos y pedidos */
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid #e9ecef;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        }
        
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
        }
        
        .card-footer {
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        
        .btn-group .btn {
            border-radius: 0;
        }
        
        .btn-group .btn:first-child {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }
        
        .btn-group .btn:last-child {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }
        
        /* Estilos para términos y condiciones */
        .terms-content {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .terms-content h6 {
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .terms-content h6:first-child {
            margin-top: 0;
        }
        
        .terms-content ul {
            margin-bottom: 1rem;
            padding-left: 1.2rem;
        }
        
        .terms-content li {
            margin-bottom: 0.3rem;
        }
        
        .form-check-input:checked {
            background-color: #25D366;
            border-color: #25D366;
        }
        
        .form-check-input:focus {
            border-color: #25D366;
            box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.25);
        }
        
        .form-check-label {
            font-weight: 500;
            cursor: pointer;
        }
        
        .form-check-label i {
            margin-right: 0.5rem;
        }
        
        /* Estilos para botón deshabilitado */
        #confirm-order-btn:disabled {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #confirm-order-btn:disabled:hover {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            transform: none;
        }
        
        .badge {
            font-size: 0.75em;
        }
        
        .text-success {
            color: #198754 !important;
        }
        
        .text-info {
            color: #0dcaf0 !important;
        }
        
        .text-warning {
            color: #fd7e14 !important;
        }
        
        /* Estilos para el Banner de Anuncio */
        .banner-anuncio {
            background: transparent; /* Sin fondo */
            padding: 20px 0; /* Padding vertical */
            margin-bottom: 20px;
        }
        
        /* Ocultar banner en páginas de admin */
        body.admin-page .banner-anuncio {
            display: none !important;
        }
        
        .banner-content {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            max-width: 1200px; /* Limitar el ancho máximo */
            margin: 0 auto; /* Centrar el banner */
            height: 300px;/* Sin altura fija - se adapta a la imagen */
        }
        
        .banner-content .carousel-item img {
            width: 100%;
            height: 300px; /* Altura automática según proporción de la imagen */
            display: block; /* Elimina espacios en blanco */
        }
        
        .banner-content .carousel-item {
            position: relative;
        }
        
        .banner-content .carousel-indicators {
            bottom: 10px;
        }
        
        .banner-content .carousel-indicators button {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 5px;
        }
        
        .banner-content .carousel-control-prev,
        .banner-content .carousel-control-next {
            width: 5%;
        }
        
        .banner-text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2;
        }
        
        .banner-title {
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            margin: 0;
            font-size: 2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .banner-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .banner-content {
                max-width: 100%;
                margin: 0 15px; /* Margen lateral en pantallas medianas */
            }
        }
        
        @media (max-width: 768px) {
            .banner-title {
                font-size: 1.5rem;
            }
            
            .banner-anuncio {
                padding: 15px 0; /* Padding reducido en móviles */
            }
            
            .banner-content {
                margin: 0 10px; /* Margen lateral reducido en móviles */
            }
        }
        
        @media (max-width: 480px) {
            .banner-title {
                font-size: 1.2rem;
            }
            
            .banner-anuncio {
                padding: 10px 0; /* Padding mínimo en pantallas pequeñas */
            }
            
            .banner-content {
                margin: 0 5px; /* Margen lateral mínimo */
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img id="logo-tienda" src="" alt="Logo" style="height: 30px; margin-right: 8px; display: none;">
                <i class="fas fa-store" id="icono-tienda"></i> <span id="nombre-tienda">Mi Tienda Online</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Productos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://drive.google.com/file/d/1E1NfS7DhtuR7sKFUzmhHwAtrF7ayv8o-/view?usp=sharing" target="_blank" rel="noopener noreferrer">
                            <i class="fas fa-download"></i> Descargar APK
                        </a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="/admin">Administración</a>
                    </li> -->
                </ul>
                <div class="navbar-nav">
                    {% if current_user.is_authenticated %}
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user"></i> {{ current_user.username }}
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/admin">
                                    <i class="fas fa-cogs"></i> Panel Admin
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/logout">
                                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                                </a></li>
                            </ul>
                        </div>
                    {% endif %}
                    <button class="btn btn-success text-white ms-2" data-bs-toggle="modal" data-bs-target="#cartModal" id="navbar-cart-btn" style="display: none;">
                        <i class="fas fa-shopping-cart"></i> Carrito (<span id="cart-count">0</span>)
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Carrusel de Banners -->
    <div id="banner-container" class="banner-anuncio" style="display: none;">
        <div class="container">
            <div class="banner-content">
                <div id="banner-carousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="40000">
                    <div class="carousel-inner" id="banner-carousel-inner">
                        <!-- Los banners se cargarán aquí dinámicamente -->
                    </div>
                    <!-- Indicadores del carrusel (solo si hay más de un banner) -->
                    <div class="carousel-indicators" id="banner-indicators">
                        <!-- Se generarán dinámicamente -->
                    </div>
                    <!-- Controles de navegación (solo si hay más de un banner) -->
                    <button class="carousel-control-prev" type="button" data-bs-target="#banner-carousel" data-bs-slide="prev" id="banner-prev" style="display: none;">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#banner-carousel" data-bs-slide="next" id="banner-next" style="display: none;">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <main class="container mt-4">
        <!-- Mostrar mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>

    <!-- Modal del Carrito -->
    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shopping-cart"></i> Carrito de Compras
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="cart-items">
                        <p class="text-muted">Tu carrito está vacío</p>
                    </div>
                    <div class="cart-total mt-3">
                        <div class="d-flex justify-content-between">
                            <span>Total:</span>
                            <span id="cart-total">S/0.00</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" id="clear-cart-btn" disabled>
                        <i class="fas fa-trash"></i> Limpiar Carrito
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir Comprando</button>
                    <button type="button" class="btn btn-whatsapp text-white" id="checkout-btn" disabled>
                        <i class="fab fa-whatsapp"></i> Realizar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Pedido -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-clipboard-list"></i> Información del Pedido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Información importante:</strong> Te contactaremos por WhatsApp para confirmar tu pedido y coordinar la entrega.
                    </div>
                    
                    <form id="order-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cliente_nombre" class="form-label">
                                        <i class="fas fa-user"></i> Nombre Completo *
                                    </label>
                                    <input type="text" class="form-control" id="cliente_nombre" required 
                                           placeholder="Ej: Juan Pérez">
                                    <div class="form-text">Tu nombre completo para la entrega</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cliente_telefono" class="form-label">
                                        <i class="fab fa-whatsapp"></i> WhatsApp *
                                    </label>
                                    <input type="tel" class="form-control" id="cliente_telefono" required 
                                           placeholder="Ej: +51 987 654 321">
                                    <div class="form-text">Número con código de país</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cliente_direccion" class="form-label">
                                <i class="fas fa-map-marker-alt"></i> Dirección de Entrega *
                            </label>
                            <textarea class="form-control" id="cliente_direccion" rows="3" required
                                      placeholder="Ej: Av. Principal 123, Distrito, Ciudad"></textarea>
                            <div class="form-text">Dirección completa para la entrega</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="cliente_comentarios" class="form-label">
                                <i class="fas fa-comment"></i> Comentarios Adicionales
                            </label>
                            <textarea class="form-control" id="cliente_comentarios" rows="2"
                                      placeholder="Instrucciones especiales, referencias, etc."></textarea>
                            <div class="form-text">Opcional: Instrucciones para la entrega</div>
                        </div>
                        
                        <!-- Términos y Condiciones -->
                        <div class="mb-4">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-contract me-2"></i>
                                    <div class="flex-grow-1">
                                        <strong>Términos y Condiciones</strong>
                                        <p class="mb-0 small">Al confirmar tu pedido, aceptas nuestros términos y condiciones.</p>
                                    </div>
                                    <a href="/terms" target="_blank" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        Ver términos
                                    </a>
                                </div>
                            </div>
                            
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="acepto_terminos" required>
                                <label class="form-check-label" for="acepto_terminos">
                                    <i class="fas fa-check-circle text-success"></i>
                                    <strong>Acepto los términos y condiciones</strong> *
                                </label>
                                <div class="form-text">Debes aceptar los términos para continuar con tu pedido</div>
                            </div>
                        </div>
                        
                        <!-- Resumen del pedido -->
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-shopping-cart"></i> Resumen del Pedido
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="order-summary">
                                    <!-- Se llenará dinámicamente -->
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <strong>Total:</strong>
                                    <strong id="order-total">S/0.00</strong>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-whatsapp text-white" id="confirm-order-btn" disabled>
                        <i class="fab fa-whatsapp"></i> Confirmar Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Carrito de compras
        let cart = [];
        
        // Función para habilitar/deshabilitar botón de confirmar pedido
        function toggleConfirmButton() {
            const aceptoTerminos = document.getElementById('acepto_terminos');
            const confirmBtn = document.getElementById('confirm-order-btn');
            
            if (aceptoTerminos && confirmBtn) {
                if (aceptoTerminos.checked) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('btn-secondary');
                    confirmBtn.classList.add('btn-whatsapp');
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.classList.remove('btn-whatsapp');
                    confirmBtn.classList.add('btn-secondary');
                }
            }
        }
        
        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');
            const cartTotal = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const cartFloatCount = document.getElementById('cart-float-count');
            const cartFloatBtn = document.getElementById('cart-float-btn');
            const navbarCartBtn = document.getElementById('navbar-cart-btn');
            
            if (cart.length === 0) {
            cartItems.innerHTML = '<p class="text-muted">Tu carrito está vacío</p>';
            cartCount.textContent = '0';
            cartTotal.textContent = 'S/0.00';
            checkoutBtn.disabled = true;
                
                // Ocultar botón flotante del carrito
                if (cartFloatBtn) {
                    cartFloatBtn.style.display = 'none';
                }
                
                // Ocultar botón del carrito en la barra de navegación
                if (navbarCartBtn) {
                    navbarCartBtn.style.display = 'none';
                }
            
            // Deshabilitar botón de limpiar carrito
            const clearCartBtn = document.getElementById('clear-cart-btn');
            if (clearCartBtn) {
                clearCartBtn.disabled = true;
            }
                return;
            }
            
            let total = 0;
            let html = '';
            
            cart.forEach((item, index) => {
                const itemTotal = item.precio * item.cantidad;
                total += itemTotal;
                
                html += `
                    <div class="cart-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${item.nombre}</h6>
                                <small class="text-muted">S/${item.precio.toFixed(2)} c/u</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                                <span class="mx-2">${item.cantidad}</span>
                                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
                                <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-end">
                            <strong>S/${itemTotal.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = html;
            cartCount.textContent = cart.length;
            cartTotal.textContent = `S/${total.toFixed(2)}`;
            checkoutBtn.disabled = false;
            
            // Mostrar y actualizar botón flotante del carrito
            if (cartFloatBtn && cartFloatCount) {
                cartFloatBtn.style.display = 'flex';
                cartFloatCount.textContent = cart.length;
            }
            
            // Ocultar botón del carrito en la barra de navegación (solo mostramos el flotante)
            if (navbarCartBtn) {
                navbarCartBtn.style.display = 'none';
            }
            
            // Habilitar botón de limpiar carrito
            const clearCartBtn = document.getElementById('clear-cart-btn');
            if (clearCartBtn) {
                clearCartBtn.disabled = false;
            }
        }
        
        function addToCart(id, nombre, precio, stock) {
            console.log('Agregando al carrito:', { id, nombre, precio, stock });
            
            const existingItem = cart.find(item => item.id === id);
            
            if (existingItem) {
                if (existingItem.cantidad < stock) {
                    existingItem.cantidad += 1;
                } else {
                    alert('No hay suficiente stock disponible');
                    return;
                }
            } else {
                cart.push({
                    id: id,
                    nombre: nombre,
                    precio: precio,
                    cantidad: 1
                });
            }
            
            updateCartDisplay();
            
            // Actualizar el stock mostrado en la página
            updateProductStockDisplay(id, stock - (existingItem ? existingItem.cantidad : 0));
            
            // Mostrar mensaje de confirmación
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas fa-check-circle text-success"></i>
                    <span>${nombre} agregado al carrito</span>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }
        
        function updateQuantity(index, change) {
            const item = cart[index];
            
            if (change > 0) {
                // Verificar stock disponible antes de aumentar
                fetch(`/api/producto/${item.id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.producto.stock > item.cantidad) {
                            item.cantidad += change;
                            updateCartDisplay();
                        } else {
                            alert(`No hay suficiente stock disponible. Stock actual: ${data.producto ? data.producto.stock : 0}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error al verificar stock:', error);
                        alert('Error al verificar el stock disponible');
                    });
            } else {
                // Disminuir cantidad (no necesita validación)
                item.cantidad += change;
                
                if (item.cantidad <= 0) {
                    cart.splice(index, 1);
                }
                
                updateCartDisplay();
            }
        }
        
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        }
        
        function updateProductStockDisplay(productId, newStock) {
            // Buscar el botón del producto y actualizar el stock mostrado
            const buttons = document.querySelectorAll(`button[onclick*="addToCart(${productId}"]`);
            buttons.forEach(button => {
                const card = button.closest('.card');
                if (card) {
                    const stockElement = card.querySelector('.text-success, .text-danger');
                    if (stockElement) {
                        if (newStock > 0) {
                            stockElement.className = 'text-success';
                            stockElement.innerHTML = '<i class="fas fa-check-circle"></i> Disponible';
                            button.disabled = false;
                            button.className = 'btn btn-primary w-100';
                            button.innerHTML = '<i class="fas fa-cart-plus"></i> Agregar al Carrito';
                        } else {
                            stockElement.className = 'text-danger';
                            stockElement.innerHTML = '<i class="fas fa-times-circle"></i> Sin stock';
                            button.disabled = true;
                            button.className = 'btn btn-secondary w-100';
                            button.innerHTML = '<i class="fas fa-ban"></i> Sin Stock';
                        }
                    }
                }
            });
        }
        
        // Manejo del pedido
        document.getElementById('checkout-btn').addEventListener('click', function() {
            if (cart.length === 0) return;
            
            // Actualizar resumen del pedido
            updateOrderSummary();
            
            const orderModal = new bootstrap.Modal(document.getElementById('orderModal'));
            orderModal.show();
        });
        
        // Limpiar carrito
        document.getElementById('clear-cart-btn').addEventListener('click', function() {
            if (confirm('¿Estás seguro de que quieres limpiar el carrito?')) {
                cart = [];
                updateCartDisplay();
            }
        });
        
        function updateOrderSummary() {
            const orderSummary = document.getElementById('order-summary');
            const orderTotal = document.getElementById('order-total');
            
            let html = '';
            let total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.precio * item.cantidad;
                total += itemTotal;
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="fw-bold">${item.nombre}</span>
                            <small class="text-muted d-block">S/${item.precio.toFixed(2)} c/u</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary">${item.cantidad}</span>
                            <div class="fw-bold">S/${itemTotal.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });
            
            orderSummary.innerHTML = html;
            orderTotal.textContent = `S/${total.toFixed(2)}`;
        }
        
        document.getElementById('confirm-order-btn').addEventListener('click', function() {
            // Validaciones
            const nombre = document.getElementById('cliente_nombre').value.trim();
            const telefono = document.getElementById('cliente_telefono').value.trim();
            const direccion = document.getElementById('cliente_direccion').value.trim();
            const comentarios = document.getElementById('cliente_comentarios').value.trim();
            const aceptoTerminos = document.getElementById('acepto_terminos').checked;
            
            if (!nombre) {
                alert('Por favor, ingresa tu nombre completo');
                document.getElementById('cliente_nombre').focus();
                return;
            }
            
            if (!telefono) {
                alert('Por favor, ingresa tu número de WhatsApp');
                document.getElementById('cliente_telefono').focus();
                return;
            }
            
            // Validar formato de teléfono (básico)
            const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
            if (!phoneRegex.test(telefono)) {
                alert('Por favor, ingresa un número de teléfono válido (ej: +51 987 654 321)');
                document.getElementById('cliente_telefono').focus();
                return;
            }
            
            if (!direccion) {
                alert('Por favor, ingresa tu dirección de entrega');
                document.getElementById('cliente_direccion').focus();
                return;
            }
            
            if (!aceptoTerminos) {
                alert('Debes aceptar los términos y condiciones para continuar con tu pedido');
                document.getElementById('acepto_terminos').focus();
                return;
            }
            
            if (cart.length === 0) {
                alert('Tu carrito está vacío');
                return;
            }
            
            // Mostrar indicador de carga
            const btn = document.getElementById('confirm-order-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            btn.disabled = true;
            
            const orderData = {
                cliente_nombre: nombre,
                cliente_telefono: telefono,
                cliente_direccion: direccion,
                cliente_comentarios: comentarios,
                items: cart.map(item => ({
                    producto_id: item.id,
                    cantidad: item.cantidad
                })),
                total: cart.reduce((sum, item) => sum + (item.precio * item.cantidad), 0)
            };
            
            fetch('/api/pedido', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mensaje de éxito más detallado
                    const successMessage = `¡Pedido realizado exitosamente!

📋 Número de pedido: #${data.pedido_id}
💰 Total: S/${orderData.total.toFixed(2)}
📱 Te contactaremos por WhatsApp: ${telefono}

¡Gracias por tu compra!`;
                    
                    alert(successMessage);
                    
                    // Limpiar carrito y formulario
                    cart = [];
                    updateCartDisplay();
                    document.getElementById('order-form').reset();
                    
                    // Cerrar modales
                    bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
                    bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
                    
                } else {
                    alert('Error al realizar el pedido: ' + data.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al realizar el pedido. Por favor, intenta nuevamente.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });
    </script>
    
    <!-- Cargar nombre de la tienda dinámicamente -->
    <script>
        // Cargar configuración de la tienda al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarNombreTienda();
            
            // Event listener para el checkbox de términos y condiciones
            const aceptoTerminos = document.getElementById('acepto_terminos');
            if (aceptoTerminos) {
                aceptoTerminos.addEventListener('change', toggleConfirmButton);
            }
        });
        
        function cargarNombreTienda() {
            fetch('/api/configuracion/publica')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.configuracion.nombre_tienda) {
                        document.getElementById('nombre-tienda').textContent = data.configuracion.nombre_tienda;
                        document.title = data.configuracion.nombre_tienda;
                    }
                })
                .catch(error => {
                    console.log('Usando nombre por defecto de la tienda');
                });
        }
    </script>
    
    {% block scripts %}{% endblock %}
    
    <!-- Botón de WhatsApp Flotante -->
    <div id="whatsapp-float-btn" class="whatsapp-float" style="display: none;">
        <a href="#" id="whatsapp-link" target="_blank" title="Contactar por WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </a>
    </div>
    
    <!-- Botón de Carrito Flotante -->
    <div id="cart-float-btn" class="cart-float" style="display: none;" data-bs-toggle="modal" data-bs-target="#cartModal">
        <div class="cart-float-content">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-float-count" id="cart-float-count">0</span>
        </div>
    </div>
    
    <style>
        .whatsapp-float {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 20px;
            right: 20px;
            background-color: #25d366;
            color: white;
            border-radius: 50px;
            text-align: center;
            font-size: 30px;
            box-shadow: 2px 2px 3px #999;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .whatsapp-float:hover {
            background-color: #128c7e;
            transform: scale(1.1);
        }
        
        .whatsapp-float a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .whatsapp-float i {
            line-height: 60px;
        }
        
        @media (max-width: 768px) {
            .whatsapp-float {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
                font-size: 25px;
            }
            
            .whatsapp-float i {
                line-height: 50px;
            }
        }
        
        /* Estilos para el botón flotante del carrito */
        .cart-float {
            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 20px;
            right: 90px; /* Posicionado a la izquierda del botón de WhatsApp */
            background-color: #28a745;
            color: white;
            border-radius: 50px;
            text-align: center;
            font-size: 24px;
            box-shadow: 2px 2px 3px #999;
            z-index: 1000;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cart-float:hover {
            background-color: #218838;
            transform: scale(1.1);
        }
        
        .cart-float-content {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .cart-float-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        
        @media (max-width: 768px) {
            .cart-float {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 75px;
                font-size: 20px;
            }
            
            .cart-float-count {
                width: 18px;
                height: 18px;
                font-size: 10px;
            }
        }
    </style>
    
    <script>
        // Cargar y mostrar botón de WhatsApp
        document.addEventListener('DOMContentLoaded', function() {
            cargarWhatsAppAdmin();
        });
        
        function cargarWhatsAppAdmin() {
            fetch('/api/configuracion/publica')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.configuracion.whatsapp_admin) {
                        const whatsappNumber = data.configuracion.whatsapp_admin;
                        const whatsappBtn = document.getElementById('whatsapp-float-btn');
                        const whatsappLink = document.getElementById('whatsapp-link');
                        
                        // Limpiar el número (quitar espacios, guiones, etc.)
                        const cleanNumber = whatsappNumber.replace(/[^\d+]/g, '');
                        
                        // Crear enlace de WhatsApp
                        whatsappLink.href = `https://wa.me/${cleanNumber}?text=Hola! Me interesa hacer un pedido.`;
                        
                        // Mostrar el botón
                        whatsappBtn.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.log('No se pudo cargar el WhatsApp del administrador');
                });
        }
        
        // Cargar configuración de la tienda
        function cargarConfiguracionTienda() {
            fetch('/api/configuracion/publica')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const config = data.configuracion;
                        
                        // Actualizar nombre de la tienda
                        document.getElementById('nombre-tienda').textContent = config.nombre_tienda || 'Mi Tienda Online';
                        
                        // Actualizar logo
                        const logoImg = document.getElementById('logo-tienda');
                        const iconoStore = document.getElementById('icono-tienda');
                        
                        if (config.logo_url) {
                            logoImg.src = config.logo_url;
                            logoImg.style.display = 'inline-block';
                            iconoStore.style.display = 'none';
                        } else {
                            logoImg.style.display = 'none';
                            iconoStore.style.display = 'inline-block';
                        }
                        
                        // Actualizar carrusel de banners
                        mostrarCarruselBanners(config.banners);
                    }
                })
                .catch(error => {
                    console.log('No se pudo cargar la configuración de la tienda');
                });
        }
        
        // Función para mostrar el carrusel de banners
        function mostrarCarruselBanners(banners) {
            const bannerContainer = document.getElementById('banner-container');
            const carouselInner = document.getElementById('banner-carousel-inner');
            const indicators = document.getElementById('banner-indicators');
            const prevBtn = document.getElementById('banner-prev');
            const nextBtn = document.getElementById('banner-next');
            
            // Ocultar banner si estamos en la página de admin
            if (window.location.pathname.includes('/admin')) {
                bannerContainer.style.display = 'none';
                return;
            }
            
            if (!banners || banners.length === 0) {
                bannerContainer.style.display = 'none';
                return;
            }
            
            // Limpiar contenido anterior
            carouselInner.innerHTML = '';
            indicators.innerHTML = '';
            
            // Crear elementos del carrusel
            banners.forEach((banner, index) => {
                // Crear item del carrusel
                const carouselItem = document.createElement('div');
                carouselItem.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                carouselItem.innerHTML = `
                    <img src="${banner.imagen_url}" alt="${banner.nombre}" class="d-block w-100">
                    ${banner.texto ? `
                        <div class="banner-text-overlay">
                            <h3 class="banner-title">${banner.texto}</h3>
                        </div>
                    ` : ''}
                `;
                carouselInner.appendChild(carouselItem);
                
                // Crear indicador
                const indicator = document.createElement('button');
                indicator.type = 'button';
                indicator.setAttribute('data-bs-target', '#banner-carousel');
                indicator.setAttribute('data-bs-slide-to', index);
                indicator.className = index === 0 ? 'active' : '';
                indicator.setAttribute('aria-current', index === 0 ? 'true' : 'false');
                indicator.setAttribute('aria-label', `Slide ${index + 1}`);
                indicators.appendChild(indicator);
            });
            
            // Mostrar/ocultar controles según la cantidad de banners
            if (banners.length > 1) {
                prevBtn.style.display = 'block';
                nextBtn.style.display = 'block';
                indicators.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                indicators.style.display = 'none';
            }
            
            // Mostrar el contenedor del banner
            bannerContainer.style.display = 'block';
        }
        
        // Función para aplicar colores dinámicamente
        function aplicarColoresDinamicos() {
            fetch('/api/configuracion/publica')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.configuracion.colores) {
                        const colores = data.configuracion.colores;
                        
                        // Crear variables CSS dinámicas
                        const root = document.documentElement;
                        root.style.setProperty('--color-primario', colores.color_primario);
                        root.style.setProperty('--color-secundario', colores.color_secundario);
                        root.style.setProperty('--color-exito', colores.color_exito);
                        root.style.setProperty('--color-peligro', colores.color_peligro);
                        root.style.setProperty('--color-advertencia', colores.color_advertencia);
                        root.style.setProperty('--color-info', colores.color_info);
                        root.style.setProperty('--color-fondo', colores.color_fondo);
                        root.style.setProperty('--color-texto', colores.color_texto);
                        root.style.setProperty('--color-fondo-secundario', colores.color_fondo_secundario);
                        root.style.setProperty('--color-borde', colores.color_borde);
                        
                        // Aplicar colores específicos a elementos
                        aplicarColoresElementos(colores);
                    }
                })
                .catch(error => {
                    console.log('No se pudieron cargar los colores personalizados');
                });
        }
        
        function aplicarColoresElementos(colores) {
            // Aplicar color primario a elementos específicos (excluyendo iconos)
            const elementosPrimarios = document.querySelectorAll('.btn-primary, .bg-primary, .navbar-dark.bg-primary');
            elementosPrimarios.forEach(elemento => {
                elemento.style.backgroundColor = colores.color_primario;
                elemento.style.borderColor = colores.color_primario;
                elemento.style.color = '#ffffff';
            });
            
            // Aplicar color primario solo a texto, no a iconos
            const textosPrimarios = document.querySelectorAll('.text-primary:not(.fas):not(.far):not(.fab):not(.fa)');
            textosPrimarios.forEach(elemento => {
                elemento.style.color = colores.color_primario;
            });
            
            // Aplicar color primario a iconos de forma específica
            const iconosPrimarios = document.querySelectorAll('.fas.text-primary, .far.text-primary, .fab.text-primary');
            iconosPrimarios.forEach(elemento => {
                elemento.style.color = colores.color_primario;
                elemento.style.backgroundColor = 'transparent';
            });
            
            // Aplicar color primario al botón del menú desplegable de categorías
            const dropdownToggle = document.querySelector('.category-dropdown .dropdown-toggle');
            if (dropdownToggle) {
                dropdownToggle.style.backgroundColor = colores.color_primario;
                dropdownToggle.style.borderColor = colores.color_primario;
            }
            
            // Aplicar color de fondo
            document.body.style.backgroundColor = colores.color_fondo;
            document.body.style.color = colores.color_texto;
            
            // Aplicar colores a botones de categorías
            const botonesCategoria = document.querySelectorAll('.category-btn');
            botonesCategoria.forEach(boton => {
                if (boton.classList.contains('active')) {
                    boton.style.backgroundColor = colores.color_primario;
                    boton.style.borderColor = colores.color_primario;
                    boton.style.color = '#ffffff';
                }
            });
            
            // Aplicar colores a elementos de éxito (solo botones y badges, no texto)
            const elementosExito = document.querySelectorAll('.btn-success, .bg-success, .badge.bg-success');
            elementosExito.forEach(elemento => {
                elemento.style.backgroundColor = colores.color_exito;
                elemento.style.borderColor = colores.color_exito;
                elemento.style.color = '#ffffff';
            });
            
            // Aplicar solo color de texto a elementos .text-success
            const textosExito = document.querySelectorAll('.text-success:not(.btn):not(.badge)');
            textosExito.forEach(elemento => {
                elemento.style.color = colores.color_exito;
                elemento.style.backgroundColor = 'transparent';
            });
            
            // Aplicar colores a elementos de peligro (solo botones y badges, no texto)
            const elementosPeligro = document.querySelectorAll('.btn-danger, .bg-danger, .badge.bg-danger');
            elementosPeligro.forEach(elemento => {
                elemento.style.backgroundColor = colores.color_peligro;
                elemento.style.borderColor = colores.color_peligro;
                elemento.style.color = '#ffffff';
            });
            
            // Aplicar solo color de texto a elementos .text-danger
            const textosPeligro = document.querySelectorAll('.text-danger:not(.btn):not(.badge)');
            textosPeligro.forEach(elemento => {
                elemento.style.color = colores.color_peligro;
                elemento.style.backgroundColor = 'transparent';
            });
            
            // Aplicar colores a elementos de advertencia (solo botones y badges, no texto)
            const elementosAdvertencia = document.querySelectorAll('.btn-warning, .bg-warning, .badge.bg-warning');
            elementosAdvertencia.forEach(elemento => {
                elemento.style.backgroundColor = colores.color_advertencia;
                elemento.style.borderColor = colores.color_advertencia;
                elemento.style.color = '#000000';
            });
            
            // Aplicar solo color de texto a elementos .text-warning
            const textosAdvertencia = document.querySelectorAll('.text-warning:not(.btn):not(.badge)');
            textosAdvertencia.forEach(elemento => {
                elemento.style.color = colores.color_advertencia;
                elemento.style.backgroundColor = 'transparent';
            });
        }
        
        // Cargar configuración al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarConfiguracionTienda();
            aplicarColoresDinamicos();
        });
    </script>
</body>
</html>
